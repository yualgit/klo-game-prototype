---
phase: 08-advanced-level-mechanics
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/scenes/Game.ts
  - src/scenes/Boot.ts
  - src/scenes/LevelSelect.ts
  - data/levels/level_006.json
  - data/levels/level_007.json
  - data/levels/level_008.json
  - data/levels/level_009.json
  - data/levels/level_010.json
autonomous: true

must_haves:
  truths:
    - "Game scene initializes cell_map from level JSON and passes to engine"
    - "Game scene applies pre_placed_tiles after grid generation"
    - "Inactive cells are not rendered (no TileSprite created, no interaction)"
    - "Grid background only drawn behind active cells"
    - "L6-L10 levels load and play correctly with variable boards, 3-state obstacles, and pre-placed boosters"
    - "LevelSelect shows 10 levels with names and correct checkpoint positions"
    - "MAX_LEVELS updated from 5 to 10"
    - "Boot.ts loads all 10 level JSONs"
  artifacts:
    - path: "src/scenes/Game.ts"
      provides: "Cell map initialization, pre-placed tiles, inactive cell rendering skip"
      contains: "setCellMap"
    - path: "src/scenes/Boot.ts"
      provides: "Loading of level_006 through level_010"
      contains: "level_006"
    - path: "src/scenes/LevelSelect.ts"
      provides: "10 level nodes with names and checkpoint positions"
      contains: "level_010"
    - path: "data/levels/level_006.json"
      provides: "Diamond board + 3-layer ice level"
      contains: "cell_map"
    - path: "data/levels/level_007.json"
      provides: "Narrow board + 3-layer grass level"
      contains: "grass"
    - path: "data/levels/level_008.json"
      provides: "Irregular board + pre-placed boosters level"
      contains: "pre_placed_tiles"
    - path: "data/levels/level_009.json"
      provides: "Complex multi-obstacle level"
      contains: "cell_map"
    - path: "data/levels/level_010.json"
      provides: "Challenge level combining all mechanics"
      contains: "cell_map"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "src/game/Match3Engine.ts"
      via: "engine.setCellMap() call after generateGrid"
      pattern: "setCellMap"
    - from: "src/scenes/Game.ts"
      to: "src/game/types.ts"
      via: "imports PrePlacedTile type"
      pattern: "PrePlacedTile"
    - from: "src/scenes/Boot.ts"
      to: "data/levels/"
      via: "load.json calls for level_006..010"
      pattern: "level_006"
    - from: "src/scenes/LevelSelect.ts"
      to: "src/scenes/Game.ts"
      via: "scene.start('Game', { levelId })"
      pattern: "levelId"
---

<objective>
Wire cell_map and pre-placed tiles into the Game scene, create 5 new levels (L6-L10) showcasing variable boards and advanced obstacles, and expand LevelSelect/Boot to support 10 levels.

Purpose: This connects the engine work from Plan 01 to the rendering layer and creates the actual level content that demonstrates all Phase 8 mechanics to the user.

Output: Game.ts handles variable boards and pre-placed tiles. Five new level JSON files. Boot loads all 10 levels. LevelSelect shows 10 level nodes. MAX_LEVELS = 10.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/agents/gsd-executor.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-level-mechanics/08-RESEARCH.md
@.planning/phases/08-advanced-level-mechanics/08-01-SUMMARY.md
@src/scenes/Game.ts
@src/scenes/Boot.ts
@src/scenes/LevelSelect.ts
@src/game/types.ts
@src/game/Match3Engine.ts
@data/levels/level_001.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire cell_map and pre-placed tiles into Game scene</name>
  <files>src/scenes/Game.ts</files>
  <action>
  Modify `src/scenes/Game.ts` to support variable board shapes and pre-placed tiles:

  1. **Update grid size from constants to level data:**
     - Read `GRID_WIDTH` and `GRID_HEIGHT` from `this.levelData.grid.width` and `this.levelData.grid.height` instead of using hardcoded constants. Store as instance properties `this.gridWidth` and `this.gridHeight`.
     - Replace all uses of `GRID_WIDTH` and `GRID_HEIGHT` constants in the scene with `this.gridWidth` and `this.gridHeight` (grid offset calculation, grid background, tile creation loops, input handling bounds, cascade VFX positioning, booster VFX line lengths).

  2. **Cell map initialization** (in `create()`, after `engine.generateGrid(spawnRules)` and before `engine.initializeObstacles()`):
     ```
     if (this.levelData.grid.cell_map) {
       this.engine.setCellMap(this.levelData.grid.cell_map);
     }
     ```

  3. **Pre-placed tiles** (in `create()`, after `engine.initializeObstacles()`):
     ```
     if (this.levelData.pre_placed_tiles) {
       for (const prePlaced of this.levelData.pre_placed_tiles) {
         if (this.engine.isCellActive(prePlaced.row, prePlaced.col)) {
           this.engine.setTileAt(prePlaced.row, prePlaced.col, {
             type: prePlaced.type,
             isEmpty: false,
             booster: prePlaced.booster,
             obstacle: prePlaced.obstacle,
           });
         }
       }
     }
     ```

  4. **Skip inactive cells in `createTilesFromEngine()`:**
     - Before creating a TileSprite for `[row][col]`, check `if (!this.engine.isCellActive(row, col))`:
       - Store `null` in `this.tileSprites[row][col]` for inactive cells
       - Do NOT create a TileSprite (no rendering, no interaction)
       - Continue to next cell
     - Change `tileSprites` type to `(TileSprite | null)[][]`

  5. **Skip inactive cells in `drawGridBackground()`:**
     - Instead of drawing one big rectangle, draw individual cell backgrounds only for active cells
     - Draw a rounded rect behind the entire active area, then small squares for each active cell (or draw the background per-cell with a semi-transparent white fill)
     - Simpler approach: draw the full board background as before, but also draw dark "holes" over inactive cells to mask them out. Use the scene background color (0xFFFBF0) to fill inactive cell positions.

  6. **Skip inactive cells in `syncSpritesToEngine()`:**
     - Add `if (!this.tileSprites[row][col]) continue;` at start of inner loop

  7. **Skip inactive cells in `animateMatchRemoval()`, `animateMovements()`, `animateNewTiles()`:**
     - Check `if (!this.tileSprites[tileData.row]?.[tileData.col]) continue;`

  8. **Skip inactive cells in `getTileAtPointer()`:**
     - After computing row/col, check `if (!this.engine.isCellActive(row, col)) return null;`

  9. **Skip inactive cells in `setupInput()` swipe handling:**
     - Before returning a target tile from swipe direction, verify the target cell is active: `if (!this.engine.isCellActive(targetRow, targetCol)) targetTile = null;`

  10. **Update MAX_LEVELS from 5 to 10** (line 28 in Game.ts).

  11. **Update win overlay coupon logic:**
      - The coupon currently triggers for level 5 only (`if (this.currentLevel === 5)`). Change this to `if (this.currentLevel === 10)` since level 10 is now the final challenge level.

  IMPORTANT: The `tileSprites` array must handle null entries throughout. Guard all accesses with null checks. This is the most critical integration point.
  </action>
  <verify>
  - `npx tsc --noEmit` compiles without errors
  - App runs locally (`npm run dev`) and existing L1-L5 levels still play correctly
  - No console errors related to null TileSprite access
  </verify>
  <done>Game.ts reads cell_map from level JSON, passes to engine via setCellMap(), applies pre-placed tiles, skips inactive cells in all rendering/interaction methods. MAX_LEVELS = 10. Coupon triggers on L10. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create L6-L10 level JSONs and expand Boot/LevelSelect</name>
  <files>data/levels/level_006.json, data/levels/level_007.json, data/levels/level_008.json, data/levels/level_009.json, data/levels/level_010.json, src/scenes/Boot.ts, src/scenes/LevelSelect.ts</files>
  <action>
  **Create 5 new level JSON files:**

  Each level showcases a different combination of Phase 8 mechanics. All use the same schema as L1-L5 plus optional `cell_map` and `pre_placed_tiles`.

  **Level 6 - "Діамантове поле" (Diamond Field)** — Diamond-shaped board + 3-layer ice
  ```json
  {
    "level_id": 6,
    "name": "Діамантове поле",
    "moves": 20,
    "grid": {
      "width": 8,
      "height": 8,
      "cell_map": [
        [0, 0, 0, 1, 1, 0, 0, 0],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 1, 1, 1, 1, 1, 1, 0],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [0, 1, 1, 1, 1, 1, 1, 0],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 0, 0, 1, 1, 0, 0, 0]
      ],
      "blocked_cells": []
    },
    "goals": [
      { "type": "collect", "item": "fuel", "count": 25, "current": 0, "description": "Зібрати 25 паливо" },
      { "type": "destroy_obstacle", "obstacleType": "ice", "count": 9, "current": 0, "description": "Знищити 9 шарів льоду" }
    ],
    "spawn_rules": { "fuel": 0.35, "coffee": 0.25, "snack": 0.2, "road": 0.2 },
    "obstacles": [
      { "type": "ice", "layers": 3, "positions": [[3, 3], [3, 4], [4, 3]], "description": "3-шаровий лід" }
    ],
    "difficulty": "medium",
    "target_fail_rate": 0.20
  }
  ```

  **Level 7 - "Трав'яне поле" (Grass Field)** — Hourglass-shaped board + 3-layer grass
  ```json
  {
    "level_id": 7,
    "name": "Трав'яне поле",
    "moves": 22,
    "grid": {
      "width": 8,
      "height": 8,
      "cell_map": [
        [1, 1, 1, 1, 1, 1, 1, 1],
        [0, 1, 1, 1, 1, 1, 1, 0],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 0, 0, 1, 1, 0, 0, 0],
        [0, 0, 0, 1, 1, 0, 0, 0],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 1, 1, 1, 1, 1, 1, 0],
        [1, 1, 1, 1, 1, 1, 1, 1]
      ],
      "blocked_cells": []
    },
    "goals": [
      { "type": "destroy_obstacle", "obstacleType": "grass", "count": 12, "current": 0, "description": "Знищити 12 шарів трави" },
      { "type": "collect", "item": "coffee", "count": 15, "current": 0, "description": "Зібрати 15 кава" }
    ],
    "spawn_rules": { "fuel": 0.2, "coffee": 0.35, "snack": 0.25, "road": 0.2 },
    "obstacles": [
      { "type": "grass", "layers": 3, "positions": [[0, 3], [0, 4], [7, 3], [7, 4]], "description": "3-шарова трава" }
    ],
    "difficulty": "medium",
    "target_fail_rate": 0.25
  }
  ```

  **Level 8 - "Подарунок на старті" (Gift at Start)** — Cross-shaped board + pre-placed boosters
  ```json
  {
    "level_id": 8,
    "name": "Подарунок на старті",
    "moves": 18,
    "grid": {
      "width": 8,
      "height": 8,
      "cell_map": [
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [0, 0, 1, 1, 1, 1, 0, 0],
        [0, 0, 1, 1, 1, 1, 0, 0]
      ],
      "blocked_cells": []
    },
    "goals": [
      { "type": "collect", "item": "snack", "count": 30, "current": 0, "description": "Зібрати 30 снеки" },
      { "type": "create_booster", "boosterType": "bomb", "count": 2, "current": 0, "description": "Створити 2 бомби" }
    ],
    "spawn_rules": { "fuel": 0.2, "coffee": 0.2, "snack": 0.35, "road": 0.25 },
    "obstacles": [],
    "pre_placed_tiles": [
      { "row": 3, "col": 3, "type": "fuel", "booster": "linear_horizontal" },
      { "row": 4, "col": 4, "type": "coffee", "booster": "linear_vertical" }
    ],
    "difficulty": "medium",
    "target_fail_rate": 0.20
  }
  ```

  **Level 9 - "Льодяна фортеця" (Ice Fortress)** — Wide-center board + mixed obstacles (ice + grass + crate)
  ```json
  {
    "level_id": 9,
    "name": "Льодяна фортеця",
    "moves": 25,
    "grid": {
      "width": 8,
      "height": 8,
      "cell_map": [
        [0, 1, 1, 1, 1, 1, 1, 0],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1],
        [0, 1, 1, 1, 1, 1, 1, 0]
      ],
      "blocked_cells": []
    },
    "goals": [
      { "type": "destroy_obstacle", "obstacleType": "ice", "count": 9, "current": 0, "description": "Знищити 9 шарів льоду" },
      { "type": "destroy_obstacle", "obstacleType": "grass", "count": 6, "current": 0, "description": "Знищити 6 шарів трави" }
    ],
    "spawn_rules": { "fuel": 0.25, "coffee": 0.25, "snack": 0.25, "road": 0.25 },
    "obstacles": [
      { "type": "ice", "layers": 3, "positions": [[3, 3], [3, 4], [4, 3]], "description": "3-шаровий лід у центрі" },
      { "type": "grass", "layers": 3, "positions": [[1, 1], [6, 6]], "description": "3-шарова трава по кутах" },
      { "type": "crate", "layers": 1, "positions": [[2, 5], [5, 2]], "description": "Бульбашки (1 удар)" }
    ],
    "difficulty": "hard",
    "target_fail_rate": 0.30
  }
  ```

  **Level 10 - "Фінальний виклик" (Final Challenge)** — Irregular L-shape + all mechanics combined
  ```json
  {
    "level_id": 10,
    "name": "Фінальний виклик",
    "moves": 28,
    "grid": {
      "width": 8,
      "height": 8,
      "cell_map": [
        [1, 1, 1, 1, 0, 0, 0, 0],
        [1, 1, 1, 1, 0, 0, 0, 0],
        [1, 1, 1, 1, 1, 1, 0, 0],
        [1, 1, 1, 1, 1, 1, 0, 0],
        [0, 0, 1, 1, 1, 1, 1, 1],
        [0, 0, 1, 1, 1, 1, 1, 1],
        [0, 0, 0, 0, 1, 1, 1, 1],
        [0, 0, 0, 0, 1, 1, 1, 1]
      ],
      "blocked_cells": []
    },
    "goals": [
      { "type": "collect", "item": "fuel", "count": 30, "current": 0, "description": "Зібрати 30 паливо" },
      { "type": "destroy_obstacle", "obstacleType": "ice", "count": 6, "current": 0, "description": "Знищити 6 шарів льоду" },
      { "type": "destroy_obstacle", "obstacleType": "grass", "count": 6, "current": 0, "description": "Знищити 6 шарів трави" }
    ],
    "spawn_rules": { "fuel": 0.35, "coffee": 0.25, "snack": 0.2, "road": 0.2 },
    "obstacles": [
      { "type": "ice", "layers": 3, "positions": [[1, 1], [2, 4]], "description": "3-шаровий лід" },
      { "type": "grass", "layers": 3, "positions": [[5, 5], [6, 6]], "description": "3-шарова трава" }
    ],
    "pre_placed_tiles": [
      { "row": 3, "col": 3, "type": "snack", "booster": "bomb" }
    ],
    "difficulty": "hard",
    "target_fail_rate": 0.35
  }
  ```

  **Update `src/scenes/Boot.ts`:**
  - Add 5 new level JSON loads after the existing 5:
    ```
    this.load.json('level_006', 'data/levels/level_006.json');
    this.load.json('level_007', 'data/levels/level_007.json');
    this.load.json('level_008', 'data/levels/level_008.json');
    this.load.json('level_009', 'data/levels/level_009.json');
    this.load.json('level_010', 'data/levels/level_010.json');
    ```

  **Update `src/scenes/LevelSelect.ts`:**
  - Expand `LEVEL_NAMES` record to include levels 6-10:
    ```
    6: 'Діамантове поле',
    7: 'Трав\'яне поле',
    8: 'Подарунок на старті',
    9: 'Льодяна фортеця',
    10: 'Фінальний виклик',
    ```
  - Expand `checkpoints` array from 5 to 10 positions. Add 5 more positions continuing the winding path upward. The existing 5 positions cover y from 0.78 down to 0.2. For 10 levels, redistribute vertically. Use a tighter vertical spacing or extend the path. Suggested positions for 10 nodes:
    ```
    const checkpoints = [
      { x: width * 0.25, y: height * 0.88 },
      { x: width * 0.55, y: height * 0.80 },
      { x: width * 0.30, y: height * 0.70 },
      { x: width * 0.60, y: height * 0.62 },
      { x: width * 0.35, y: height * 0.52 },
      { x: width * 0.65, y: height * 0.44 },
      { x: width * 0.30, y: height * 0.36 },
      { x: width * 0.55, y: height * 0.28 },
      { x: width * 0.35, y: height * 0.20 },
      { x: width * 0.50, y: height * 0.12 },
    ];
    ```
  - Change the level loop from `for (let i = 0; i < 5; i++)` to `for (let i = 0; i < 10; i++)`
  - Update map pointer bounds check from `currentLevelId <= 5` to `currentLevelId <= 10`
  </action>
  <verify>
  - `npx tsc --noEmit` compiles without errors
  - All 5 new JSON files exist and are valid JSON: `node -e "for(let i=6;i<=10;i++){require('./data/levels/level_'+String(i).padStart(3,'0')+'.json')}; console.log('All valid')"`
  - App runs (`npm run dev`), LevelSelect shows 10 level nodes
  - L6 loads with diamond-shaped board (inactive corners not rendered)
  - L8 loads with pre-placed boosters visible on board
  </verify>
  <done>Five new level JSONs created (L6-L10) showcasing diamond, hourglass, cross, wide-center, and L-shaped boards with 3-layer ice/grass obstacles and pre-placed boosters. Boot.ts loads all 10 levels. LevelSelect displays 10 level nodes with Ukrainian names. MAX_LEVELS = 10 in Game.ts.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- `npm run dev` launches and all 10 levels are accessible from LevelSelect
- L1-L5 play identically to before (no regressions)
- L6 has diamond-shaped board with 3-layer ice obstacles
- L7 has hourglass-shaped board with 3-layer grass obstacles
- L8 has cross-shaped board with pre-placed linear boosters
- L9 has mixed obstacles (ice + grass + crate)
- L10 has L-shaped board with all mechanics combined + pre-placed bomb
- Inactive cells show no tiles and cannot be interacted with
- 3-layer obstacles show progressive visual states (full -> cracked -> broken) on each hit
</verification>

<success_criteria>
1. User plays L6 and sees diamond-shaped board where inactive corners have no tiles
2. User matches next to 3-layer ice on L6 and sees 3 progressive visual states before clearing
3. User plays L7 and encounters 3-layer grass that requires 3 hits to clear
4. User starts L8 and sees pre-placed linear boosters on the board
5. User plays L10 with L-shaped board and all mechanics work at irregular edges
6. All 10 levels accessible from LevelSelect with correct Ukrainian names
7. L1-L5 unchanged and fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-level-mechanics/08-02-SUMMARY.md`
</output>
