---
phase: 09-kyiv-map-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scenes/LevelSelect.ts
  - src/scenes/Boot.ts
  - src/game/constants.ts
autonomous: true

must_haves:
  truths:
    - "User can drag/swipe vertically on level select and map scrolls smoothly"
    - "User sees parallax depth effect (background layers move at different speeds)"
    - "User sees 10 level nodes arranged along a winding vertical path through Kyiv landmarks"
    - "Level nodes are spaced across a tall (2000px+) scrollable map, not crammed into viewport"
  artifacts:
    - path: "src/scenes/LevelSelect.ts"
      provides: "Scrollable Kyiv map with camera bounds, drag handler, parallax layers, and winding path level nodes"
      contains: "setBounds"
    - path: "src/scenes/Boot.ts"
      provides: "Preloading of Kyiv map placeholder background images"
      contains: "kyiv"
    - path: "src/game/constants.ts"
      provides: "MAP_CONFIG constants for scroll bounds, parallax factors, and node positions"
      contains: "MAP_CONFIG"
  key_links:
    - from: "src/scenes/LevelSelect.ts"
      to: "src/game/constants.ts"
      via: "MAP_CONFIG import for map dimensions and level node positions"
      pattern: "MAP_CONFIG"
    - from: "src/scenes/LevelSelect.ts"
      to: "camera.setBounds"
      via: "Phaser camera API for scroll bounds"
      pattern: "setBounds.*MAP_HEIGHT"
---

<objective>
Transform LevelSelect from a static single-viewport screen into a vertically-scrollable Kyiv map with camera-based drag scrolling, parallax background depth, and 10 level nodes along a winding path through Kyiv landmarks.

Purpose: Establishes the scrollable map infrastructure (VISL-01), Kyiv-themed visual background (VISL-02), and winding path node layout (VISL-03) — the visual skeleton that Plan 02 wires for interaction.

Output: LevelSelect scene renders a tall scrollable map with parallax layers and level nodes positioned along a Kyiv journey path. Dragging scrolls the camera. Level nodes are visible but interaction wiring happens in Plan 02.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-kyiv-map-experience/09-RESEARCH.md
@src/scenes/LevelSelect.ts
@src/scenes/Boot.ts
@src/game/constants.ts
@src/utils/constants.ts
@src/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MAP_CONFIG constants and generate placeholder Kyiv background assets</name>
  <files>src/game/constants.ts, src/scenes/Boot.ts</files>
  <action>
1. **Add MAP_CONFIG to constants.ts:**
   Add a `MAP_CONFIG` object containing all map layout parameters:
   ```typescript
   export const MAP_CONFIG = {
     MAP_WIDTH: 1024,        // Same as game width
     MAP_HEIGHT: 2200,       // Tall enough for 10 nodes with generous spacing
     DRAG_THRESHOLD: 10,     // Pixels of movement before drag mode activates (vs tap)
     PARALLAX_SKY: 0,        // Sky layer scroll factor (static)
     PARALLAX_FAR: 0.25,     // Far landmarks scroll factor
     PARALLAX_MID: 0.6,      // Mid-ground scroll factor
     // Level node positions along winding Kyiv journey path (world coordinates)
     // Path winds left-right as it goes from bottom (node 1) to top (node 10)
     // Loosely themed: starting from Obolon (bottom) through city center to Pechersk (top)
     LEVEL_NODES: [
       { x: 260, y: 2050, label: 'Оболонь' },        // L1 - Starting point
       { x: 560, y: 1850, label: 'Поштова площа' },   // L2
       { x: 310, y: 1650, label: 'Контрактова' },     // L3
       { x: 620, y: 1450, label: 'Андріївський' },    // L4
       { x: 350, y: 1250, label: 'Золоті ворота' },   // L5
       { x: 650, y: 1050, label: 'Хрещатик' },        // L6
       { x: 300, y: 860, label: 'Майдан' },           // L7
       { x: 580, y: 660, label: 'Бессарабка' },       // L8
       { x: 370, y: 460, label: 'Палац спорту' },     // L9
       { x: 512, y: 250, label: 'Печерська Лавра' },  // L10 - Final destination
     ],
   } as const;
   ```

2. **Generate placeholder background images programmatically in Boot.ts:**
   Instead of loading external PNG files (which don't exist yet), generate placeholder gradient textures in Boot's `create()` method using Phaser's `generateTexture()` or `this.add.graphics()` + `generateTexture()`. Create 3 textures:

   - `kyiv_sky`: A gradient from light blue (#87CEEB) at top to soft white (#F0F8FF) at bottom, 1024x768 (viewport size, stays static).
   - `kyiv_far`: A 1024x2200 texture with faint silhouettes of Kyiv skyline (just draw some rectangles/triangles in gray tones to suggest distant buildings, a dome shape for Lavra). Use Graphics to draw and then `generateTexture('kyiv_far', 1024, 2200)`. Keep very simple — 5-10 building shapes in light gray (#CCCCCC, 0.3 alpha).
   - `kyiv_mid`: A 1024x2200 texture with slightly closer building shapes in medium gray. Draw simple rectangles and a few arch shapes. Use (#AAAAAA, 0.2 alpha).

   Add texture generation at the END of Boot's `create()` method, BEFORE the fade out and scene transition. Use `this.make.graphics({ add: false })` to create off-screen graphics, draw shapes, call `.generateTexture(key, w, h)`, then `.destroy()` the graphics.

   **Important:** Do NOT try to load these as external images in `preload()`. Generate them programmatically to avoid missing asset errors.
  </action>
  <verify>
   - `npm run build` compiles without errors
   - MAP_CONFIG is exported from constants.ts with all 10 LEVEL_NODES
   - Boot.ts generates kyiv_sky, kyiv_far, kyiv_mid textures in create()
  </verify>
  <done>MAP_CONFIG constants define map dimensions, parallax factors, drag threshold, and 10 Kyiv-themed level node positions. Boot scene generates 3 placeholder background textures programmatically.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor LevelSelect scene into scrollable Kyiv map with parallax and winding path</name>
  <files>src/scenes/LevelSelect.ts</files>
  <action>
**Major refactor of LevelSelect.ts.** The current scene renders all elements within a single viewport (768px tall). Transform it into a camera-scrollable map.

1. **Camera Setup:**
   - Import `MAP_CONFIG` from constants.
   - In `create()`, call `this.cameras.main.setBounds(0, 0, MAP_CONFIG.MAP_WIDTH, MAP_CONFIG.MAP_HEIGHT)` to enable vertical scrolling.
   - The camera viewport stays at game size (1024x768), but the world is now 1024x2200.

2. **Parallax Background Layers:**
   Create a `createParallaxBackground()` method that adds 3 image layers:
   - Sky layer: `this.add.image(512, 384, 'kyiv_sky').setScrollFactor(MAP_CONFIG.PARALLAX_SKY)` — static sky, centered on viewport.
   - Far layer: `this.add.image(512, MAP_CONFIG.MAP_HEIGHT / 2, 'kyiv_far').setScrollFactor(MAP_CONFIG.PARALLAX_FAR)` — distant landmarks, slow parallax.
   - Mid layer: `this.add.image(512, MAP_CONFIG.MAP_HEIGHT / 2, 'kyiv_mid').setScrollFactor(MAP_CONFIG.PARALLAX_MID)` — mid-ground buildings.

   Add these FIRST so they render behind everything else. The sky should be sized to cover viewport (set displaySize to 1024x768 if needed). The far and mid layers should cover the full map height.

3. **Drag Scroll Handler:**
   Add private properties: `isDragging: boolean = false`, `dragStartY: number = 0`.
   Create a `setupDragScrolling()` method with 3 pointer event listeners on `this.input`:

   - `pointerdown`: Set `isDragging = false`, record `dragStartY = pointer.y`.
   - `pointermove`: If `pointer.isDown`, calculate `deltaY = pointer.y - pointer.prevPosition.y`. If `Math.abs(pointer.y - dragStartY) > MAP_CONFIG.DRAG_THRESHOLD`, set `isDragging = true`. If `isDragging`, scroll camera: `this.cameras.main.scrollY -= deltaY`.
   - `pointerup`: If `!isDragging`, treat as tap (for now, just log "tap detected"). Reset `isDragging = false`.

   Call `setupDragScrolling()` at end of `create()`.

4. **Winding Path and Level Nodes (visual only):**
   Replace the old `checkpoints` array with `MAP_CONFIG.LEVEL_NODES` positions (world coordinates).

   Update `drawRoadPath()` to use the new node positions from MAP_CONFIG. Draw the winding path through all 10 nodes using the same line style (gray base + yellow overlay).

   Update the level checkpoint creation loop to use `MAP_CONFIG.LEVEL_NODES[i]` for x/y positions.

   Keep all existing checkpoint visual logic (lock overlays, stars, crowns, number text). But REMOVE the `pointerup` handler that starts levels — Plan 02 will re-add this with proper tap/drag distinction.

   Add Kyiv landmark labels next to each node: small text showing the landmark name (e.g., "Золоті ворота") below the star display. Use 14px gray text.

5. **HUD Elements Fixed to Camera:**
   The title, back button, economy HUD, and settings gear must NOT scroll with the map. They must stay pinned to the viewport.

   For each HUD element, call `.setScrollFactor(0)` to pin it to the camera viewport. This applies to:
   - Title text ("Оберіть рівень")
   - Back button container
   - Economy HUD elements (livesText, bonusText, countdownText, heart icon, bonus icon)
   - Settings gear icon

   **Important:** The back button, settings button, and economy HUD create Containers and Text objects. Call `.setScrollFactor(0)` on each individual game object AND on each Container. For Containers, also call `.setScrollFactor(0)` which pins the container and its children.

   Create a HUD background bar at the top (a semi-transparent white rectangle, scrollFactor 0, depth above parallax but below overlays) so HUD elements are readable over the map.

6. **Remove Old viewport-relative Positioning:**
   The old checkpoint positions used `height * 0.88`, etc. (viewport-relative). Replace ALL with MAP_CONFIG world positions. The map pointer (bobbing arrow) should also use MAP_CONFIG positions.

7. **Keep Existing Features Working:**
   - Economy HUD timer and display update logic: keep as-is
   - Settings overlay: keep as-is (overlays use viewport coordinates, so they already work with scrollFactor 0)
   - No-lives prompt overlay: keep as-is
   - Scene shutdown cleanup: keep as-is
  </action>
  <verify>
   - `npm run build` compiles without errors
   - Run `npm run dev` and navigate to LevelSelect: scene shows tall scrollable map
   - Dragging up/down scrolls the camera, revealing level nodes at different heights
   - Background layers move at different speeds (parallax effect visible)
   - HUD elements (title, back button, economy, settings) stay pinned at top
   - 10 level nodes visible along winding path with Kyiv landmark labels
  </verify>
  <done>LevelSelect renders as a vertically-scrollable Kyiv map with parallax backgrounds, camera drag scrolling, 10 level nodes along a winding path with landmark labels, and fixed HUD elements pinned to the camera viewport.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero TypeScript errors
2. LevelSelect scene shows a tall map (~2200px) that scrolls vertically via drag
3. Three parallax background layers are visible with different scroll speeds
4. 10 level nodes are positioned along a winding path from bottom to top
5. Each node shows its number, Kyiv landmark name, and star status
6. HUD elements (title, back button, economy display, settings gear) remain fixed at top of viewport
7. Camera cannot scroll beyond map bounds (setBounds enforces limits)
</verification>

<success_criteria>
- VISL-01 partially met: vertical drag scrolling works (tap distinction deferred to Plan 02)
- VISL-02 met: parallax Kyiv-themed background with placeholder art
- VISL-03 partially met: winding path layout established (interaction deferred to Plan 02)
- LevelSelect scrollable infrastructure complete for Plan 02 to wire interactions
</success_criteria>

<output>
After completion, create `.planning/phases/09-kyiv-map-experience/09-01-SUMMARY.md`
</output>
