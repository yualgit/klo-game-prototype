---
phase: 09-kyiv-map-experience
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/scenes/LevelSelect.ts
autonomous: false

must_haves:
  truths:
    - "User taps a level node and the level starts (tap correctly distinguished from drag)"
    - "User drags map and no level accidentally starts (drag correctly suppresses taps)"
    - "User opens level select and camera auto-scrolls to their current progress position"
    - "User with 0 lives sees refill prompt when tapping a level (economy gating preserved)"
    - "User taps back button, settings gear, or economy elements and they work correctly while map scrolls"
  artifacts:
    - path: "src/scenes/LevelSelect.ts"
      provides: "Complete interactive Kyiv map with tap/drag distinction, auto-scroll, and economy gating"
      contains: "handleTap"
  key_links:
    - from: "src/scenes/LevelSelect.ts"
      to: "isDragging flag"
      via: "pointerup handler checks isDragging before allowing level start"
      pattern: "isDragging.*handleTap"
    - from: "src/scenes/LevelSelect.ts"
      to: "camera.pan"
      via: "Auto-scroll to current level on scene create"
      pattern: "camera.*pan"
---

<objective>
Wire level node tap interaction with drag/scroll distinction, add auto-scroll to current level on scene open, and verify the complete Kyiv map experience works end-to-end.

Purpose: Completes VISL-01 (tap vs drag), VISL-03 (interactive nodes), and success criteria 4 (auto-scroll) and 5 (tap/drag distinction).

Output: Fully interactive scrollable Kyiv map where users can scroll to explore, tap nodes to start levels, and are auto-positioned to their current progress.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-kyiv-map-experience/09-RESEARCH.md
@.planning/phases/09-kyiv-map-experience/09-01-SUMMARY.md
@src/scenes/LevelSelect.ts
@src/game/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire tap/drag distinction, level node interaction, and auto-scroll to current level</name>
  <files>src/scenes/LevelSelect.ts</files>
  <action>
1. **Tap/Drag Distinction on Level Nodes:**
   The drag handler from Plan 01 already tracks `isDragging` state. Now wire level node taps:

   - Store all level node containers in a class property `levelNodes: Phaser.GameObjects.Container[] = []` (array indexed 0-9).
   - In `createLevelCheckpoint()`, push each created container to `this.levelNodes`.
   - For UNLOCKED levels, still call `container.setInteractive()` BUT do NOT add a `pointerup` handler directly on the container.
   - Instead, in the scene-level `pointerup` handler (from `setupDragScrolling`), when `isDragging` is false (tap detected):
     - Call `this.handleTap(pointer)`.
   - In `handleTap(pointer)`, convert pointer screen coordinates to world coordinates using `this.cameras.main.getWorldPoint(pointer.x, pointer.y)`.
   - Then check each level node container in `this.levelNodes` to see if the tap world position is within the container's bounds (use `Phaser.Geom.Rectangle.Contains` on each container's getBounds()).
   - If a node is hit AND the level is unlocked:
     - Check economy gating: `economy.canStartLevel()`. If false, show no-lives prompt.
     - If can start: fade out and start Game scene with levelId.
   - If no node hit, ignore the tap (it was just a tap on empty map area).

   **Why not use per-container pointerup:** Because the scene-level drag handler consumes all pointer events. We need centralized tap/drag routing to prevent level starts during drags.

   **Important:** Remove any per-container `pointerup`, `pointerdown`, `pointerover`, `pointerout` handlers from level node containers. The hover/press visual feedback should be removed for now (mobile doesn't have hover anyway). Keep the containers interactive (for hit testing) but remove event listeners.

2. **Auto-Scroll to Current Level:**
   Add a `scrollToCurrentLevel()` method called at end of `create()`:
   - Get current level from progress using `getCurrentLevel(progress)`.
   - If currentLevelId is valid (1-10), find the target node from `MAP_CONFIG.LEVEL_NODES[currentLevelId - 1]`.
   - Use `this.cameras.main.pan(targetNode.x, targetNode.y, 800, 'Sine.easeInOut', true)` to smoothly scroll to current level.
   - If the user is at level 1 (bottom of map), the camera should pan to the bottom. If at level 10 (top), pan to the top.

3. **Map Pointer (Bobbing Arrow) Update:**
   The map pointer (from `createMapPointer()`) should point at the current level's position using MAP_CONFIG world coordinates. Ensure the bobbing tween uses world Y (not viewport Y). The pointer should scroll with the map (default scrollFactor 1.0, which is already the default).

4. **Overlay Interactions Must Work:**
   The settings overlay, no-lives prompt, and back button all use `setScrollFactor(0)` (fixed to viewport). Their click handlers must work regardless of scroll position.

   - Back button: Its pointerup handler calls `scene.start('Menu')`. This should still work since the container is interactive with scrollFactor 0.
   - Settings gear: Same — scrollFactor 0, interactive, pointerup opens overlay.
   - Overlays: Settings overlay and no-lives prompt create elements at viewport center. Since they use `this.cameras.main.width/height` for positioning and all their elements should have `setScrollFactor(0)` to appear fixed over the viewport. **Add `.setScrollFactor(0)` to ALL overlay elements** in both `showSettingsOverlay()` and `showNoLivesPrompt()` methods. This includes backdrops, panels, text, buttons, and all interactive elements.

   **Critical:** The dark backdrop in overlays must block scroll dragging. When an overlay is open, the drag handler should NOT scroll the camera. Add an `overlayActive: boolean = false` flag. Set it to `true` when overlay opens, `false` when it closes. In `pointermove` handler, skip scroll logic if `overlayActive` is true. In `pointerup` handler, skip `handleTap` if `overlayActive` is true.

5. **Scene Shutdown Cleanup:**
   Add cleanup for new properties in scene shutdown handler:
   - Remove pointer event listeners (`this.input.off('pointerdown')`, etc.)
   - Clear `levelNodes` array
  </action>
  <verify>
   - `npm run build` compiles without errors
   - Run `npm run dev`, navigate to LevelSelect:
     - Dragging scrolls map without triggering level starts
     - Tapping an unlocked level starts the game (fadeOut → Game scene)
     - Tapping a locked level does nothing
     - Opening LevelSelect auto-scrolls to current progress level
     - Settings gear opens overlay, overlay blocks map scrolling
     - No-lives prompt appears when tapping with 0 lives
     - Back button returns to Menu
  </verify>
  <done>Level nodes respond to taps (not drags), camera auto-scrolls to current level on open, overlays block scroll interaction, and all existing features (economy gating, settings, navigation) work correctly in scrollable context.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Kyiv map experience</name>
  <files>src/scenes/LevelSelect.ts</files>
  <action>
    Human verification of the complete Kyiv map experience. What was built:
    - Vertical drag/swipe scrolling with parallax depth
    - 10 level nodes along winding path through Kyiv landmarks
    - Tap vs drag distinction (tapping starts level, dragging scrolls)
    - Auto-scroll to current progress level on scene open
    - Fixed HUD (title, back button, economy, settings gear)
    - All overlays (settings, no-lives) work correctly over scrollable map
  </action>
  <verify>
    1. Open `npm run dev` and navigate to level select
    2. Scroll test: Drag up/down — map should scroll smoothly with parallax layers moving at different speeds
    3. Bounds test: Try scrolling past top/bottom — camera should stop at map bounds
    4. Tap test: Tap an unlocked level — should start the game
    5. Drag-then-tap test: Start dragging, lift finger — no level should start
    6. Auto-scroll test: Complete a level, return to level select — camera should animate to your current progress
    7. HUD test: While scrolled to different positions, verify title/back button/economy/settings stay pinned at top
    8. Overlay test: Open settings while map is scrolled — overlay should appear centered in viewport, map should not scroll while overlay is open
    9. Node labels test: Each node should show its Kyiv landmark name
  </verify>
  <done>User approves the complete Kyiv map experience — scrolling, parallax, tap/drag, auto-scroll, HUD, and overlays all work correctly.</done>
</task>

</tasks>

<verification>
1. Tap on unlocked level starts Game scene — verified by playing a level after tapping
2. Dragging map does NOT accidentally start a level — verified by dragging across nodes
3. Camera auto-scrolls to current progress level on scene open
4. Settings overlay opens over map and blocks scroll interaction
5. No-lives prompt appears when tapping with 0 lives
6. Back button navigates to Menu regardless of scroll position
7. All 10 Kyiv landmark labels visible next to their nodes
8. Parallax effect visible when scrolling (3 background layers at different speeds)
</verification>

<success_criteria>
- VISL-01 fully met: vertical drag/swipe scrolling with parallax, tap/drag distinction
- VISL-02 fully met: Kyiv-themed background (placeholder art with parallax depth)
- VISL-03 fully met: 10 level nodes along winding path with Kyiv landmark names
- All 5 phase success criteria met (scroll, background, path, auto-scroll, tap/drag)
</success_criteria>

<output>
After completion, create `.planning/phases/09-kyiv-map-experience/09-02-SUMMARY.md`
</output>
