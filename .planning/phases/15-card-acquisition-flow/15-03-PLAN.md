---
phase: 15-card-acquisition-flow
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scenes/Game.ts
  - src/scenes/CardPickOverlay.ts
  - src/firebase/firestore.ts
  - src/game/CollectionsManager.ts
  - src/scenes/Collections.ts
  - src/main.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Win overlay bonus hint text 'Бонус: обери картку!' does not overlap star icons"
    - "Card name and rarity label on CardPickOverlay do not overlap each other"
    - "Collections screen shows 'x2', 'x3' etc. badge on cards owned more than once"
  artifacts:
    - path: "src/scenes/Game.ts"
      provides: "Fixed bonus hint Y positioning below stars"
      contains: "cssToGame(75)"
    - path: "src/scenes/CardPickOverlay.ts"
      provides: "Fixed rarity label Y offset with proper spacing from card name"
      contains: "cssToGame(140)"
    - path: "src/firebase/firestore.ts"
      provides: "card_counts field in CollectionProgress interface"
      contains: "card_counts"
    - path: "src/game/CollectionsManager.ts"
      provides: "getCardCount method and duplicate tracking in selectCard"
      exports: ["getCardCount"]
    - path: "src/scenes/Collections.ts"
      provides: "Duplicate count badge rendering on owned cards"
      contains: "xN"
  key_links:
    - from: "src/game/CollectionsManager.ts"
      to: "src/firebase/firestore.ts"
      via: "CollectionProgress.card_counts field"
      pattern: "card_counts"
    - from: "src/scenes/Collections.ts"
      to: "src/game/CollectionsManager.ts"
      via: "getCardCount() call for badge rendering"
      pattern: "getCardCount"
---

<objective>
Fix 3 UAT gaps from Phase 15 testing: (1) bonus hint text overlapping stars on win overlay, (2) rarity/name text overlapping on CardPickOverlay, (3) missing duplicate card count display on Collections screen.

Purpose: Close all cosmetic and minor issues identified during user acceptance testing before proceeding to Phase 16.
Output: All 3 UAT gaps resolved — text positioning fixed, duplicate count tracked and displayed.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-card-acquisition-flow/15-01-SUMMARY.md
@.planning/phases/15-card-acquisition-flow/15-02-SUMMARY.md
@.planning/phases/15-card-acquisition-flow/15-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix text overlap issues in Game.ts and CardPickOverlay.ts</name>
  <files>src/scenes/Game.ts, src/scenes/CardPickOverlay.ts</files>
  <action>
Two cosmetic text overlap fixes:

**Fix 1 — Game.ts bonus hint overlaps stars (line 374):**
In `showWinOverlay()`, the bonus hint text at `cssToGame(42)` overlaps with stars at `cssToGame(45)` for 1-2 star completions.

Change the bonus hint Y position from `cssToGame(42)` to `cssToGame(75)`. This places the hint text BELOW the stars (which are at Y=45 for 1-2 stars or Y=60 for 3 stars), giving at least 15 CSS pixels of clearance from stars at their lowest position (60).

In `src/scenes/Game.ts` line 374, change:
```
this.add.text(panelW / 2, cssToGame(42), 'Бонус: обери картку!', {
```
to:
```
this.add.text(panelW / 2, cssToGame(75), 'Бонус: обери картку!', {
```

**Fix 2 — CardPickOverlay.ts rarity label overlaps card name (line 222):**
The rarity label at `card.y + cssToGame(110)` is only ~3.5 CSS pixels below the card name at `cardHeight/2 + cssToGame(15)` (card half-height is 91.5, so name is at 106.5, rarity at 110).

Change the rarity label Y offset from `cssToGame(110)` to `cssToGame(140)`. This gives 33.5 CSS pixels between the card name and rarity label — sufficient for `fontSize: 14px` name text + comfortable gap.

In `src/scenes/CardPickOverlay.ts` line 222, change:
```
const label = this.add.text(card.x, card.y + cssToGame(110), rarityText, {
```
to:
```
const label = this.add.text(card.x, card.y + cssToGame(140), rarityText, {
```
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. Visual: bonus hint text should appear below stars, rarity label should have clear space from card name.</verify>
  <done>Bonus hint at Y=75 (below stars at 45/60), rarity label at Y=140 (well below card name at ~106.5). No text overlaps.</done>
</task>

<task type="auto">
  <name>Task 2: Add duplicate card count tracking and display</name>
  <files>src/firebase/firestore.ts, src/game/CollectionsManager.ts, src/scenes/Collections.ts, src/main.ts</files>
  <action>
Add per-card duplicate count tracking and display in Collections screen.

**Step 1 — Update data model (src/firebase/firestore.ts):**
Add `card_counts` field to `CollectionProgress` interface (after line 40):
```typescript
export interface CollectionProgress {
  owned_cards: string[];
  pity_streak: number;
  card_counts: Record<string, number>;  // Per-card acquisition count
}
```

In the default state fallbacks (line 202-204 and the loadCollections method), add `card_counts: {}` to each default CollectionProgress. Also ensure the `loadCollections` method handles existing Firestore documents that lack `card_counts` by defaulting to `{}`.

In the collectionState building section (around line 209+), when reading from Firestore data, include `card_counts: collData.card_counts || {}` for each collection.

**Step 2 — Update defaults in main.ts:**
In `src/main.ts` lines 92-94, add `card_counts: {}` to each default collection:
```typescript
coffee: { owned_cards: [], pity_streak: 0, card_counts: {} },
food: { owned_cards: [], pity_streak: 0, card_counts: {} },
car: { owned_cards: [], pity_streak: 0, card_counts: {} },
```

**Step 3 — Track counts in CollectionsManager (src/game/CollectionsManager.ts):**

Add a `getCardCount` method:
```typescript
getCardCount(collectionId: string, cardId: string): number {
  const collection = this.state.collections[collectionId];
  if (!collection?.card_counts) return 0;
  return collection.card_counts[cardId] ?? 0;
}
```

Update `selectCard()` method: After the existing `isNew` check block, ALWAYS increment the card count (for both new and duplicate cards):
```typescript
// Track card count (both new and duplicate)
if (!collection.card_counts) collection.card_counts = {};
collection.card_counts[cardId] = (collection.card_counts[cardId] ?? 0) + 1;
```

Place this BEFORE the `await this.save()` call (after the if/else isNew block, before line 142).

Also update `addCard()` method similarly — when a card is successfully added (after `collection.owned_cards.push(cardId)` on line 100):
```typescript
if (!collection.card_counts) collection.card_counts = {};
collection.card_counts[cardId] = (collection.card_counts[cardId] ?? 0) + 1;
```

**Step 4 — Render duplicate count badge (src/scenes/Collections.ts):**

In the card rendering loop (around line 145-158, inside the `if (isOwned)` block), after the existing rarity badge rendering, add a duplicate count badge:

```typescript
// Duplicate count badge
const count = collectionsManager.getCardCount(collectionId, card.id);
if (count > 1) {
  const countText = this.add.text(
    cardX + cardWidth / 2 - cssToGame(2),
    cardY - cardHeight / 2 + cssToGame(2),
    `x${count}`,
    {
      fontFamily: 'Arial, sans-serif',
      fontSize: `${cssToGame(10)}px`,
      color: '#FFFFFF',
      fontStyle: 'bold',
      backgroundColor: '#333333',
      padding: { x: cssToGame(3), y: cssToGame(1) },
    }
  );
  countText.setOrigin(1, 0); // Top-right alignment
  this.allElements.push(countText);
}
```

This places a small "x2", "x3" badge in the top-right corner of owned cards.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. Run `npx vite build` — build succeeds. Check that CollectionProgress interface includes card_counts, getCardCount is exported, selectCard increments counts, Collections scene renders xN badge.</verify>
  <done>Duplicate card count tracked in Firestore via card_counts field. Collections screen shows "x2", "x3" badge on top-right of cards owned more than once. Existing users without card_counts field get graceful default of empty object.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all TypeScript types correct
2. `npx vite build` succeeds — no build errors
3. Bonus hint text Y position is cssToGame(75), well below stars
4. Rarity label Y offset is cssToGame(140), well below card name
5. CollectionProgress interface has card_counts field
6. selectCard() increments card_counts for every card acquisition
7. Collections scene renders "xN" badge when count > 1
</verification>

<success_criteria>
All 3 UAT gaps closed:
- Bonus hint text no longer overlaps star icons on win overlay
- Rarity label no longer overlaps card name on CardPickOverlay
- Collections screen shows duplicate count badge for cards owned multiple times
</success_criteria>

<output>
After completion, create `.planning/phases/15-card-acquisition-flow/15-03-SUMMARY.md`
</output>
