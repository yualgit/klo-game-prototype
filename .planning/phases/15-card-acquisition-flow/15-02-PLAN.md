---
phase: 15-card-acquisition-flow
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/scenes/CardPickOverlay.ts
  - src/scenes/index.ts
  - src/scenes/Boot.ts
  - src/scenes/Game.ts
  - src/main.ts
autonomous: true

must_haves:
  truths:
    - "After winning a bonus level, player sees 2 closed cards side by side on dark backdrop"
    - "Player taps one card, both cards flip to reveal front textures"
    - "Picked card shows card name, other card shows what could have been"
    - "After reveal, picked card is added to collection via CollectionsManager.selectCard()"
    - "After card pick overlay closes, player returns to next level or LevelSelect"
    - "Non-bonus level wins proceed as before (no card pick overlay)"
  artifacts:
    - path: "src/scenes/CardPickOverlay.ts"
      provides: "Card pick overlay scene with flip animation"
      exports: ["CardPickOverlay"]
    - path: "src/scenes/index.ts"
      provides: "CardPickOverlay export"
      contains: "CardPickOverlay"
    - path: "src/main.ts"
      provides: "CardPickOverlay registered in Phaser scene list"
      contains: "CardPickOverlay"
  key_links:
    - from: "src/scenes/CardPickOverlay.ts"
      to: "src/game/cardDropLogic.ts"
      via: "rollCard import for card selection"
      pattern: "import.*rollCard.*from.*cardDropLogic"
    - from: "src/scenes/CardPickOverlay.ts"
      to: "src/game/CollectionsManager.ts"
      via: "registry.get('collections') for selectCard"
      pattern: "registry\\.get.*collections"
    - from: "src/scenes/Game.ts"
      to: "src/scenes/CardPickOverlay.ts"
      via: "scene.launch('CardPickOverlay') on bonus level win"
      pattern: "scene\\.launch.*CardPickOverlay"
    - from: "src/scenes/Game.ts"
      to: "src/game/collectionConfig.ts"
      via: "getActiveCollectionId import for collection rotation"
      pattern: "getActiveCollectionId"
---

<objective>
Create the CardPickOverlay scene with pick-1-of-2 card UX and flip animations, load card_back texture, register the scene, and integrate the bonus level trigger into Game.ts showWinOverlay().

Purpose: This plan delivers the visible card acquisition UX — the player-facing "pick a card" experience after winning bonus levels.
Output: CardPickOverlay.ts scene, Game.ts integration, Boot.ts card_back loading, scene registration.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-card-acquisition-flow/15-RESEARCH.md
@.planning/phases/15-card-acquisition-flow/15-01-SUMMARY.md
@src/scenes/Game.ts
@src/scenes/Boot.ts
@src/scenes/index.ts
@src/main.ts
@src/game/cardDropLogic.ts
@src/game/collectionConfig.ts
@src/game/CollectionsManager.ts
@src/utils/responsive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardPickOverlay scene with flip animation</name>
  <files>
    src/scenes/CardPickOverlay.ts
    src/scenes/Boot.ts
  </files>
  <action>
**1. Create card_back texture in Boot.ts:**

Add to Boot.ts preload() after the `collection_blank` line:
```typescript
// Card back texture for pick overlay
this.load.image('card_back', 'assets/collections/card_back.png');
```

**IMPORTANT:** The card_back.png asset may not exist yet. If it doesn't exist in `public/assets/collections/`, create a procedural card back texture at runtime in CardPickOverlay instead. Use a Graphics object with KLO-branded design (dark background with KLO yellow border and "KLO" text). This avoids a missing asset error.

**2. Create `src/scenes/CardPickOverlay.ts`** — full overlay scene:

```typescript
import Phaser from 'phaser';
import { CollectionsManager } from '../game/CollectionsManager';
import { rollCard, DROP_CONFIG } from '../game/cardDropLogic';
import { CARD_DEFINITIONS, getActiveCollectionId } from '../game/collectionConfig';
import { cssToGame, getResponsiveLayout } from '../utils/responsive';
```

Scene key: `'CardPickOverlay'`

**Constructor:** `super({ key: 'CardPickOverlay' })`

**create(data: { levelId: number }):**
1. Get viewport dimensions from `this.cameras.main`.
2. Compute responsive layout via `getResponsiveLayout(width, height)`.
3. Determine collection: `const collectionId = getActiveCollectionId(data.levelId)`.
4. Get CollectionsManager from registry: `this.registry.get('collections') as CollectionsManager`.
5. Get owned cards and pity streak from manager.
6. Roll 2 cards: `card1Id = rollCard(collectionId, owned, pity, DROP_CONFIG)`, `card2Id = rollCard(collectionId, owned, pity, DROP_CONFIG)`. Ensure card2 differs from card1 — if same, re-roll up to 5 times, then accept.
7. Create dark backdrop: `this.add.graphics()` → fillStyle(0x000000, 0.75) → fillRect full screen → setDepth(400) → make interactive to block clicks behind.
   **CRITICAL:** Make backdrop interactive with `new Phaser.Geom.Rectangle(0, 0, width, height)` hit area to block click-through (Phaser gotcha).
8. Add title text: "Обери картку!" (Choose a card!) centered at top, depth 401, KLO_WHITE color, overlayTitleSize font.
9. Create 2 card containers side by side:
   - Card width: `cssToGame(110)`, card height: `cssToGame(183)` (preserving 696:1158 portrait ratio).
   - Card spacing: `cssToGame(20)` gap between cards.
   - Center both cards at `height * 0.45` (slightly above center to leave room for button).
   - Each card container (depth 401) contains:
     a. Card back: procedural Graphics rectangle (dark bg `0x2A2A2A`, rounded corners, KLO yellow `0xFFB800` border, "KLO" text centered). Size = card width x card height.
     b. Card front: `this.add.image(0, 0, cardDef.textureKey)` → setDisplaySize matching card dimensions → setVisible(false).
     c. Card name text (hidden): card's nameUk below the card image, hidden until flip.
   - Store `cardId` in container data: `container.setData('cardId', cardId)`.
   - Make interactive with hand cursor: `container.setSize(cardW, cardH).setInteractive({ useHandCursor: true })`.
   - Add hover scale tween: pointerover → setScale(1.05), pointerout → setScale(1.0).
   - On pointerup: call `this.onCardPicked(pickedIndex)`.
   - Store cards array: `this.cards = [container1, container2]`, `this.cardIds = [card1Id, card2Id]`.

**onCardPicked(pickedIndex: number):**
1. Immediately disable input on BOTH cards: remove interactive from both containers. Set `this.input.enabled = false` to prevent double-taps.
2. Flip picked card first (delay 0), then other card (delay 300ms).
3. Flip animation per card (use `flipCard(container, delay)` method):
   a. `this.time.delayedCall(delay, ...)` wrapping the tween.
   b. Phase 1: tween container scaleX from 1 → 0 over 200ms, ease 'Quad.In'.
   c. At scaleX=0: hide back graphics, show front image + name text.
   d. Phase 2: tween container scaleX from 0 → 1 over 200ms, ease 'Quad.Out'.
   e. Return Promise that resolves when complete.
4. After both flips complete (await Promise.all):
   a. Highlight picked card: add gold border glow or slight scale-up (1.08) with tween.
   b. Dim unpicked card: setAlpha(0.5).
   c. Show "Обрано!" (Chosen!) text above picked card.
   d. Show card rarity text below each card (e.g., "Рідкісна", "Звичайна").
5. After 800ms delay, call `collections.selectCard(collectionId, pickedCardId)`.
6. Show "Далі" (Continue) button at bottom, centered. Use responsive button styling consistent with Game.ts overlays (GUI sprite background, KLO font style).
7. Button click: determine next action based on `data.levelId`:
   - If `levelId < 10` (MAX_LEVELS): `this.scene.start('Game', { levelId: data.levelId + 1 })`.
   - If `levelId >= 10`: `this.scene.start('LevelSelect')`.

**Rarity label helper:** Map CardRarity to Ukrainian:
- common → 'Звичайна'
- rare → 'Рідкісна'
- epic → 'Епічна'
- legendary → 'Легендарна'

**Rarity label color:** Same as Phase 14 badge colors: common=#888888, rare=#4488FF, epic=#AA44FF, legendary=#FFB800.

**Responsive considerations:**
- All sizes via cssToGame() for DPR awareness.
- Card positioning relative to viewport center.
- Font sizes from layout object where applicable.

**Scene lifecycle:**
- No UIScene launched (overlay is brief, no nav needed).
- No resize handler needed (overlay is short-lived, acceptable to not resize mid-animation).
- Clean shutdown: destroy all elements implicitly when scene stops.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile with no errors. Verify CardPickOverlay.ts exists and exports CardPickOverlay class with scene key 'CardPickOverlay'.
  </verify>
  <done>
CardPickOverlay scene created with: dark backdrop, 2 closed cards (procedural back), tap to pick, flip animation (scaleX tween), front reveal with card name, rarity label, "Далі" continue button. card_back loading added to Boot.ts (or procedural fallback).
  </done>
</task>

<task type="auto">
  <name>Task 2: Register CardPickOverlay scene and integrate bonus level trigger in Game.ts</name>
  <files>
    src/scenes/index.ts
    src/main.ts
    src/scenes/Game.ts
  </files>
  <action>
**1. Export CardPickOverlay from scenes barrel:**

In `src/scenes/index.ts`, add:
```typescript
export { CardPickOverlay } from './CardPickOverlay';
```

**2. Register in main.ts Phaser config:**

In `src/main.ts`, add CardPickOverlay to the imports:
```typescript
import { Boot, Menu, LevelSelect, Game, UIScene, Collections, Shop, CardPickOverlay } from './scenes';
```

And add to the scene array in config:
```typescript
scene: [Boot, Menu, LevelSelect, Game, UIScene, Collections, Shop, CardPickOverlay],
```

**3. Modify Game.ts showWinOverlay() to trigger CardPickOverlay on bonus levels:**

a. Add import at top of Game.ts:
```typescript
import { getActiveCollectionId } from '../game/collectionConfig';
```

b. In `showWinOverlay()`, after `const isLastLevel = this.currentLevel >= MAX_LEVELS;`, add:
```typescript
const isBonusLevel = this.levelData.bonus_level === true;
```

c. Modify the "Далі" button onClick handler. Currently:
```typescript
const nextBtn = this.createOverlayButton(panelW / 2, panelH - cssToGame(80), nextLabel, () => {
  if (isLastLevel) {
    this.scene.start('LevelSelect');
  } else {
    this.scene.start('Game', { levelId: this.currentLevel + 1 });
  }
});
```

Change to:
```typescript
const nextBtn = this.createOverlayButton(panelW / 2, panelH - cssToGame(80), nextLabel, () => {
  if (isBonusLevel) {
    // Launch card pick overlay — pass levelId for collection rotation and next level logic
    this.scene.start('CardPickOverlay', { levelId: this.currentLevel });
  } else if (isLastLevel) {
    this.scene.start('LevelSelect');
  } else {
    this.scene.start('Game', { levelId: this.currentLevel + 1 });
  }
});
```

**Note:** Use `scene.start()` (not `scene.launch()`) because the Game scene should stop — CardPickOverlay becomes the active scene. CardPickOverlay handles the "next level" navigation itself.

d. The "Рівні" button (secondary) should NOT change — it always goes to LevelSelect regardless of bonus level status. This gives players an escape route.

e. Add a visual hint to the win overlay title when it's a bonus level. After the title "Рівень пройдено!" text creation, add:
```typescript
if (isBonusLevel) {
  const bonusHint = this.add.text(panelW / 2, cssToGame(42), 'Бонус: обери картку!', {
    fontFamily: 'Arial, sans-serif',
    fontSize: `${this.layout.overlaySubtitleSize}px`,
    color: '#FFB800',
    fontStyle: 'bold',
  });
  bonusHint.setOrigin(0.5);
  panelContainer.add(bonusHint);
}
```
This tells the player that clicking "Далі" will lead to a card pick, not the next level directly.
  </action>
  <verify>
1. `npx tsc --noEmit` — should compile with no errors.
2. Check `src/scenes/index.ts` contains CardPickOverlay export.
3. Check `src/main.ts` scene array contains CardPickOverlay.
4. Check `src/scenes/Game.ts` showWinOverlay contains 'CardPickOverlay' string and isBonusLevel check.
5. Run `npx vite build` to verify full build succeeds.
  </verify>
  <done>
CardPickOverlay registered in Phaser scene config. Game.ts win overlay triggers CardPickOverlay on bonus levels. Non-bonus levels proceed to next level as before. Bonus level win overlay shows hint text "Бонус: обери картку!".
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vite build` succeeds
3. CardPickOverlay scene registered and accessible via scene key 'CardPickOverlay'
4. Game.ts showWinOverlay: bonus level → CardPickOverlay, non-bonus → next level/LevelSelect
5. CardPickOverlay: 2 cards displayed, tap picks one, both flip, picked card added to collection
6. CardPickOverlay: continue button navigates to next level or LevelSelect
7. Collection rotation: L3 → coffee, L6 → food, L9 → car (via getActiveCollectionId)
</verification>

<success_criteria>
- Winning bonus level (3, 6, 9) shows card pick overlay with 2 closed cards
- Picking a card flips both cards to reveal (picked card + "what could have been")
- Picked card is saved to collection via selectCard() with pity tracking
- Continue button after reveal navigates to next level or LevelSelect
- Non-bonus levels behave exactly as before (no overlay)
- TypeScript compiles and Vite builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-card-acquisition-flow/15-02-SUMMARY.md`
</output>
