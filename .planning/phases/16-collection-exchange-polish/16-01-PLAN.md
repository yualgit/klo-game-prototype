---
phase: 16-collection-exchange-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/CollectionsManager.ts
  - src/scenes/UIScene.ts
autonomous: true

must_haves:
  truths:
    - "CollectionsManager extends Phaser.Events.EventEmitter and emits events on state changes"
    - "exchangeCollection() deducts one of each card, preserves duplicates via card_counts"
    - "hasExchangeableCollection() returns true when any collection has all 6 unique cards"
    - "Notification dot appears on Collections tab when at least one collection is 6/6"
    - "Notification dot hides after all collections are exchanged below 6/6"
  artifacts:
    - path: "src/game/CollectionsManager.ts"
      provides: "EventEmitter extension, exchangeCollection(), hasExchangeableCollection(), event emission"
      contains: "extends Phaser.Events.EventEmitter"
    - path: "src/scenes/UIScene.ts"
      provides: "Notification dot circle on Collections tab, reactive show/hide from manager events"
      contains: "collectionsNotificationDot"
  key_links:
    - from: "src/game/CollectionsManager.ts"
      to: "src/scenes/UIScene.ts"
      via: "EventEmitter events: collection-exchangeable, collection-exchanged, no-exchangeable-collections"
      pattern: "this\\.emit\\('collection-exchange"
---

<objective>
Add EventEmitter to CollectionsManager with exchange logic and notification dot to UIScene.

Purpose: Foundation for exchange flow -- manager handles state transitions and emits events, UIScene reactively shows notification badge when a collection is ready for exchange.
Output: CollectionsManager with exchange capabilities, UIScene with reactive notification dot on Collections tab.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-collection-exchange-polish/16-RESEARCH.md

@src/game/CollectionsManager.ts
@src/game/EconomyManager.ts (reference for EventEmitter pattern)
@src/scenes/UIScene.ts
@src/game/collectionConfig.ts
@src/firebase/firestore.ts (CollectionState, CollectionProgress interfaces)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CollectionsManager with EventEmitter and exchange logic</name>
  <files>src/game/CollectionsManager.ts</files>
  <action>
Modify CollectionsManager to extend Phaser.Events.EventEmitter (same pattern as EconomyManager):

1. Import Phaser and add `extends Phaser.Events.EventEmitter` to the class declaration.
2. Add `super()` call as first line of constructor.
3. Update the class JSDoc comment to remove "does NOT extend EventEmitter yet" note and document the 3 events.

4. Add `hasExchangeableCollection(): boolean` method:
   - Check all 3 collection IDs ('coffee', 'food', 'car')
   - Return true if any returns true from `isCollectionComplete()`

5. Add `async exchangeCollection(collectionId: string): Promise<boolean>` method:
   - Guard: if `!this.isCollectionComplete(collectionId)`, log error and return false
   - Get all 6 cards for the collection via `getCardsForCollection(collectionId)`
   - For each card, decrement `card_counts[cardId]` by 1
   - If `card_counts[cardId]` reaches 0, remove cardId from `owned_cards` using `indexOf` + `splice`
   - If `card_counts[cardId]` is still > 0, card stays in `owned_cards` (player has duplicates)
   - Reset `pity_streak` to 0 (fresh start for re-collecting)
   - Emit `'collection-exchanged'` event with collectionId as argument
   - Check `hasExchangeableCollection()` -- if false, emit `'no-exchangeable-collections'`
   - Call `await this.save()`
   - Return true

IMPORTANT: The current data model stores unique card IDs in `owned_cards` and acquisition counts in `card_counts`. A card with `card_counts[id] = 3` means the player acquired it 3 times but `owned_cards` only has it once. Exchange should:
- Decrement `card_counts[cardId]` by 1 for each of the 6 cards
- Only remove from `owned_cards` if `card_counts[cardId]` drops to 0
- This preserves the "has duplicates" semantics correctly

6. Modify `selectCard()`: after the existing logic, add a check:
   ```
   const wasComplete = this.isCollectionComplete(collectionId);
   // ... existing selectCard logic ...
   if (!wasComplete && this.isCollectionComplete(collectionId)) {
     this.emit('collection-exchangeable');
   }
   ```
   Move the `wasComplete` check to BEFORE the card is added. The emit happens after `save()`.

7. Also modify `addCard()` similarly: check wasComplete before, emit after save if newly complete.

Events emitted:
- `'collection-exchangeable'` -- when any collection just reached 6/6
- `'collection-exchanged'` (collectionId: string) -- after successful exchange
- `'no-exchangeable-collections'` -- when no collections are 6/6 anymore
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for `extends Phaser.Events.EventEmitter` in CollectionsManager.ts. Grep for `exchangeCollection` method.</verify>
  <done>CollectionsManager extends EventEmitter, has exchangeCollection() that correctly deducts cards preserving duplicates, emits 3 events for reactive UI updates, and selectCard/addCard emit 'collection-exchangeable' when collection completes.</done>
</task>

<task type="auto">
  <name>Task 2: Add notification dot to UIScene Collections tab</name>
  <files>src/scenes/UIScene.ts</files>
  <action>
Add a reactive notification dot (small red circle) to the Collections tab in UIScene bottom nav:

1. Import CollectionsManager: `import { CollectionsManager } from '../game/CollectionsManager';`

2. Add class property: `private collectionsNotificationDot: Phaser.GameObjects.Circle | null = null;`
   Add class property: `private collections: CollectionsManager | null = null;`

3. In `createTabButton()`, after creating the hitArea for the 'collections' tab, add:
   ```typescript
   if (tabId === 'collections') {
     const dotRadius = cssToGame(4);
     const dotX = x + cssToGame(12); // Top-right offset from icon center
     const dotY = navCenterY - cssToGame(16); // Above the icon
     this.collectionsNotificationDot = this.add.circle(dotX, dotY, dotRadius, 0xff4444, 1);
     this.collectionsNotificationDot.setScrollFactor(0);
     this.collectionsNotificationDot.setDepth(202);
     this.collectionsNotificationDot.setVisible(false); // Hidden by default
   }
   ```

4. In `setupReactiveUpdates()`, after the economy subscriptions, add:
   ```typescript
   this.collections = this.registry.get('collections') as CollectionsManager;
   if (this.collections) {
     this.collections.on('collection-exchangeable', this.showNotificationDot, this);
     this.collections.on('collection-exchanged', this.updateNotificationDot, this);
     this.collections.on('no-exchangeable-collections', this.hideNotificationDot, this);

     // Initial check on create
     if (this.collections.hasExchangeableCollection()) {
       this.showNotificationDot();
     }
   }
   ```

5. Add 3 private methods:
   ```typescript
   private showNotificationDot = (): void => {
     if (this.collectionsNotificationDot) {
       this.collectionsNotificationDot.setVisible(true);
     }
   };

   private hideNotificationDot = (): void => {
     if (this.collectionsNotificationDot) {
       this.collectionsNotificationDot.setVisible(false);
     }
   };

   private updateNotificationDot = (): void => {
     if (this.collections && this.collectionsNotificationDot) {
       this.collectionsNotificationDot.setVisible(this.collections.hasExchangeableCollection());
     }
   };
   ```

6. In `destroyAllElements()`, add cleanup for the dot:
   ```typescript
   if (this.collectionsNotificationDot) {
     this.collectionsNotificationDot.destroy();
     this.collectionsNotificationDot = null;
   }
   // Remove collection event listeners
   if (this.collections) {
     this.collections.off('collection-exchangeable', this.showNotificationDot);
     this.collections.off('collection-exchanged', this.updateNotificationDot);
     this.collections.off('no-exchangeable-collections', this.hideNotificationDot);
   }
   ```

7. In `onShutdown()`, add collection event listener cleanup (same off() calls as destroyAllElements).

NOTE: The notification dot only renders when `showBottomNav` is true (since it's created inside `createTabButton` which is only called from `createBottomNav`). This is correct behavior -- no dot needed during gameplay when bottom nav is hidden.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for `collectionsNotificationDot` in UIScene.ts. Grep for `collection-exchangeable` subscription.</verify>
  <done>UIScene shows a red notification dot on the Collections tab when any collection is 6/6 ready for exchange. Dot appears reactively when a collection completes via selectCard/addCard. Dot hides when all collections drop below 6/6 after exchange. Event listeners properly cleaned up on shutdown and resize.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. CollectionsManager extends Phaser.Events.EventEmitter
3. exchangeCollection() exists and handles card deduction with duplicate preservation
4. hasExchangeableCollection() correctly checks all 3 collections
5. UIScene creates notification dot for Collections tab
6. Notification dot is reactive (shows on collection-exchangeable, hides on no-exchangeable-collections, updates on collection-exchanged)
7. All event listeners cleaned up on shutdown
</verification>

<success_criteria>
- CollectionsManager emits events on state changes (exchangeable, exchanged, no-exchangeable)
- Exchange logic correctly deducts 1 of each card, preserving duplicate counts
- Notification dot appears on Collections tab when any collection is 6/6
- Notification dot hides when no collections are 6/6
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-collection-exchange-polish/16-01-SUMMARY.md`
</output>
