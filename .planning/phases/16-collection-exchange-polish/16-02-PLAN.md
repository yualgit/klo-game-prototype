---
phase: 16-collection-exchange-polish
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/scenes/Collections.ts
autonomous: true

must_haves:
  truths:
    - "Exchange button appears below each collection's progress text"
    - "Exchange button is gold/interactive only when collection is 6/6 complete"
    - "Exchange button is gray/non-interactive when collection is incomplete"
    - "Clicking active exchange button triggers multi-stage animation (fold -> compress -> explode -> coupon reveal)"
    - "After animation, 'Забрати купон' button appears; clicking it executes exchange and rebuilds UI"
    - "After exchange, collection can be collected again (repeatable)"
    - "Input disabled during animation to prevent double-exchange"
  artifacts:
    - path: "src/scenes/Collections.ts"
      provides: "Exchange button per collection, exchange animation overlay, claim button"
      contains: "exchangeCollection"
  key_links:
    - from: "src/scenes/Collections.ts"
      to: "src/game/CollectionsManager.ts"
      via: "collections.exchangeCollection(collectionId) call from claim button"
      pattern: "exchangeCollection"
    - from: "src/scenes/Collections.ts"
      to: "src/game/collectionConfig.ts"
      via: "getCardsForCollection and getCollectionMeta for animation and coupon display"
      pattern: "getCollectionMeta"
---

<objective>
Add exchange button and exchange animation to Collections scene.

Purpose: Complete the collection exchange flow -- users see an exchange button per collection that activates when 6/6, triggers a satisfying animation sequence, reveals a coupon reward, and executes the exchange to allow re-collection.
Output: Collections scene with exchange buttons and full animation overlay.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-collection-exchange-polish/16-RESEARCH.md
@.planning/phases/16-collection-exchange-polish/16-01-SUMMARY.md

@src/scenes/Collections.ts
@src/game/CollectionsManager.ts
@src/game/collectionConfig.ts
@src/scenes/CardPickOverlay.ts (reference for flip animation + overlay pattern)
@src/game/VFXManager.ts (reference for particle effects)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exchange button per collection and exchange animation overlay</name>
  <files>src/scenes/Collections.ts</files>
  <action>
Modify Collections scene to add exchange buttons and a multi-stage exchange animation overlay:

**Part A: Exchange button in buildCollectionsUI()**

After the progress text rendering for each collection (around line 215 `currentY += cssToGame(50)`), add an exchange button:

1. Check `collectionsManager.isCollectionComplete(collectionId)` to determine active state.
2. Create a button container with:
   - Graphics background: gold (0xffb800) if active, gray (0xaaaaaa) if disabled
   - Rounded rect: ~200px wide, ~40px tall (CSS pixels), centered at width/2
   - Text: 'Обміняти на купон' in bold, color #1A1A1A if active, #666666 if disabled
   - Font size: cssToGame(14)
3. If active:
   - Make container interactive with `setSize()` + `setInteractive({ useHandCursor: true })`
   - On 'pointerup': call `this.startExchangeAnimation(collectionId)`
   - Add hover scale tween (1.0 -> 1.05 on pointerover, back on pointerout)
4. Push all button elements to `this.allElements[]`
5. Adjust `currentY` to account for button height before next collection spacing

**Part B: Exchange animation overlay method**

Add `private async startExchangeAnimation(collectionId: string): Promise<void>`:

Uses the overlay pattern (store all elements in `overlayElements[]`, destroy all on close).

Stage 1 - Setup (0ms):
- Disable scene input: `this.input.enabled = false`
- Create dark backdrop (Graphics, fillStyle 0x000000 alpha 0.75, full viewport)
- Make backdrop interactive to block clicks through (Phaser gotcha: `setInteractive(new Phaser.Geom.Rectangle(...), Phaser.Geom.Rectangle.Contains)`)
- Set backdrop depth to 500
- Get all 6 cards via `getCardsForCollection(collectionId)`
- Create 6 card containers in a 3x2 grid centered on screen
  - Each card: image with card.textureKey, display size cardWidth x cardHeight (same proportions as collection grid)
  - Set depth 501 for all card containers
- Wait 300ms via `this.time.delayedCall`

NOTE: The animation viewport should use camera viewport dimensions, NOT scrolled world coordinates. Use `this.cameras.main.width` and `this.cameras.main.height` for dimensions, and position animation elements at absolute screen positions. Set `setScrollFactor(0)` on ALL overlay elements so they're fixed to screen, not world.

Stage 2 - Fold (300ms mark, 400ms duration):
- Tween all 6 cards: scaleX -> 0.2, scaleY -> 0.8, angle alternating -15/+15
- Ease: 'Quad.In'
- Use Promise.all to wait for all tweens

Stage 3 - Compress to center (700ms mark, 500ms duration):
- Tween all 6 cards: x -> centerX, y -> centerY, scale -> 0
- Ease: 'Cubic.In'
- Use Promise.all to wait

Stage 4 - Explode (1200ms mark):
- Camera flash: `this.cameras.main.flash(150, 255, 184, 0)` (gold)
- Camera shake: `this.cameras.main.shake(200, 0.008)`
- Create particle emitter at center using 'particle_white' texture (exists from VFXManager)
  - speed: 100-300, scale: start 0.8 end 0, lifespan: 400-800
  - tint: [0xffb800, 0xffffff, 0xff6600] (gold/white/orange)
  - maxParticles: 50, emitting: false
  - Call `emitter.explode(50)`
  - Add emitter to overlayElements, set depth 502
- Wait 600ms

Stage 5 - Coupon reveal (1800ms mark, 500ms duration):
- Get collection meta via `getCollectionMeta(collectionId)`
- Create coupon title text: `${meta.nameUk} -- Купон` (FFB800 color, bold, fontSize 24 CSS)
- Create reward description text: `meta.rewardDescription` (F9F9F9 color, fontSize 16 CSS)
- Both texts: setOrigin(0.5), setDepth(501), setAlpha(0), setScale(0.5), setScrollFactor(0)
- Tween both texts: alpha -> 1, scale -> 1, duration 500, ease 'Back.Out'
- Wait 600ms

Stage 6 - Claim button (2400ms mark):
- Create "Забрати купон" button container:
  - Gold rounded rect background (0xffb800), ~180px wide x 44px tall
  - Text: 'Забрати купон', bold, fontSize 16 CSS, color #1A1A1A
  - setDepth(501), setScrollFactor(0)
  - Make interactive
  - On 'pointerup':
    1. Get CollectionsManager from registry
    2. Call `await collections.exchangeCollection(collectionId)`
    3. Destroy all overlayElements
    4. Re-enable input: `this.input.enabled = true`
    5. Call `this.buildCollectionsUI()` to rebuild UI showing updated state
    6. Reset camera scroll to top: `this.cameras.main.scrollY = 0`
  - Add hover scale tween (1.05)
- Re-enable input ONLY for the claim button: `this.input.enabled = true`

**Important implementation details:**
- ALL overlay elements (backdrop, card containers, particles, texts, button) go in `overlayElements[]` array
- All overlay elements get `setScrollFactor(0)` so they're viewport-fixed during animation
- Card containers in the animation should use the same card textures but can be slightly smaller than the collection grid cards
- Use `const centerX = this.cameras.main.width / 2` and `const centerY = this.cameras.main.height / 2` for centering
- The claim button click should be the ONLY way to dismiss the overlay (no tap-backdrop-to-close)
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for `startExchangeAnimation` in Collections.ts. Grep for `Забрати купон` in Collections.ts. Verify buildCollectionsUI now creates exchange buttons (grep for `Обміняти на купон`).</verify>
  <done>Collections scene shows exchange button per collection (gold when 6/6, gray when incomplete). Clicking active button plays 6-stage animation (fold, compress, explode, coupon reveal, claim button). Claim button executes exchange and rebuilds UI. Input disabled during animation. Collection is repeatable after exchange.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Exchange button renders below each collection with correct active/disabled state
3. Clicking active exchange button triggers multi-stage animation
4. Animation sequence: fold (400ms) -> compress (500ms) -> explode (particles+flash) -> coupon reveal (500ms) -> claim button
5. Claim button calls exchangeCollection() and rebuilds UI
6. After exchange, collection shows 0/6 or partial progress (duplicates preserved)
7. Exchange button becomes gray/disabled after exchange (collection no longer 6/6)
8. No memory leaks (all overlay elements destroyed on claim)
9. Input disabled during animation, re-enabled for claim button only
</verification>

<success_criteria>
- Exchange button active (gold) only when collection is 6/6 complete
- Exchange animation plays all 6 stages in sequence (~2.5 seconds)
- Exchange deducts exactly 6 cards via CollectionsManager.exchangeCollection()
- After exchange, collection can be collected again (repeatable -- COL-13)
- No TypeScript errors
- No double-exchange possible (input disabled during animation)
</success_criteria>

<output>
After completion, create `.planning/phases/16-collection-exchange-polish/16-02-SUMMARY.md`
</output>
