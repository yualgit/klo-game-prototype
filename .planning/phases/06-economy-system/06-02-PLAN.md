---
phase: 06-economy-system
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/scenes/LevelSelect.ts
  - src/scenes/Game.ts
autonomous: true

must_haves:
  truths:
    - "User sees lives count and bonus balance on level select screen"
    - "User sees countdown timer when lives are below maximum"
    - "User with 0 lives cannot start a level and sees refill prompt"
    - "User loses 1 life when failing a level"
    - "User can spend 15 bonuses to refill all lives"
    - "Lives count updates automatically as regeneration ticks"
  artifacts:
    - path: "src/scenes/LevelSelect.ts"
      provides: "Lives HUD with countdown timer and level gating"
      contains: "economyManager"
    - path: "src/scenes/Game.ts"
      provides: "Life loss on fail and no-lives prompt with refill"
      contains: "loseLife"
  key_links:
    - from: "src/scenes/LevelSelect.ts"
      to: "src/game/EconomyManager.ts"
      via: "registry.get('economy')"
      pattern: "registry\\.get.*economy"
    - from: "src/scenes/Game.ts"
      to: "src/game/EconomyManager.ts"
      via: "registry.get('economy') for loseLife and canStartLevel"
      pattern: "economyM.*(loseLife|canStartLevel|spendBonuses)"
    - from: "src/scenes/LevelSelect.ts"
      to: "level start gating"
      via: "canStartLevel check before scene.start('Game')"
      pattern: "canStartLevel"
---

<objective>
Integrate EconomyManager into LevelSelect (lives HUD, countdown timer, level gating) and Game scene (life loss on fail, no-lives prompt with refill option).

Purpose: Makes the economy system visible and functional for the player. Covers ECON-02, ECON-03, ECON-05, ECON-06 ‚Äî the user-facing requirements that make lives matter in gameplay.

Output: LevelSelect shows lives/bonuses/countdown, gates level start at 0 lives. Game scene deducts life on fail, shows refill prompt when needed.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-economy-system/06-RESEARCH.md
@.planning/phases/06-economy-system/06-01-SUMMARY.md
@src/scenes/LevelSelect.ts
@src/scenes/Game.ts
@src/game/EconomyManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lives HUD and level gating to LevelSelect</name>
  <files>
    src/scenes/LevelSelect.ts
  </files>
  <action>
Modify LevelSelect scene to display lives count, bonus balance, countdown timer, and gate level start when lives = 0.

**1. Add EconomyManager import:**
```typescript
import { EconomyManager } from '../game/EconomyManager';
```

**2. Add class properties for economy HUD:**
```typescript
private livesText: Phaser.GameObjects.Text;
private bonusText: Phaser.GameObjects.Text;
private countdownText: Phaser.GameObjects.Text;
private timerEvent: Phaser.Time.TimerEvent;
```

**3. In create(), after getting progress, get economy manager:**
```typescript
const economy = this.registry.get('economy') as EconomyManager;
```

**4. Create economy HUD (top-right area of screen):**

Position the economy display in the top-right corner, horizontally laid out:
- Heart icon (use text "‚ù§" or GUI_TEXTURE_KEYS if heart asset exists ‚Äî check constants first, if not use text) + lives count text "X/5"
- Countdown text "Next: MM:SS" (only shown when lives < 5)
- Bonus icon (use text "üíé" or similar) + bonus balance text

Create these as a container positioned at approximately (width - 200, 60) so it doesn't overlap with the "–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å" title or back button.

Lives text: `{lives}/5` in bold 24px, color '#1A1A1A'
Countdown text: `–î–∞–ª—ñ: MM:SS` in 16px, color '#666666' ‚Äî hidden when lives = 5
Bonus text: `{bonuses}` in bold 20px, color '#FFB800'

**5. Create 1-second timer for countdown updates:**
```typescript
this.timerEvent = this.time.addEvent({
  delay: 1000,
  callback: this.updateEconomyDisplay,
  callbackScope: this,
  loop: true,
});
this.updateEconomyDisplay(); // Initial update
```

**6. Add updateEconomyDisplay() method:**
- Get economy manager from registry
- Update lives text with current lives
- If lives < 5: calculate seconds until next life, format as MM:SS, show countdown text
- If lives = 5: hide countdown text (setText(''))
- Update bonus text

**7. Modify level checkpoint pointerup handler to gate on lives:**

In `createLevelCheckpoint`, change the `pointerup` handler from:
```typescript
container.on('pointerup', () => {
  console.log(`[LevelSelect] Starting level ${levelId}`);
  this.cameras.main.fadeOut(300, 0, 0, 0);
  this.cameras.main.once('camerafadeoutcomplete', () => {
    this.scene.start('Game', { levelId });
  });
});
```

To:
```typescript
container.on('pointerup', () => {
  const economy = this.registry.get('economy') as EconomyManager;
  if (!economy.canStartLevel()) {
    console.log('[LevelSelect] No lives, showing refill prompt');
    this.showNoLivesPrompt(economy);
    return;
  }
  console.log(`[LevelSelect] Starting level ${levelId}`);
  this.cameras.main.fadeOut(300, 0, 0, 0);
  this.cameras.main.once('camerafadeoutcomplete', () => {
    this.scene.start('Game', { levelId });
  });
});
```

**8. Add showNoLivesPrompt(economy: EconomyManager) method:**

Create a modal overlay (similar to Game scene overlay pattern):
- Semi-transparent dark backdrop (0x000000, 0.6)
- White rounded panel (300x250, centered)
- Title: "–ù–µ–º–∞—î –∂–∏—Ç—Ç—ñ–≤!" (32px bold)
- Countdown: "–ù–∞—Å—Ç—É–ø–Ω–µ —á–µ—Ä–µ–∑: MM:SS" (16px gray)
- Refill button: "–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ (15 –±–æ–Ω—É—Å—ñ–≤)" ‚Äî only interactive if bonuses >= 15
  - On click: call `await economy.spendBonusesForRefill()`. If success, destroy overlay, update HUD
  - If insufficient bonuses, show text "–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–æ–Ω—É—Å—ñ–≤" in gray, non-interactive
- Close button: "–ó–∞–∫—Ä–∏—Ç–∏" (secondary style) ‚Äî destroys overlay

Store overlay elements in an array/container so they can be destroyed together on close.

**9. Add shutdown handler to clean up timer:**
```typescript
this.events.once('shutdown', () => {
  if (this.timerEvent) {
    this.timerEvent.remove();
    this.timerEvent = null!;
  }
});
```

Place this in create() after timer creation.

Use the existing visual style: KLO_YELLOW for accents, Arial font, #1A1A1A for dark text, #666666 for secondary. Follow the existing `createOverlayButton` pattern from Game.ts for button styling (or reuse GUI_TEXTURE_KEYS.buttonOrange/buttonYellow).
  </action>
  <verify>
Run `npx tsc --noEmit` ‚Äî no type errors.
Run `npm run dev`:
1. Navigate to LevelSelect ‚Äî see lives "5/5" and bonus "500" displayed
2. No countdown timer shown when lives = 5
3. Level buttons still work when lives > 0
  </verify>
  <done>
LevelSelect displays lives count, bonus balance, and countdown timer (ECON-05). Level start gated when lives = 0 with refill prompt (ECON-03). Refill prompt allows spending 15 bonuses (ECON-06). Timer cleans up on scene shutdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate life loss and no-lives handling in Game scene</name>
  <files>
    src/scenes/Game.ts
  </files>
  <action>
Modify Game scene to deduct life on level failure and check lives before level start.

**1. Add EconomyManager import:**
```typescript
import { EconomyManager } from '../game/EconomyManager';
```

**2. Modify showLoseOverlay() to deduct life:**

At the start of `showLoseOverlay()`, add life loss:
```typescript
const economy = this.registry.get('economy') as EconomyManager;
economy.loseLife(); // Fire-and-forget is OK here since we show overlay anyway
```

Then add lives remaining display to the lose overlay panel. After the subtitle "–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑!", add:
```typescript
const livesRemaining = economy.getLives();
const livesInfo = this.add.text(panelW / 2, 130, `–ó–∞–ª–∏—à–∏–ª–æ—Å—å –∂–∏—Ç—Ç—ñ–≤: ${livesRemaining}/5`, {
  fontFamily: 'Arial, sans-serif',
  fontSize: '18px',
  color: '#FFB800',
  fontStyle: 'bold',
});
livesInfo.setOrigin(0.5);
panelContainer.add(livesInfo);
```

**3. Modify the "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏" button in showLoseOverlay():**

Change the retry button handler to check lives before restarting:
```typescript
const retryBtn = this.createOverlayButton(panelW / 2, 170, '–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏', () => {
  const eco = this.registry.get('economy') as EconomyManager;
  if (!eco.canStartLevel()) {
    // Show inline refill option instead of restarting
    this.showRefillOrReturn(panelContainer, panelW);
    return;
  }
  this.scene.start('Game', { levelId: this.currentLevel });
});
panelContainer.add(retryBtn);
```

Adjust the "–ú–µ–Ω—é" button Y position accordingly (move down to ~230):
```typescript
const menuBtn = this.createOverlayButton(panelW / 2, 230, '–ú–µ–Ω—é', () => {
  this.scene.start('LevelSelect');
}, true);
panelContainer.add(menuBtn);
```

**4. Add showRefillOrReturn() helper method:**

```typescript
private showRefillOrReturn(panelContainer: Phaser.GameObjects.Container, panelW: number): void {
  const economy = this.registry.get('economy') as EconomyManager;
  const canRefill = economy.getBonuses() >= 15;

  // Replace panel content with refill options
  // Add refill message
  const msg = this.add.text(panelW / 2, 280, canRefill ? '–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ –∂–∏—Ç—Ç—è?' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–æ–Ω—É—Å—ñ–≤', {
    fontFamily: 'Arial, sans-serif',
    fontSize: '18px',
    color: canRefill ? '#1A1A1A' : '#999999',
    fontStyle: 'bold',
  });
  msg.setOrigin(0.5);
  panelContainer.add(msg);

  if (canRefill) {
    const refillBtn = this.createOverlayButton(panelW / 2, 320, '–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ (15)', async () => {
      const success = await economy.spendBonusesForRefill();
      if (success) {
        this.scene.start('Game', { levelId: this.currentLevel });
      }
    });
    panelContainer.add(refillBtn);
  }
}
```

Expand the lose overlay panel height to accommodate the refill section. Change panelH from 280 to 380 in showLoseOverlay(). Adjust button positions:
- Lives info at y=130
- Retry button at y=180
- Menu button at y=240
- Refill section starts at y=290 (added dynamically)

**5. Add lives display to win overlay:**

In `showWinOverlay()`, after star calculation, add lives display. After the stars section and before buttons:
```typescript
const economyMgr = this.registry.get('economy') as EconomyManager;
const currentLives = economyMgr.getLives();
const livesDisplay = this.add.text(panelW / 2, starY + 50, `‚ù§ ${currentLives}/5`, {
  fontFamily: 'Arial, sans-serif',
  fontSize: '18px',
  color: '#FFB800',
});
livesDisplay.setOrigin(0.5);
panelContainer.add(livesDisplay);
```

This is informational only ‚Äî no life is lost on win. It shows remaining lives so player knows their state before continuing.

**Important notes:**
- Do NOT change any existing game mechanics (swap, cascade, match detection).
- The `loseLife()` call must happen ONCE in `showLoseOverlay()`, not in `handleLevelEvent`. This prevents double-counting if the overlay method is called multiple times.
- Keep `sceneActive` guard pattern for all async operations.
- Follow existing code style: `[Game]` prefix in console.log, same font/color patterns.
  </action>
  <verify>
Run `npx tsc --noEmit` ‚Äî no type errors.
Run `npm run dev`:
1. Start a level, intentionally lose (make bad moves until moves run out)
2. Lose overlay shows "–ó–∞–ª–∏—à–∏–ª–æ—Å—å –∂–∏—Ç—Ç—ñ–≤: 4/5"
3. Retry button works if lives > 0
4. Return to LevelSelect ‚Äî lives count shows 4/5
5. Repeat until 0 lives ‚Äî retry should show refill prompt
  </verify>
  <done>
Game scene deducts 1 life on level failure (ECON-02). Lose overlay displays remaining lives. Retry gated when 0 lives with refill option (ECON-03, ECON-06). Win overlay shows current lives for awareness. All economy operations async-safe with sceneActive guard.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. New user starts with 5 lives and 500 bonuses visible in LevelSelect (ECON-01)
3. Failing a level reduces lives by 1 (ECON-02)
4. User with 0 lives sees "no lives" prompt when tapping level node (ECON-03)
5. Lives regenerate at 1 per 30 minutes (verify by checking EconomyManager calculations) (ECON-04)
6. Lives count and countdown timer visible in LevelSelect HUD (ECON-05)
7. User can spend 15 bonuses to refill lives from both LevelSelect and Game scene (ECON-06)
8. Close and reopen app ‚Äî economy state persists from Firestore (ECON-07)
</verification>

<success_criteria>
- LevelSelect shows lives, bonuses, and countdown timer
- Level start blocked at 0 lives with working refill prompt
- Game scene deducts life on loss, shows remaining count
- Retry gated at 0 lives with refill fallback
- All 7 ECON requirements demonstrably implemented
</success_criteria>

<output>
After completion, create `.planning/phases/06-economy-system/06-02-SUMMARY.md`
</output>
