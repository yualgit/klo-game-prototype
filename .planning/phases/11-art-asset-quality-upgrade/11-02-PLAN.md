---
phase: 11-art-asset-quality-upgrade
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/game/TileSprite.ts
  - src/scenes/Game.ts
  - src/game/Match3Engine.test.ts
  - src/game/LevelManager.test.ts
  - src/game/BoosterActivator.test.ts
autonomous: true

must_haves:
  truths:
    - "Boosters display dedicated sprite art (Image) instead of programmatic Graphics overlays"
    - "Each of the 4 booster types has a unique subtle idle animation (pulse, shimmer, or rotation)"
    - "Booster idle tweens are properly cleaned up on tile reset and scene shutdown"
    - "Inactive cells display block.png sprite when level config says 'block', or transparent when 'transparent'/absent"
    - "Game scene no longer uses hardcoded 'fuel'|'coffee'|'snack'|'road' type casts"
    - "All tests pass with the new tile type names"
  artifacts:
    - path: "src/game/TileSprite.ts"
      provides: "Booster Image rendering with idle tween effects"
      contains: "booster_bomb|boosterImage|boosterIdleTween"
    - path: "src/scenes/Game.ts"
      provides: "Inactive cell styling and updated type references"
      contains: "inactive_cell_style|block_texture"
    - path: "src/game/Match3Engine.test.ts"
      provides: "Tests using new tile type names"
      contains: "burger.*hotdog.*snack"
  key_links:
    - from: "src/game/TileSprite.ts"
      to: "src/game/constants.ts"
      via: "Imports BOOSTER_TEXTURE_KEYS for sprite rendering"
      pattern: "BOOSTER_TEXTURE_KEYS"
    - from: "src/scenes/Game.ts"
      to: "src/game/types.ts"
      via: "Uses LevelData.grid.inactive_cell_style for block rendering"
      pattern: "inactive_cell_style"
    - from: "src/game/TileSprite.ts"
      to: "Phaser tweens"
      via: "scene.tweens.add for idle effects with cleanup on destroy/reset"
      pattern: "boosterIdleTween.*stop"
---

<objective>
Replace programmatic Graphics-based booster overlays with dedicated sprite art plus subtle idle animations, implement inactive cell visual styling (block/transparent), update Game.ts type casts to use new tile types, and fix all test files to use new tile type names.

Purpose: Complete the visual upgrade by rendering boosters as Image sprites with polished idle effects, styling inactive cells distinctly, and ensuring all code and tests compile and pass with the new type system.
Output: Fully functional visual rendering with sprite-based boosters, styled inactive cells, and passing test suite.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-art-asset-quality-upgrade/11-CONTEXT.md
@.planning/phases/11-art-asset-quality-upgrade/11-RESEARCH.md
@.planning/phases/11-art-asset-quality-upgrade/11-01-SUMMARY.md

@src/game/TileSprite.ts
@src/scenes/Game.ts
@src/game/constants.ts
@src/game/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace booster Graphics overlays with Image sprites and idle animations</name>
  <files>src/game/TileSprite.ts</files>
  <action>
  Import `BOOSTER_TEXTURE_KEYS` from constants.ts.

  Add class properties:
  ```typescript
  private boosterImage?: Phaser.GameObjects.Image;
  private boosterIdleTween?: Phaser.Tweens.Tween;
  ```

  **Rewrite `drawBooster()` method:**
  1. Clear the old `boosterGraphics` (keep the Graphics object for backward compat but clear it every draw)
  2. If `boosterImage` exists, stop and remove `boosterIdleTween` if any, then destroy `boosterImage`, set both to undefined
  3. If no `boosterType`, return early
  4. Look up texture key from `BOOSTER_TEXTURE_KEYS[this.boosterType]`
  5. If texture exists in scene: create `this.boosterImage = this.scene.add.image(0, 0, textureKey)`, set display size to `(TILE_SIZE - TILE_GAP)`, add to container via `this.add(this.boosterImage)`
  6. Call `this.addBoosterIdleEffect()` to start subtle animation

  **New `addBoosterIdleEffect()` private method:**
  Per user decision: each booster gets a unique SUBTLE idle effect. Effects should be "barely noticeable shimmer/pulse" — not distracting.

  ```typescript
  private addBoosterIdleEffect(): void {
    if (!this.boosterImage || !this.boosterType) return;

    // Stop existing tween
    if (this.boosterIdleTween) {
      this.boosterIdleTween.stop();
      this.boosterIdleTween.remove();
      this.boosterIdleTween = undefined;
    }

    switch (this.boosterType) {
      case 'bomb':
        // Subtle pulse: scale 1.0 -> 1.03 over 1.2s
        this.boosterIdleTween = this.scene.tweens.add({
          targets: this.boosterImage,
          scaleX: 1.03,
          scaleY: 1.03,
          duration: 600,
          ease: 'Sine.InOut',
          yoyo: true,
          repeat: -1,
        });
        break;

      case 'linear_horizontal':
        // Subtle horizontal shimmer: alpha 0.88 -> 1.0 over 0.8s
        this.boosterIdleTween = this.scene.tweens.add({
          targets: this.boosterImage,
          alpha: 0.88,
          duration: 400,
          ease: 'Sine.InOut',
          yoyo: true,
          repeat: -1,
        });
        break;

      case 'linear_vertical':
        // Subtle vertical shimmer: alpha 0.88 -> 1.0 over 0.8s (same as horizontal)
        this.boosterIdleTween = this.scene.tweens.add({
          targets: this.boosterImage,
          alpha: 0.88,
          duration: 400,
          ease: 'Sine.InOut',
          yoyo: true,
          repeat: -1,
        });
        break;

      case 'klo_sphere':
        // Subtle slow rotation: 0 -> 360 degrees over 6s
        this.boosterIdleTween = this.scene.tweens.add({
          targets: this.boosterImage,
          angle: 360,
          duration: 6000,
          ease: 'Linear',
          repeat: -1,
        });
        break;
    }
  }
  ```

  **Update `reset()` method** — add cleanup for booster image and tween:
  ```typescript
  // In reset(), BEFORE existing cleanup:
  if (this.boosterIdleTween) {
    this.boosterIdleTween.stop();
    this.boosterIdleTween.remove();
    this.boosterIdleTween = undefined;
  }
  if (this.boosterImage) {
    this.boosterImage.destroy();
    this.boosterImage = undefined;
  }
  ```

  **Remove all Graphics-based drawing from drawBooster()** — the old switch cases drawing lines, circles, arrows, and star patterns should be fully deleted. The boosterGraphics.clear() at the top can remain as a safety measure but no new Graphics drawing code should follow.

  **Remove hardcoded type casts** — the old `'fuel' | 'coffee' | 'snack' | 'road'` type cast pattern is NOT in TileSprite.ts (it's in Game.ts), but verify no old tile type strings exist in TileSprite.ts.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -20` — no errors in TileSprite.ts. Grep TileSprite.ts for 'arrow', 'star', 'fillCircle' — should find none (old Graphics drawing removed). Grep for 'boosterImage', 'boosterIdleTween' — should find multiple hits (new sprite system).</verify>
  <done>TileSprite.drawBooster() creates Image sprite from BOOSTER_TEXTURE_KEYS instead of Graphics drawing. Each booster type has unique idle tween (bomb pulses, lines shimmer, sphere rotates). Tween and image cleanup in reset(). No programmatic booster drawing remains.</done>
</task>

<task type="auto">
  <name>Task 2: Update Game.ts for inactive cell styling and remove old type casts</name>
  <files>src/scenes/Game.ts</files>
  <action>
  Import `BLOCK_TEXTURE_KEY` from constants.ts (added in plan 11-01).

  **1. Inactive cell rendering (replace gridMaskGraphics approach):**

  Add a class property: `private blockSprites: Phaser.GameObjects.Image[] = [];`

  Update `drawGridBackground()`:
  - Keep the gridMaskGraphics section for "transparent" mode (masking inactive cells with background color)
  - BUT: Check `this.levelData.grid.inactive_cell_style` (default to 'transparent' if absent for backward compat)
  - If style is 'block': instead of filling inactive cells with scene background color, place `block_texture` Image sprites at each inactive cell position. Use `setDisplaySize(TILE_SIZE, TILE_SIZE)` and `setDepth(-1)` (render behind tiles). Store sprites in `this.blockSprites` array.
  - If style is 'transparent': use existing gridMaskGraphics approach (fill with scene bg color) — this makes inactive cells look like they don't exist.

  Implementation:
  ```typescript
  // In drawGridBackground(), REPLACE the gridMaskGraphics section:
  const inactiveStyle = this.levelData.grid.inactive_cell_style || 'transparent';

  this.gridMaskGraphics = this.add.graphics();

  for (let row = 0; row < this.gridHeight; row++) {
    for (let col = 0; col < this.gridWidth; col++) {
      if (!this.engine.isCellActive(row, col)) {
        if (inactiveStyle === 'block') {
          // Place block sprite
          const x = this.gridOffsetX + col * TILE_SIZE + TILE_SIZE / 2;
          const y = this.gridOffsetY + row * TILE_SIZE + TILE_SIZE / 2;
          const blockSprite = this.add.image(x, y, BLOCK_TEXTURE_KEY);
          blockSprite.setDisplaySize(TILE_SIZE, TILE_SIZE);
          blockSprite.setDepth(0); // Same depth as board, under tiles
          this.blockSprites.push(blockSprite);
        } else {
          // Transparent: mask with bg color
          this.gridMaskGraphics.fillStyle(0xFFFBF0, 1);
          this.gridMaskGraphics.fillRect(
            this.gridOffsetX + col * TILE_SIZE,
            this.gridOffsetY + row * TILE_SIZE,
            TILE_SIZE,
            TILE_SIZE
          );
        }
      }
    }
  }
  ```

  **2. Update `redrawGridBackground()` resize handler:**
  - For block sprites: reposition them based on new gridOffsetX/gridOffsetY
  - For mask: redraw as before but only in transparent mode
  ```typescript
  // Reposition block sprites on resize
  let blockIdx = 0;
  const inactiveStyle = this.levelData.grid.inactive_cell_style || 'transparent';
  if (inactiveStyle === 'block') {
    for (let row = 0; row < this.gridHeight; row++) {
      for (let col = 0; col < this.gridWidth; col++) {
        if (!this.engine.isCellActive(row, col)) {
          if (blockIdx < this.blockSprites.length) {
            this.blockSprites[blockIdx].setPosition(
              this.gridOffsetX + col * TILE_SIZE + TILE_SIZE / 2,
              this.gridOffsetY + row * TILE_SIZE + TILE_SIZE / 2
            );
            blockIdx++;
          }
        }
      }
    }
  }
  // Keep gridMaskGraphics redraw for transparent mode
  if (this.gridMaskGraphics && inactiveStyle === 'transparent') {
    this.gridMaskGraphics.clear();
    this.gridMaskGraphics.fillStyle(0xFFFBF0, 1);
    // ... existing cell iteration
  }
  ```

  **3. Update `resetState()`:**
  Add: `this.blockSprites = [];`

  **4. Remove hardcoded old type casts throughout Game.ts:**
  - Line ~710: `tileType as 'fuel' | 'coffee' | 'snack' | 'road'` -> `tileType as TileType` (or just use tileType directly since it's already TileType from the engine)
  - Line ~1138: `sprite.setType(boosterSpawn.baseType as 'fuel' | 'coffee' | 'snack' | 'road')` -> `sprite.setType(boosterSpawn.baseType)`
  - Line ~1259: `sprite.setType(tileType as 'fuel' | 'coffee' | 'snack' | 'road')` -> `sprite.setType(tileType as TileType)` or just `sprite.setType(tileType)`
  - Line ~1399: same pattern -> remove old cast
  - Line ~703 and ~1258: `spawn.type === 'empty' ? 'fuel' : spawn.type` -> change fallback from 'fuel' to 'burger' (first new tile type)
  - Line ~1397: same 'fuel' fallback -> 'burger'
  - Line ~1080, ~1116, ~1150, ~1152: `type: 'fuel'` placeholder in match objects -> `type: 'burger'` (or any valid TileType — this field is not used for matching logic, just satisfies the Match interface)

  **5. Verify TileSprite constructor call:**
  - Line ~706-711: The constructor takes `type: TileType` which is now the new union. The `tileType` variable comes from engine.getGrid() which uses the new types from plan 11-01. Just ensure the type cast is to `TileType` not old specific literals.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -20` — no errors. Grep Game.ts for `'fuel'` and `'road'` — should find zero hits. Grep for `block_texture` or `BLOCK_TEXTURE_KEY` — should find at least one hit. Grep for `inactive_cell_style` — should find hits.</verify>
  <done>Game.ts renders inactive cells with block sprites when level config says "block", or transparent mask otherwise. Block sprites reposition on resize. All hardcoded old type casts ('fuel'|'coffee'|'snack'|'road') replaced with TileType or new type names. No references to old tile types remain.</done>
</task>

<task type="auto">
  <name>Task 3: Update all test files for new tile types</name>
  <files>src/game/Match3Engine.test.ts, src/game/LevelManager.test.ts, src/game/BoosterActivator.test.ts</files>
  <action>
  **Match3Engine.test.ts:**
  1. Update `defaultSpawnRules` from `{ fuel: 0.25, coffee: 0.25, snack: 0.25, road: 0.25 }` to `{ burger: 0.17, hotdog: 0.17, oil: 0.17, water: 0.16, snack: 0.17, soda: 0.16 }` (6-way equal split)
  2. Replace ALL tile type string literals throughout the file:
     - `'fuel'` -> `'burger'`
     - `'coffee'` -> `'hotdog'`
     - `'road'` -> `'oil'`
     - `'snack'` remains `'snack'`
  3. For board pattern setup lines like `((row + col) % 2 === 0) ? 'fuel' : 'coffee'`, change to `((row + col) % 2 === 0) ? 'burger' : 'hotdog'`
  4. For lines using 3 or 4 types for alternating: use burger/hotdog/oil/snack as replacements
  5. Verify the logic of each test is preserved — only the TYPE NAMES change, not the test structure

  **LevelManager.test.ts:**
  1. Replace `'fuel' as const` with `'burger' as const` everywhere
  2. Replace `'coffee' as const` with `'hotdog' as const` everywhere
  3. Keep `'snack' as const` unchanged
  4. Keep all other test structure unchanged

  **BoosterActivator.test.ts:**
  1. Replace `'fuel'` with `'burger'`
  2. Replace `'coffee'` with `'hotdog'`
  3. The SpawnRules in test setup (if any) should use new field names
  4. Keep test logic unchanged

  **IMPORTANT:** Do NOT change the test logic, only the string literal values for tile types. Every assertion and setup should keep the same structure.
  </action>
  <verify>Run `npx vitest run 2>&1 | tail -20` to execute all tests. All tests should pass. Grep all test files for `'fuel'` and `'road'` and `'coffee'` — should find zero matches (except possibly in comments).</verify>
  <done>All test files compile and pass with new tile type names. Zero references to fuel/coffee/road remain in test assertions or setup code. Test count and pass rate unchanged from before the migration.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors across entire project
2. `npx vitest run` — all tests pass
3. `grep -rn "'fuel'\|'coffee'\|'road'\|'light'" src/` returns zero matches (complete migration)
4. `grep -rn '"fuel"\|"coffee"\|"road"\|"light"' data/levels/ public/data/levels/` returns zero matches
5. TileSprite.ts contains no Graphics-based booster drawing (no fillCircle, lineBetween, fillPath in drawBooster)
6. Game.ts references BLOCK_TEXTURE_KEY and inactive_cell_style
7. Booster idle tweens exist for all 4 booster types (bomb, linear_horizontal, linear_vertical, klo_sphere)
</verification>

<success_criteria>
- Boosters render as sprite images (not Graphics) with 4 unique idle animations
- Inactive cells styled per level config (block image or transparent)
- All type casts use new TileType union, no old literal casts
- Full test suite passes with new tile type names
- Zero references to fuel/coffee/road/light anywhere in src/ or level data
</success_criteria>

<output>
After completion, create `.planning/phases/11-art-asset-quality-upgrade/11-02-SUMMARY.md`
</output>
