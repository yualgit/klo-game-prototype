---
phase: 21-game-screen-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scenes/Game.ts
  - src/scenes/LevelSelect.ts
autonomous: true

must_haves:
  truths:
    - "On mobile (viewport CSS width < 600px), back button renders as square icon-only '<' button"
    - "On mobile, HUD displays level and moves on line 1, goal text (smaller font) on line 2"
    - "On desktop, HUD and back button remain unchanged (single-line HUD, '< Menu' button)"
    - "LevelSelect resize handler does not crash with 'Cannot read properties of undefined' error"
  artifacts:
    - path: "src/scenes/Game.ts"
      provides: "Mobile-adaptive HUD and back button"
      contains: "isMobile"
    - path: "src/scenes/LevelSelect.ts"
      provides: "Safe resize handler with camera guard"
      contains: "cameras.main"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "src/utils/responsive.ts"
      via: "getDpr import for mobile detection"
      pattern: "getDpr"
---

<objective>
Make the Game scene HUD and back button responsive for mobile viewports, and fix the LevelSelect viewport crash.

Purpose: On narrow mobile screens (375-428px CSS width), the single-line HUD overflows and the "< Menu" back button is cramped. Mobile users need a compact icon-only back button and a two-line HUD. The LevelSelect resize handler crashes when cameras.main is undefined during scene transitions.

Output: Mobile-adaptive Game HUD layout, icon-only mobile back button, and crash-free LevelSelect resize handler.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/scenes/Game.ts
@src/scenes/LevelSelect.ts
@src/utils/responsive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mobile-adaptive back button and HUD layout in Game.ts</name>
  <files>src/scenes/Game.ts</files>
  <action>
Add `getDpr` to the import from `../utils/responsive` (line 18, currently imports `getResponsiveLayout, cssToGame`).

**Back button (GAME-01):**
Modify `createBackButton()` (line 862) to detect mobile viewport and render conditionally:
- Detect mobile: `const isMobile = this.cameras.main.width / getDpr() < 600;`
- Mobile: square button with `cssToGame(36)` width and height, display only `<` character with `cssToGame(18)` bold font
- Desktop: keep current "< Menu" text button with existing `this.layout.backButtonWidth` / `this.layout.backButtonHeight`
- Use `GUI_TEXTURE_KEYS.buttonYellow` for both variants
- Keep existing pointer handlers (hover, click → scene.start('LevelSelect'))

**HUD layout (GAME-02):**
Modify `createHUD()` (line 226) to accept mobile detection:
- After existing HUD background drawing (lines 229-239), pass `isMobile` to `updateHUDText`

Modify `updateHUDText()` (line 248) to render conditionally:
- Add mobile detection: `const isMobile = width / getDpr() < 600;`
- Mobile: destroy existing hudText if any, create TWO text objects stored as class properties:
  - `this.hudText` (line 1): `Рівень ${this.currentLevel}  •  Ходи: ${moves}` at `hudY - cssToGame(8)`, font size `cssToGame(14)`, bold, color '#1A1A1A', origin 0.5
  - `this.hudGoalText` (line 2): goal text at `hudY + cssToGame(10)`, font size `cssToGame(11)`, color '#666666', origin 0.5
- Desktop: keep current single-line pattern (line 260 existing code)
- Add `private hudGoalText: Phaser.GameObjects.Text;` class property alongside `hudText`
- In `resetState()`, add `this.hudGoalText = null!;`

**Resize handler updates:**
In `handleResize()` (line 1559), update the HUD text repositioning block (lines 1596-1601):
- Add mobile detection: `const isMobile = width / getDpr() < 600;`
- If mobile and `this.hudGoalText` exists: reposition both lines (hudText at `hudY - cssToGame(8)`, hudGoalText at `hudY + cssToGame(10)`)
- If desktop: reposition hudText to center as current; if hudGoalText exists, destroy it (viewport changed from mobile to desktop)
- Destroy and recreate HUD text via `updateHUDText(width)` in resize handler for simplicity (call after repositioning hudBg)

Update back button repositioning block (lines 1603-1608):
- Detect mobile and use square dimensions for mobile (`cssToGame(36)`) vs existing layout dimensions for desktop
- Since button content changes (icon vs text), destroy and recreate: call `if (this.backButton) { this.backButton.destroy(); } this.createBackButton();` in resize handler
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run dev server, test on desktop (> 600px CSS width): back button shows "< Menu", HUD is single line.
Resize browser to < 600px CSS width: back button shows square "<", HUD splits to two lines.
  </verify>
  <done>
Mobile viewport (< 600px CSS) shows square icon-only "<" back button and two-line HUD (level+moves, goals). Desktop viewport shows original "< Menu" button and single-line HUD. Resize between viewports updates layout correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix LevelSelect resize handler viewport crash (GAME-04)</name>
  <files>src/scenes/LevelSelect.ts</files>
  <action>
The `handleResize()` method in LevelSelect.ts (line 566) calls `this.cameras.main.setViewport()` (line 573) without checking if the scene is active or if cameras.main exists. This causes a "Cannot read properties of undefined (reading 'setViewport')" crash during scene transitions.

Fix by adding a guard at the top of `handleResize()` (line 566, after `const { width, height } = gameSize;`):

```typescript
private handleResize(gameSize: Phaser.Structs.Size): void {
    const { width, height } = gameSize;

    // Guard: skip if scene is shutting down or camera not ready
    if (!this.scene.isActive() || !this.cameras?.main) return;

    // ... rest of existing code
}
```

Use `this.scene.isActive()` (Phaser built-in) instead of a custom `sceneActive` flag since LevelSelect doesn't have one and adding a flag would require modifying create() and shutdown(). The `this.cameras?.main` optional chain catches the case where cameras are destroyed.

No other changes needed — the shutdown handler (line 611) already removes the resize listener with `this.scale.off('resize', this.handleResize, this)`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Navigate between LevelSelect and Game scenes rapidly — no console errors about viewport undefined.
Resize browser while on LevelSelect — nodes reposition correctly without crash.
  </verify>
  <done>
LevelSelect handleResize has scene active + camera existence guard. No viewport undefined errors during scene transitions or rapid navigation.
  </done>
</task>

</tasks>

<verification>
1. Desktop browser (> 600px CSS): Game scene shows "< Menu" back button and single-line HUD — same as before
2. Mobile viewport (< 600px CSS): Game scene shows square "<" back button and two-line HUD (level+moves on top, smaller goal text below)
3. Resize from desktop to mobile: layout switches to mobile variant without errors
4. Resize from mobile to desktop: layout switches back to desktop variant without errors
5. Navigate LevelSelect → Game → LevelSelect rapidly: no viewport undefined errors in console
6. Resize browser while on LevelSelect: no crash, nodes reposition
</verification>

<success_criteria>
- Mobile back button is square with "<" only (no "Menu" text)
- Mobile HUD has two lines: level+moves (bold, 14px CSS) and goals (gray, 11px CSS)
- Desktop layout unchanged from current implementation
- No "Cannot read properties of undefined" errors in LevelSelect resize handler
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-game-screen-polish/21-01-SUMMARY.md`
</output>
