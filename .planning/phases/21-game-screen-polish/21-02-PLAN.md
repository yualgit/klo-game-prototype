---
phase: 21-game-screen-polish
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/scenes/Game.ts
autonomous: true

must_haves:
  truths:
    - "Game board width equals screen width minus 32px (16px padding each side), capped at 1024px CSS"
    - "Board height adjusts when board is too tall for viewport (e.g., 1366x768 laptop)"
    - "Tiles remain square (width and height equal) regardless of viewport constraints"
    - "Board is horizontally centered in viewport"
  artifacts:
    - path: "src/scenes/Game.ts"
      provides: "Board width constraint with padding and max-width cap"
      contains: "MAX_BOARD_WIDTH"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "src/utils/responsive.ts"
      via: "cssToGame for padding and max-width conversion"
      pattern: "cssToGame.*1024"
---

<objective>
Constrain the game board width to `min(viewport width - 32px padding, 1024px max)` and adjust height for narrow viewports.

Purpose: On mobile, the board should fill the screen with 16px padding on each side (GAME-03 requirement). On desktop, the board should not exceed 1024px CSS width. On narrow-height viewports (e.g., 1366x768 laptops), the board should scale down to fit vertically below the header+HUD area.

Output: Board width constraint with dynamic tile sizing that respects both width and height limits.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-game-screen-polish/21-01-SUMMARY.md
@src/scenes/Game.ts
@src/utils/responsive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Board width constraint with padding, max-width cap, and height adjustment</name>
  <files>src/scenes/Game.ts</files>
  <action>
Create a new private method `calculateConstrainedTileSize(width: number, height: number): number` in Game.ts that computes the tile size respecting both width and height constraints:

```typescript
private calculateConstrainedTileSize(width: number, height: number): number {
  // GAME-03: Board width = screen width - 32px padding (16px each side), max 1024px CSS
  const SIDE_PADDING = cssToGame(16); // 16px CSS each side
  const MAX_BOARD_CSS_WIDTH = 1024;
  const MAX_BOARD_WIDTH = cssToGame(MAX_BOARD_CSS_WIDTH);

  // Width constraint
  const availableWidth = width - (SIDE_PADDING * 2);
  const boardWidth = Math.min(availableWidth, MAX_BOARD_WIDTH);
  const tileSizeByWidth = Math.floor(boardWidth / this.gridWidth);

  // Height constraint: board must fit below header + HUD + padding
  const topSpace = cssToGame(50) + this.layout.hudHeight + cssToGame(10);
  const bottomPadding = cssToGame(20);
  const availableHeight = height - topSpace - bottomPadding;
  const tileSizeByHeight = Math.floor(availableHeight / this.gridHeight);

  // Use the more restrictive constraint (keeps tiles square)
  return Math.min(tileSizeByWidth, tileSizeByHeight);
}
```

**Modify `create()` (around lines 126-131):**
Replace the current grid offset calculation:
```typescript
// OLD:
const gridPixelWidth = this.gridWidth * this.layout.tileSize;
const gridPixelHeight = this.gridHeight * this.layout.tileSize;
this.gridOffsetX = (width - gridPixelWidth) / 2;
this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10);
```
With:
```typescript
// NEW: Apply board width constraint (GAME-03)
this.layout.tileSize = this.calculateConstrainedTileSize(width, height);
const gridPixelWidth = this.gridWidth * this.layout.tileSize;
this.gridOffsetX = (width - gridPixelWidth) / 2;
this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10);
```

**Modify `handleResize()` (around lines 1571-1574):**
Replace the current grid recalculation:
```typescript
// OLD:
const gridPixelWidth = this.gridWidth * this.layout.tileSize;
this.gridOffsetX = (width - gridPixelWidth) / 2;
this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10);
```
With:
```typescript
// NEW: Reapply board width constraint
this.layout.tileSize = this.calculateConstrainedTileSize(width, height);
const gridPixelWidth = this.gridWidth * this.layout.tileSize;
this.gridOffsetX = (width - gridPixelWidth) / 2;
this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10);
```

This ensures:
- Board width never exceeds viewport width - 32px (16px each side)
- Board width never exceeds 1024px CSS
- Board height fits below header+HUD with bottom padding
- Tiles remain square (same tile size for both width and height)
- Board is horizontally centered via `(width - gridPixelWidth) / 2`
- On resize, constraints are recalculated and board repositions correctly
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.

Test scenarios:
1. Desktop (1920x1080): Board width should be capped at 1024px CSS (tiles = 1024/8 = 128px CSS max, but also constrained by getResponsiveLayout's 60px max — the constraint takes the minimum)
2. Mobile (375x667): Board width = 375 - 32 = 343px, tiles = 343/8 = ~42px CSS — fits with padding
3. Laptop (1366x768): Board height limited by available height below header — tiles scale down if needed
4. Resize between viewports: board recenters and rescales correctly
5. All tile touch targets remain functional (tap and swipe)
  </verify>
  <done>
Game board width = min(viewport width - 32px, 1024px CSS). Board height adjusts for narrow viewports. Tiles are square and centered. Board reflows on resize.
  </done>
</task>

</tasks>

<verification>
1. Mobile (375px CSS): Board has 16px padding each side, tiles are ~42px
2. Tablet (768px CSS): Board fits within 768 - 32 = 736px, tiles scale appropriately
3. Desktop (1200px CSS): Board capped at 1024px, centered with (1200-1024)/2 = 88px margins
4. Laptop narrow height (1366x768): Board scales down vertically to fit below header+HUD
5. Resize from desktop to mobile: board shrinks with padding constraint, remains centered
6. All levels (L1-L10) playable with constrained board — tiles tappable, swipe works
</verification>

<success_criteria>
- Board width = screen width - 32px on mobile (< 1024px CSS viewport)
- Board width capped at 1024px CSS on wider viewports
- Board height adjusts on narrow-height viewports (tiles shrink to fit)
- Tiles remain square (not stretched)
- Board horizontally centered in all viewports
- Resize recalculates constraints correctly
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-game-screen-polish/21-02-SUMMARY.md`
</output>
