---
phase: 23-tile-system-refactor
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/scenes/Boot.ts
  - src/scenes/Game.ts
  - src/game/Match3Engine.test.ts
autonomous: true

must_haves:
  truths:
    - "All 9 tile types (burger, coffee, fuel_can, hotdog, oil, snack, soda, water, wheel) have their PNG assets loaded in Boot.ts"
    - "Board spawning works with all 9 tile types when spawn_rules includes them"
    - "Matching logic works with all 9 tile types"
    - "Game.ts has no hardcoded tile type casts — uses config-derived types"
    - "Existing levels continue to work unchanged (backward compatible)"
  artifacts:
    - path: "src/scenes/Boot.ts"
      provides: "Dynamic tile asset loading from TILE_CONFIG"
      contains: "TILE_CONFIG"
    - path: "src/scenes/Game.ts"
      provides: "Cleaned up tile type references, no hardcoded casts"
    - path: "src/game/Match3Engine.test.ts"
      provides: "Test SpawnRules updated for dynamic types"
  key_links:
    - from: "src/scenes/Boot.ts"
      to: "src/game/tileConfig.ts"
      via: "Iterates TILE_CONFIG to load all tile textures"
      pattern: "TILE_CONFIG"
    - from: "src/scenes/Game.ts"
      to: "src/game/tileConfig.ts"
      via: "Uses TileTypeId for type-safe tile references"
      pattern: "TileTypeId|TILE_CONFIG"
---

<objective>
Wire up all 9 tile types by loading missing assets in Boot.ts, cleaning up hardcoded type casts in Game.ts, and updating tests to use config-driven SpawnRules.

Purpose: Complete the tile system refactor so all 9 tile types render correctly and the system is fully data-driven (TSYS-03).
Output: All 9 tiles load, render, match, and spawn correctly. No hardcoded tile type casts remain.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-tile-system-refactor/23-01-SUMMARY.md

@src/scenes/Boot.ts
@src/scenes/Game.ts
@src/game/tileConfig.ts
@src/game/Match3Engine.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dynamic tile asset loading in Boot.ts and clean up Game.ts casts</name>
  <files>src/scenes/Boot.ts, src/scenes/Game.ts</files>
  <action>
**Boot.ts changes:**

Replace the 6 hardcoded tile image load lines:
```ts
this.load.image('tile_burger', 'assets/tiles/burger.png');
this.load.image('tile_hotdog', 'assets/tiles/hotdog.png');
this.load.image('tile_oil', 'assets/tiles/oil.png');
this.load.image('tile_water', 'assets/tiles/water.png');
this.load.image('tile_snack', 'assets/tiles/snack.png');
this.load.image('tile_soda', 'assets/tiles/soda.png');
```

With a dynamic loop:
```ts
import { TILE_CONFIG } from '../game/tileConfig';

// --- Load tile sprites (from config) ---
for (const [, entry] of Object.entries(TILE_CONFIG)) {
  this.load.image(entry.textureKey, entry.assetPath);
}
```

This automatically loads all 9 tile assets including the 3 new ones (coffee, fuel_can, wheel).

**Game.ts changes:**

Clean up ALL hardcoded tile type casts. There are several locations where `as 'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda'` is used. These should be replaced with `as TileTypeId` (imported from tileConfig).

Specific locations to fix (search for these patterns):

1. Around line 1012: `const tileType = (tileData.type === 'empty' ? 'burger' : tileData.type) as 'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda';`
   Replace with: `const tileType = (tileData.type === 'empty' ? 'burger' : tileData.type) as TileTypeId;`

2. Around line 1448: `const baseType = (boosterSpawn.baseType === 'empty' ? 'burger' : boosterSpawn.baseType) as 'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda';`
   Replace with: `const baseType = (boosterSpawn.baseType === 'empty' ? 'burger' : boosterSpawn.baseType) as TileTypeId;`

3. Around line 1569: `const tileType = (spawn.type === 'empty' ? 'burger' : spawn.type) as 'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda';`
   Replace with: `const tileType = (spawn.type === 'empty' ? 'burger' : spawn.type) as TileTypeId;`

4. Around line 1746: `const tileType = (tileData.type === 'empty' ? 'burger' : tileData.type) as 'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda';`
   Replace with: `const tileType = (tileData.type === 'empty' ? 'burger' : tileData.type) as TileTypeId;`

Add import at top of Game.ts: `import { TileTypeId } from '../game/tileConfig';`

Also check line ~1514 where `TILE_COLORS[tileData.type as keyof typeof TILE_COLORS]` is used — this should work as-is since TILE_COLORS is now `Record<TileTypeId, number>`, but verify the cast is still valid.

IMPORTANT: Keep `'burger'` as the fallback for empty tiles — this is a rendering safety net, not a type system issue.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify Boot.ts loads all 9 tile textures. Verify Game.ts has no remaining hardcoded tile type union casts (`grep` for `'burger' | 'hotdog'` should return 0 results in Game.ts).
  </verify>
  <done>
Boot.ts dynamically loads all 9 tile textures from TILE_CONFIG. Game.ts uses TileTypeId for all tile type casts. No hardcoded 6-type unions remain in Game.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test SpawnRules and verify all tests pass</name>
  <files>src/game/Match3Engine.test.ts</files>
  <action>
Update the `defaultSpawnRules` constant in `Match3Engine.test.ts` to include all 9 tile types. Currently it has:
```ts
const defaultSpawnRules: SpawnRules = {
  burger: 0.167,
  hotdog: 0.167,
  oil: 0.167,
  water: 0.167,
  snack: 0.166,
  soda: 0.166,
};
```

Since `SpawnRules` is now `Partial<Record<TileTypeId, number>>`, the existing 6-type object should still be valid without changes. However, to fully exercise all 9 types and confirm they work:

1. If `SpawnRules` requires ALL keys (if plan 23-01 used `Record` not `Partial<Record>`), then add the 3 missing keys with weight 0 or small weights. Adjust existing weights so they still sum to ~1.0.

2. If `SpawnRules` is `Partial<Record>`, the existing tests work as-is. But add a NEW test case that verifies spawning works with all 9 types:

```ts
it('should spawn tiles from all 9 types when all are in spawn rules', () => {
  const nineTypeRules: SpawnRules = {
    burger: 0.12,
    coffee: 0.11,
    fuel_can: 0.11,
    hotdog: 0.11,
    oil: 0.11,
    snack: 0.11,
    soda: 0.11,
    water: 0.11,
    wheel: 0.11,
  };
  engine.generateGrid(nineTypeRules);
  const grid = engine.getGrid();
  const typesFound = new Set<string>();
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      typesFound.add(grid[row][col].type);
    }
  }
  // With 64 cells and 9 types, we expect most types to appear
  // At minimum, more than the original 6 should be possible
  expect(typesFound.size).toBeGreaterThanOrEqual(5);
});
```

Also check that imports in test file use the updated types. If the test file imports `SpawnRules` from `./types`, it should work since types.ts re-exports the new definition.

IMPORTANT: Do NOT change any test assertions for existing tests — they should pass as-is since the engine behavior hasn't changed for 6-type boards.
  </action>
  <verify>
Run `npx vitest run` — all existing tests pass AND new test passes. Verify no type errors: `npx tsc --noEmit`.
  </verify>
  <done>
All existing Match3Engine tests pass. New test confirms all 9 tile types work with spawn/match logic. No type errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors
2. `npx vitest run` passes — all tests green (existing + new 9-type test)
3. Boot.ts loads exactly 9 tile textures via TILE_CONFIG loop
4. No `'burger' | 'hotdog' | 'oil' | 'water' | 'snack' | 'soda'` hardcoded casts remain in Game.ts
5. Level 1 JSON (with 6-type spawn_rules) still works — backward compatible
6. 9-type spawn_rules produces valid boards with all tile types rendering
</verification>

<success_criteria>
- All 9 tile types (burger, coffee, fuel_can, hotdog, oil, snack, soda, water, wheel) render correctly with their sprites
- Board spawning and matching logic work with all 9 configured tile types
- No hardcoded tile type casts remain in Game.ts
- Existing levels work unchanged (backward compatible)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-tile-system-refactor/23-02-SUMMARY.md`
</output>
