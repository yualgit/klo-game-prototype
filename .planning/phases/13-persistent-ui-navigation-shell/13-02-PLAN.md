---
phase: 13-persistent-ui-navigation-shell
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/scenes/LevelSelect.ts
  - src/scenes/Game.ts
  - src/scenes/Collections.ts
  - src/scenes/Shop.ts
  - src/scenes/index.ts
  - src/main.ts
autonomous: false

must_haves:
  truths:
    - "Bottom nav with 3 tabs appears on LevelSelect and Collections screens"
    - "Tapping a tab navigates to the corresponding scene with UIScene restarted showing correct active tab"
    - "Global header displays current lives count, bonuses count, and settings button on all screens including gameplay"
    - "During gameplay, bottom nav is hidden but global header remains visible"
    - "Lives/bonuses values update immediately when economy state changes"
    - "Settings overlay opens from gear icon in header on any screen"
  artifacts:
    - path: "src/scenes/Collections.ts"
      provides: "Collections stub scene with UIScene launch"
      contains: "class Collections"
    - path: "src/scenes/Shop.ts"
      provides: "Shop stub scene with UIScene launch"
      contains: "class Shop"
    - path: "src/scenes/index.ts"
      provides: "Updated barrel export including UIScene, Collections, Shop"
      contains: "UIScene"
    - path: "src/main.ts"
      provides: "Updated Phaser config with all new scenes registered"
      contains: "UIScene"
  key_links:
    - from: "src/scenes/LevelSelect.ts"
      to: "src/scenes/UIScene.ts"
      via: "scene.launch('UIScene', { currentTab: 'levels' })"
      pattern: "scene\\.launch\\('UIScene'"
    - from: "src/scenes/Game.ts"
      to: "src/scenes/UIScene.ts"
      via: "scene.launch('UIScene', { showBottomNav: false })"
      pattern: "scene\\.launch\\('UIScene'"
    - from: "src/scenes/UIScene.ts"
      to: "src/scenes/LevelSelect.ts"
      via: "eventsCenter 'navigate-to' event triggers scene.start"
      pattern: "navigate-to"
---

<objective>
Integrate the UIScene into all game scenes: LevelSelect launches UIScene with full nav, Game launches UIScene with header-only mode, and stub Collections/Shop scenes enable tab navigation. Remove duplicate HUD elements from LevelSelect.

Purpose: Wire up the complete navigation shell so users can switch between tabs and see consistent header across all screens.

Output: Updated LevelSelect, Game, new Collections/Shop stubs, updated scene registration
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-persistent-ui-navigation-shell/13-RESEARCH.md
@.planning/phases/13-persistent-ui-navigation-shell/13-01-SUMMARY.md
@src/scenes/LevelSelect.ts
@src/scenes/Game.ts
@src/scenes/Menu.ts
@src/scenes/index.ts
@src/main.ts
@src/utils/EventsCenter.ts
@src/scenes/UIScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate UIScene into LevelSelect, create stub scenes, wire navigation</name>
  <files>src/scenes/LevelSelect.ts, src/scenes/Collections.ts, src/scenes/Shop.ts, src/scenes/index.ts, src/main.ts</files>
  <action>
  **LevelSelect.ts modifications:**
  1. Import eventsCenter from `../utils/EventsCenter`
  2. In `create()`, AFTER all existing setup, add: `this.scene.launch('UIScene', { currentTab: 'levels', showBottomNav: true, showHeader: true })`
  3. **Remove duplicate HUD elements** that are now in UIScene:
     - Remove `createEconomyHUD()` call and method entirely (lives/bonuses/countdown now in UIScene header)
     - Remove `createSettingsButton()` call and method entirely (settings gear now in UIScene header)
     - Remove the `timerEvent` property and its cleanup (economy timer now in UIScene)
     - Remove `livesText`, `bonusText`, `countdownText`, `heartIcon`, `bonusIcon`, `settingsIcon` properties
     - Remove `updateEconomyDisplay()` method
     - Remove `repositionEconomyHUD()` method
     - Remove economy HUD repositioning from `handleResize()`
     - Remove settings icon repositioning from `handleResize()`
     - Keep: `hudBg`, `titleText` (the "Оберіть рівень" header bar), back button
  4. Listen for eventsCenter 'navigate-to' event:
     ```typescript
     eventsCenter.on('navigate-to', this.handleNavigation, this);
     ```
  5. Add `handleNavigation(target: string)` method:
     - `this.scene.stop('UIScene');`
     - Switch on target: 'levels' (already here, no-op), 'collections' -> `this.scene.start('Collections')`, 'shop' -> `this.scene.start('Shop')`
  6. Listen for eventsCenter 'open-settings' event -> call existing `showSettingsOverlay()` method
  7. In `shutdown()`: add `eventsCenter.off('navigate-to', this.handleNavigation, this)` and `eventsCenter.off('open-settings')`. Also stop UIScene: `this.scene.stop('UIScene')`.
  8. **Adjust HUD bar height** to account for UIScene header: The existing HUD bar with "Оберіть рівень" title stays, but position it BELOW the UIScene header. Set its Y to `cssToGame(50)` (UIScene header height). Update camera bounds to start below both bars. OR — simpler approach: Remove the LevelSelect HUD bar entirely (title text "Оберіть рівень" is redundant with the tab label showing "Рівні" in bottom nav). Just keep the back button and reposition it. The UIScene header already has economy info and settings.

  **Simplification decision:** Remove the entire LevelSelect HUD bar (hudBg + titleText). The UIScene header provides economy info + settings. The back button moves to the UIScene header area or stays in LevelSelect at a new position (below UIScene header). Keep the back "< Меню" button at position Y = cssToGame(50) + cssToGame(10) (just below UIScene header) as a small floating button.

  **Collections.ts (new stub scene):**
  Create `src/scenes/Collections.ts`:
  ```typescript
  export class Collections extends Phaser.Scene {
    constructor() { super({ key: 'Collections' }); }
    create(): void {
      const width = this.cameras.main.width;
      const height = this.cameras.main.height;
      // Simple background
      const bg = this.add.graphics();
      bg.fillGradientStyle(0xF9F9F9, 0xF9F9F9, 0xFFF5E0, 0xFFF5E0, 1);
      bg.fillRect(0, 0, width, height);
      // "Coming in Phase 14" placeholder text
      const text = this.add.text(width/2, height/2, 'Колекції\n(Скоро)', {
        fontFamily: 'Arial, sans-serif',
        fontSize: `${cssToGame(24)}px`,
        color: '#999999',
        align: 'center',
      });
      text.setOrigin(0.5);
      // Launch UIScene with collections tab active
      this.scene.launch('UIScene', { currentTab: 'collections', showBottomNav: true });
      // Listen for navigation
      eventsCenter.on('navigate-to', this.handleNavigation, this);
      eventsCenter.on('open-settings', this.showSettings, this);
      this.scale.on('resize', this.handleResize, this);
      this.events.once('shutdown', () => {
        eventsCenter.off('navigate-to', this.handleNavigation, this);
        eventsCenter.off('open-settings', this.showSettings, this);
        this.scale.off('resize', this.handleResize, this);
        this.scene.stop('UIScene');
      });
    }
    // handleNavigation, handleResize, showSettings (placeholder — opens settings overlay same as LevelSelect pattern)
  }
  ```
  The settings overlay in Collections can be a simplified version — just call the same pattern as LevelSelect's showSettingsOverlay. For the stub, a simple "Settings not available here" message is fine — OR better, extract the settings overlay to a shared utility. For now, keep it simple: just emit and let each scene decide. Since UIScene emits 'open-settings', and Collections is a stub, it can show a basic modal or do nothing for now. Phase 14 will flesh out Collections properly.

  **Shop.ts (new stub scene):**
  Same pattern as Collections but with 'shop' tab and "Магазин (Скоро)" placeholder text.

  **index.ts update:**
  Add exports: `export { UIScene } from './UIScene';` and `export { Collections } from './Collections';` and `export { Shop } from './Shop';`

  **main.ts update:**
  1. Update import: `import { Boot, Menu, LevelSelect, Game, UIScene, Collections, Shop } from './scenes';`
  2. Add new scenes to config: `scene: [Boot, Menu, LevelSelect, Game, UIScene, Collections, Shop]`

  **CSS safe area setup (if not already done):**
  Check `index.html` for viewport-fit=cover meta tag. If missing, add it. Check for CSS custom properties mapping env() safe area values. If the project already has safe area CSS from Phase 12, verify it's compatible.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify no type errors across all modified files. Run `npm run dev` and verify in browser that:
  1. LevelSelect shows UIScene header at top with lives/bonuses/settings
  2. Bottom nav shows 3 tabs with "Рівні" highlighted
  3. Clicking "Колекції" tab navigates to Collections stub
  4. Clicking "Рівні" tab navigates back to LevelSelect
  5. Settings gear in header opens settings overlay
  </verify>
  <done>
  LevelSelect launches UIScene with full header + bottom nav. Duplicate HUD removed from LevelSelect. Collections and Shop stub scenes exist and are navigable via bottom nav tabs. Scene transitions work correctly with UIScene stop/relaunch. All scenes registered in main.ts config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate UIScene header-only mode into Game scene</name>
  <files>src/scenes/Game.ts</files>
  <action>
  Modify `src/scenes/Game.ts` to launch UIScene in header-only mode (no bottom nav) during gameplay.

  1. Import eventsCenter: `import eventsCenter from '../utils/EventsCenter';`
  2. In `create()`, after existing setup (after `this.scale.on('resize', ...)`), add:
     ```typescript
     // Launch UIScene with header only (no bottom nav during gameplay)
     this.scene.launch('UIScene', {
       currentTab: 'levels',  // Not relevant since nav hidden
       showBottomNav: false,
       showHeader: true,
     });
     ```
  3. **Adjust grid offset Y** to account for UIScene header: The game's own HUD (moves/goals display) should be positioned BELOW the UIScene header. Currently `this.gridOffsetY = this.layout.hudHeight + cssToGame(10)`. The UIScene header is `cssToGame(50)` tall. The game's own HUD is `this.layout.hudHeight` (cssToGame(60)). Total offset from top = UIScene header + game HUD + padding.

     Update: `this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10)`. This means the UIScene header sits at top, the game HUD (moves/goals) sits below it, and the grid starts below both.

     Also update `createHUD()` to position the game HUD bar at Y = cssToGame(50) instead of Y = 0:
     - `this.hudBg.fillRoundedRect(padding * 2, cssToGame(50) + padding * 2, width - padding * 4, this.layout.hudHeight - padding * 4, cssToGame(4))`
     - HUD text Y: `cssToGame(50) + this.layout.hudHeight / 2`
     - KLO stripe Y: `cssToGame(50) + padding * 3`

  4. Update `createBackButton()`: Position Y below UIScene header: `const buttonY = cssToGame(50) + this.layout.hudHeight / 2` (centers within game HUD area).

  5. Listen for 'open-settings' from eventsCenter to show settings (Game scene may or may not need settings during gameplay — for now, don't handle it in Game scene since players are focused on gameplay. The gear icon in UIScene header can just be hidden or non-functional during gameplay. OR: UIScene can conditionally hide the settings gear when showBottomNav=false. Simplest: leave it visible but let Game handle the event with a no-op or a simple pause overlay).

     Decision: In Game scene, listen for 'open-settings' and do nothing (gameplay focus). The settings button will still be visible in header but clicking it during gameplay will have no effect. This is acceptable for demo.

  6. In the shutdown handler (already has `this.events.once('shutdown', () => { ... })`), add: `this.scene.stop('UIScene');`

  7. Update `handleResize()` method:
     - Recalculate gridOffsetY with UIScene header offset: `this.gridOffsetY = cssToGame(50) + this.layout.hudHeight + cssToGame(10)`
     - Update HUD background redraw to account for Y offset of cssToGame(50)
     - Update HUD text position to include cssToGame(50) offset

  8. In the win/lose overlay methods: overlays should appear ABOVE the UIScene (depth 300+ since UIScene uses 200+). Check existing overlay depths and ensure they're higher. If existing overlays use depth ~100, increase to 300+.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify no type errors. Run `npm run dev`, navigate to a level, and verify:
  1. UIScene header is visible at top during gameplay (shows lives/bonuses)
  2. Bottom nav is NOT visible during gameplay
  3. Game HUD (moves/goals) appears below the UIScene header
  4. Grid is properly positioned below both headers
  5. Win/lose overlays appear above everything
  6. Going back to LevelSelect restores full UIScene with bottom nav
  </verify>
  <done>
  Game scene launches UIScene in header-only mode. Game HUD (moves/goals) positioned below UIScene header. Grid offset adjusted. Bottom nav hidden during gameplay. Win/lose overlays render above UIScene. Transitions back to LevelSelect restore full nav.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of navigation shell</name>
  <files>none (verification only)</files>
  <action>
  Human verifies the complete persistent UI navigation shell:
  - Global header with lives, bonuses, countdown, and settings button
  - Bottom nav with 3 tabs (Levels/Collections/Shop)
  - Header visible during gameplay, bottom nav hidden
  - Tab navigation between LevelSelect, Collections (stub), and Shop (stub)
  - Reactive economy updates in header

  Steps:
  1. Run `npm run dev` and open in browser
  2. From Menu, tap Play to go to LevelSelect
  3. Verify: Header at top shows heart + lives count, diamond + bonuses count, gear icon
  4. Verify: Bottom nav shows 3 tabs — "Рівні" highlighted in yellow/gold, "Колекції" and "Магазин" dimmed gray
  5. Tap "Колекції" tab — verify navigation to Collections stub page, "Колекції" tab now highlighted
  6. Tap "Рівні" tab — verify navigation back to LevelSelect, "Рівні" tab highlighted
  7. Tap "Магазин" tab — verify navigation to Shop stub page
  8. Start a level from LevelSelect — verify: header still visible with lives/bonuses, bottom nav HIDDEN, game HUD (moves/goals) visible below header
  9. Complete or lose the level — verify: overlay appears correctly above header
  10. Return to LevelSelect — verify: bottom nav reappears with "Рівні" active
  11. Test on mobile viewport (Chrome DevTools device mode, iPhone SE 375x667) — verify no overlap or cropping
  </action>
  <verify>Human confirms all 11 verification steps pass. Type "approved" or describe issues to fix.</verify>
  <done>All navigation shell features visually verified: header, bottom nav, tab switching, gameplay mode, overlays, and mobile viewport.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. LevelSelect shows UIScene header + bottom nav with "Рівні" active
3. Tab navigation works: Levels -> Collections -> Shop and back
4. Game scene shows UIScene header only (no bottom nav)
5. Game grid positioned correctly below both headers
6. Win/lose overlays visible above UIScene elements
7. Settings gear opens settings overlay from LevelSelect
8. Lives/bonuses update reactively (no manual refresh needed)
9. Works on mobile viewport (iPhone SE 375x667, no overlap)
</verification>

<success_criteria>
- Bottom nav with 3 tabs appears on LevelSelect and Collections screens
- Active tab highlighted in yellow/gold, inactive tabs dimmed gray
- Global header displays lives, bonuses, settings button on all screens
- During gameplay: header visible, bottom nav hidden
- Tab navigation works between all registered scenes
- Economy values update immediately on state change
- No layout breaks on mobile viewports
</success_criteria>

<output>
After completion, create `.planning/phases/13-persistent-ui-navigation-shell/13-02-SUMMARY.md`
</output>
