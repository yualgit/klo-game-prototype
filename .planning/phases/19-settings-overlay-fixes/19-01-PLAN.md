---
phase: 19-settings-overlay-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scenes/UIScene.ts
  - src/scenes/LevelSelect.ts
  - src/scenes/Collections.ts
  - src/scenes/Shop.ts
autonomous: true

must_haves:
  truths:
    - "Settings overlay text and elements fit mobile screen without clipping (panel width capped at 90% viewport, height auto-adjusts)"
    - "Settings overlay renders above header and bottom navigation (depth 300+ vs UIScene depth 200)"
    - "Only one settings overlay can be open at a time (tapping gear while open does nothing)"
    - "Settings overlay opens without crash from LevelSelect, Game, Collections, and Shop pages"
  artifacts:
    - path: "src/scenes/UIScene.ts"
      provides: "Settings overlay implementation with mobile scaling, z-order fix, singleton guard"
      contains: "showSettingsOverlay"
    - path: "src/scenes/LevelSelect.ts"
      provides: "Cleaned up - no more settings overlay code or open-settings event handler"
    - path: "src/scenes/Collections.ts"
      provides: "Cleaned up - no more open-settings event handler"
    - path: "src/scenes/Shop.ts"
      provides: "Cleaned up - no more open-settings event handler"
  key_links:
    - from: "src/scenes/UIScene.ts"
      to: "SettingsManager"
      via: "registry.get('settings')"
      pattern: "registry\\.get\\('settings'\\)"
    - from: "src/scenes/UIScene.ts settingsButton"
      to: "src/scenes/UIScene.ts showSettingsOverlay"
      via: "direct method call (no more eventsCenter hop)"
      pattern: "showSettingsOverlay"
---

<objective>
Move the settings overlay from LevelSelect into UIScene so it works reliably from any screen with correct z-ordering, mobile scaling, and singleton protection.

Purpose: Currently, the settings overlay only works from LevelSelect (depth 100-103, below UIScene header at depth 200+). Collections, Shop, and Game scenes either stub-log or don't handle the event at all, causing crashes or no-ops. Moving the overlay into UIScene (which runs in parallel with ALL content scenes) solves all 4 requirements in one change.

Output: Settings overlay owned by UIScene, accessible from any screen, rendering above all UI, with mobile-responsive sizing and duplicate protection.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/scenes/UIScene.ts
@src/scenes/LevelSelect.ts
@src/scenes/Collections.ts
@src/scenes/Shop.ts
@src/game/SettingsManager.ts
@src/utils/responsive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings overlay to UIScene with mobile scaling, z-order, and singleton guard</name>
  <files>src/scenes/UIScene.ts</files>
  <action>
Add the settings overlay directly to UIScene. This replaces the eventsCenter-based pattern where each scene handled 'open-settings' independently.

**1. Add imports:**
- Import `SettingsManager` from `../game/SettingsManager`
- Import `GUI_TEXTURE_KEYS` from `../game/constants`

**2. Add class properties:**
- `private settingsOpen: boolean = false;` (singleton guard)
- `private settingsOverlayElements: Phaser.GameObjects.GameObject[] = [];` (cleanup array)

**3. Change settings button click handler** (in createHeader):
Replace `eventsCenter.emit('open-settings')` with direct call to `this.showSettingsOverlay()`.

**4. Add showSettingsOverlay() method** (port from LevelSelect.ts with fixes):

The method must:
a) **Singleton guard**: If `this.settingsOpen` is true, return immediately.
b) **Set guard**: `this.settingsOpen = true;`
c) **Use UIScene camera dimensions**: `this.cameras.main.width` and `this.cameras.main.height` (UIScene always has valid cameras since it runs in parallel).
d) **Z-order**: All overlay elements use depth 300+ (above UIScene header at 200 and content scene overlays at up to 300).
   - Backdrop: depth 300
   - Panel: depth 301
   - Text/labels: depth 302
   - Toggle backgrounds/thumbs/hit areas: depth 302-303
   - Close button: depth 302
e) **Mobile-responsive sizing**:
   - Panel width: `Math.min(cssToGame(340), width * 0.85)` (slightly tighter than 0.9 to account for UIScene running at same viewport)
   - Panel height: `cssToGame(340)` (reduced from 380 to fit better on small screens; controls are spaced tighter)
   - Toggle/slider element sizes: use cssToGame() for all measurements (already the pattern)
   - Font sizes: labels at `cssToGame(15)` (slightly smaller than 16 to ensure fit), title at `cssToGame(22)` (reduced from 24)
   - Adjust row spacing: SFX at panelY + cssToGame(80), Volume at panelY + cssToGame(145), Animation at panelY + cssToGame(210), Close at panelY + cssToGame(280)
f) **Backdrop**: full screen, 0x000000 at 0.7 alpha, interactive (blocks clicks), depth 300. On pointerup: close overlay.
g) **Panel**: white (0xF9F9F9) rounded rect, centered, interactive (blocks click-through to backdrop), depth 301.
h) **Title**: "Налаштування", centered, bold, depth 302.
i) **SFX Toggle**: Label "Звукові ефекти" + toggle switch (green/gray background, white thumb, animated). Uses mutable local `let sfxEnabled = settings.get('sfxEnabled')`. Toggle hit area at depth 303.
j) **Volume Slider**: Label "Гучність" + draggable slider. Track 0xDDDDDD, fill 0xFFB800, thumb white with orange stroke. Uses `this.input.setDraggable()`.
k) **Animation Toggle**: Label "Анімації бустерів" + toggle switch (same pattern as SFX).
l) **Close button**: Create a simple text button (no need for LevelSelect's createOverlayButton since UIScene doesn't have GUI button textures loaded for that purpose). Use a styled text "Закрити" with background rect, interactive, centered below controls. On click: close overlay.
   - Actually, since GUI textures ARE loaded globally (they're loaded in Boot scene), use the same pattern: `this.add.image(x, y, 'gui_button_yellow')` with text overlay.
   - The button should be: image with `GUI_TEXTURE_KEYS.buttonYellow`, display size cssToGame(140) x cssToGame(36), with "Закрити" text on top. Wrap in container, setInteractive, depth 302.

**5. Add closeSettingsOverlay() method:**
- Destroy all elements in `this.settingsOverlayElements`
- Clear the array
- Set `this.settingsOpen = false`

**6. Update destroyAllElements():**
- Call `this.closeSettingsOverlay()` to clean up settings overlay if open during resize.

**7. Update onShutdown():**
- Call `this.closeSettingsOverlay()` to clean up settings overlay on scene shutdown.

**Key difference from LevelSelect implementation:** No `overlayActive` flag needed for scroll blocking since UIScene doesn't scroll. The `settingsOpen` flag is purely for singleton guard.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root to verify no TypeScript errors.
Run `npx vite build` to verify production build succeeds.
Grep for `showSettingsOverlay` in UIScene.ts to confirm method exists.
Grep for `settingsOpen` in UIScene.ts to confirm singleton guard exists.
Grep for `depth.*300` in UIScene.ts to confirm z-order fix.
  </verify>
  <done>
UIScene.ts contains showSettingsOverlay() with:
- Singleton guard (settingsOpen flag)
- All overlay elements at depth 300+
- Mobile-responsive panel sizing (capped at 85% viewport width)
- Functional SFX toggle, volume slider, animation toggle
- Close button and backdrop-click-to-close
- Clean teardown via closeSettingsOverlay()
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove settings overlay code from content scenes</name>
  <files>src/scenes/LevelSelect.ts, src/scenes/Collections.ts, src/scenes/Shop.ts</files>
  <action>
Since the settings overlay is now owned by UIScene, remove all per-scene settings handling:

**LevelSelect.ts:**
1. Remove `import { SettingsManager } from '../game/SettingsManager';` (only if no other usage remains -- check first; SettingsManager is only used in showSettingsOverlay, so safe to remove).
2. Remove the entire `showSettingsOverlay()` method (~250 lines, from line ~539 to ~794).
3. Remove `eventsCenter.on('open-settings', this.showSettingsOverlay, this);` from create() (line ~109).
4. Remove `eventsCenter.off('open-settings', this.showSettingsOverlay, this);` from shutdown() (line ~821).
5. Keep the `overlayActive` property and its usage for the level-info/refill overlay (it's used for those overlays too, not just settings).

**Collections.ts:**
1. Remove `eventsCenter.on('open-settings', this.showSettings, this);` from create().
2. Remove `eventsCenter.off('open-settings', this.showSettings, this);` from shutdown.
3. Remove the `private showSettings` method entirely.

**Shop.ts:**
1. Remove `eventsCenter.on('open-settings', this.showSettings, this);` from create().
2. Remove `eventsCenter.off('open-settings', this.showSettings, this);` from shutdown.
3. Remove the `private showSettings` method entirely.

**Note:** Game.ts already does NOT handle 'open-settings', so no changes needed there. The fix for SETT-04 (crash on game page) is inherently solved by UIScene owning the overlay -- UIScene always has valid cameras.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors after removal.
Run `npx vite build` to verify production build.
Grep for `open-settings` across all scene files -- should only appear in UIScene.ts (in the old eventsCenter.emit line, which is now replaced with direct call). Actually it should appear NOWHERE since we replaced with direct method call.
Grep for `showSettingsOverlay` in LevelSelect.ts -- should return no matches.
Grep for `showSettings` in Collections.ts and Shop.ts -- should return no matches.
  </verify>
  <done>
- LevelSelect.ts no longer contains settings overlay code (~250 lines removed)
- Collections.ts no longer handles open-settings event
- Shop.ts no longer handles open-settings event
- No scene listens for 'open-settings' eventsCenter event anymore
- All scenes work without settings-related crashes
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vite build` succeeds
3. Settings overlay opens from any screen (LevelSelect, Game, Collections, Shop) via UIScene gear button
4. Settings overlay renders ABOVE header and bottom nav (depth 300+ vs 200)
5. Tapping gear while overlay is open does nothing (singleton guard)
6. Settings overlay fits on mobile without clipping (panel width capped at 85% viewport)
7. SFX toggle, volume slider, and animation toggle all function correctly
8. Backdrop click and Close button both dismiss overlay
9. No 'open-settings' eventsCenter listeners remain in content scenes
</verification>

<success_criteria>
- Settings overlay accessible from ALL screens via UIScene header gear button
- Overlay renders above all other UI elements (z-order correct)
- Only one overlay instance possible at any time
- Panel and controls fit mobile viewports without clipping
- All settings controls (SFX toggle, volume slider, animation toggle) functional
- Clean overlay lifecycle (all elements destroyed on close)
</success_criteria>

<output>
After completion, create `.planning/phases/19-settings-overlay-fixes/19-01-SUMMARY.md`
</output>
