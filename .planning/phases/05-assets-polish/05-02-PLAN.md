---
phase: 05-assets-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/scenes/Game.ts
  - src/game/VFXManager.ts
autonomous: true

must_haves:
  truths:
    - "Tiles pop with particle burst when matched"
    - "Booster activation shows dramatic visual effects (line sweep, explosion radius, color wave)"
    - "Sound effects play on match, booster activation, win, and lose"
    - "Tile swap has small bounce animation"
    - "New tiles falling have bounce-land effect"
    - "Cascade shows escalating effects: depth 1 (small pop), depth 2+ (larger), depth 4+ (screen shake)"
  artifacts:
    - path: "src/game/VFXManager.ts"
      provides: "Particle emitter pool for match/booster/confetti effects"
      contains: "class VFXManager"
    - path: "src/scenes/Game.ts"
      provides: "Integrated VFX and audio into cascade flow"
      contains: "vfxManager"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "src/game/VFXManager.ts"
      via: "VFXManager instance methods"
      pattern: "this\\.vfxManager\\."
    - from: "src/scenes/Game.ts"
      to: "src/game/AudioManager.ts"
      via: "AudioManager sound triggers"
      pattern: "this\\.audioManager\\."
---

<objective>
Add particle VFX system and sound effects to the Game scene for satisfying match-3 gameplay feedback.

Purpose: Booster VFX is the "wow factor" for the client demo (per user decision). Match clearing needs satisfying particles. Sound effects make the game feel alive. This plan transforms the flat cascade into a premium tactile experience.
Output: VFXManager with particle emitters for all effect types, AudioManager integrated into Game scene, enhanced cascade animations with particles and sound.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-assets-polish/05-01-SUMMARY.md
@src/scenes/Game.ts
@src/game/types.ts
@src/game/constants.ts
@src/game/AudioManager.ts
@src/utils/constants.ts
@STYLE_GUIDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VFXManager with particle emitters for match, booster, and confetti effects</name>
  <files>
    src/game/VFXManager.ts
  </files>
  <action>
Create `src/game/VFXManager.ts` — a centralized VFX manager that creates and triggers particle effects.

Use Phaser's built-in ParticleEmitter system. Create a small (4x4 or 8x8) white/colored pixel texture at runtime for particles (avoid needing separate particle PNGs).

```typescript
/**
 * VFXManager - Centralized particle VFX for match-3 gameplay.
 * Creates runtime particle textures, manages emitter pool.
 * Performance-safe: hard particle limits for mobile.
 */
import Phaser from 'phaser';
import { TILE_COLORS } from './constants';

export class VFXManager {
  private scene: Phaser.Scene;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.createParticleTextures();
  }

  /** Create small runtime textures for particles */
  private createParticleTextures(): void {
    if (!this.scene.textures.exists('particle_white')) {
      const gfx = this.scene.add.graphics();
      // White circle particle (8x8)
      gfx.fillStyle(0xffffff, 1);
      gfx.fillCircle(4, 4, 4);
      gfx.generateTexture('particle_white', 8, 8);
      // Yellow/gold particle for KLO branding
      gfx.clear();
      gfx.fillStyle(0xffb800, 1);
      gfx.fillCircle(4, 4, 4);
      gfx.generateTexture('particle_gold', 8, 8);
      // Star-shaped particle (simulated with larger circle)
      gfx.clear();
      gfx.fillStyle(0xffffff, 1);
      gfx.fillCircle(6, 6, 6);
      gfx.generateTexture('particle_star', 12, 12);
      gfx.destroy();
    }
  }
```

Implement these 6 effect methods with full implementation code:

**1. `matchPop(x, y, color)` — match clearing particle burst:**
```typescript
  /** Particle burst when tiles are matched and cleared */
  matchPop(x: number, y: number, color: number): void {
    const emitter = this.scene.add.particles(x, y, 'particle_white', {
      speed: { min: 40, max: 120 },
      scale: { start: 0.5, end: 0 },
      lifespan: { min: 200, max: 400 },
      tint: color,
      gravityY: 80,
      maxParticles: 10,
      emitting: false,
    });
    emitter.explode(10);
    // Self-cleanup after particles expire
    this.scene.time.delayedCall(500, () => emitter.destroy());
  }
```

**2. `boosterLineSweep(startX, startY, direction, length)` — line booster activation:**
```typescript
  /** Line sweep effect for linear booster activation */
  boosterLineSweep(startX: number, startY: number, direction: 'horizontal' | 'vertical', length: number): void {
    const isHorizontal = direction === 'horizontal';
    // Create a sweep particle that travels along the row/column
    const emitter = this.scene.add.particles(startX, startY, 'particle_gold', {
      speed: { min: 10, max: 40 },
      scale: { start: 0.8, end: 0 },
      lifespan: 300,
      tint: [0xffffff, 0xffb800, 0xffe066],
      maxParticles: 25,
      emitting: false,
    });
    // Emit particles along the line over time
    const steps = 8;
    for (let i = 0; i <= steps; i++) {
      const delay = i * 30;
      const px = isHorizontal ? startX + (i / steps - 0.5) * length : startX;
      const py = isHorizontal ? startY : startY + (i / steps - 0.5) * length;
      this.scene.time.delayedCall(delay, () => {
        emitter.emitParticleAt(px, py, 3);
      });
    }
    // Brief screen flash
    this.scene.cameras.main.flash(100, 255, 255, 255, true, undefined, undefined);
    this.scene.time.delayedCall(600, () => emitter.destroy());
  }
```

**3. `boosterBombExplosion(x, y)` — bomb 3x3 explosion:**
```typescript
  /** Explosion burst for bomb booster activation */
  boosterBombExplosion(x: number, y: number): void {
    // Main explosion burst — white/gold particles in circular pattern
    const emitter = this.scene.add.particles(x, y, 'particle_star', {
      speed: { min: 80, max: 200 },
      scale: { start: 0.8, end: 0 },
      lifespan: { min: 300, max: 600 },
      tint: [0xffffff, 0xffb800, 0xff6600],
      gravityY: 50,
      maxParticles: 30,
      emitting: false,
    });
    emitter.explode(30);
    // Camera shake for impact feel
    this.scene.cameras.main.shake(150, 0.005);
    // Brief orange flash
    this.scene.cameras.main.flash(80, 255, 140, 0, true, undefined, undefined);
    this.scene.time.delayedCall(700, () => emitter.destroy());
  }
```

**4. `boosterSphereWave(x, y)` — KLO sphere color bomb wave:**
```typescript
  /** Expanding wave effect for KLO sphere (color bomb) activation */
  boosterSphereWave(x: number, y: number): void {
    // Create expanding ring graphic
    const ring = this.scene.add.graphics();
    ring.lineStyle(4, 0xffb800, 1);
    ring.strokeCircle(x, y, 10);
    // Tween ring outward
    this.scene.tweens.add({
      targets: ring,
      scaleX: 8,
      scaleY: 8,
      alpha: 0,
      duration: 500,
      ease: 'Cubic.Out',
      onComplete: () => ring.destroy(),
    });
    // Particle burst radiating outward
    const emitter = this.scene.add.particles(x, y, 'particle_white', {
      speed: { min: 100, max: 250 },
      scale: { start: 0.6, end: 0 },
      lifespan: { min: 400, max: 800 },
      tint: [0xff4444, 0x44ff44, 0x4444ff, 0xffb800, 0xff66ff],
      maxParticles: 45,
      emitting: false,
    });
    emitter.explode(45);
    // KLO gold camera flash
    this.scene.cameras.main.flash(200, 255, 184, 0, true, undefined, undefined);
    this.scene.time.delayedCall(900, () => emitter.destroy());
  }
```

**5. `confettiBurst(x, y)` — win screen confetti:**
```typescript
  /** Confetti burst for win celebration */
  confettiBurst(x: number, y: number): void {
    const emitter = this.scene.add.particles(x, y, 'particle_white', {
      speed: { min: 50, max: 200 },
      angle: { min: 240, max: 300 },  // Upward spread
      scale: { start: 0.6, end: 0.2 },
      lifespan: { min: 1500, max: 2500 },
      tint: [0xffb800, 0xffffff, 0xff6600, 0x4488ff, 0x44cc44],
      gravityY: 120,
      maxParticles: 50,
      emitting: false,
    });
    emitter.explode(50);
    this.scene.time.delayedCall(3000, () => emitter.destroy());
  }
```

**6. `cascadeCombo(x, y, depth)` — escalating cascade feedback:**
```typescript
  /** Escalating cascade combo feedback — bigger effects at higher depths */
  cascadeCombo(x: number, y: number, depth: number): void {
    // depth 1: small subtle pop
    const particleCount = Math.min(8 + depth * 4, 30);
    const emitter = this.scene.add.particles(x, y, 'particle_gold', {
      speed: { min: 20 + depth * 15, max: 60 + depth * 25 },
      scale: { start: 0.3 + depth * 0.1, end: 0 },
      lifespan: 200 + depth * 100,
      maxParticles: particleCount,
      emitting: false,
    });
    emitter.explode(particleCount);
    // depth 4+: add screen shake for dramatic cascade chains
    if (depth >= 4) {
      this.scene.cameras.main.shake(100, 0.003 + (depth - 4) * 0.001);
    }
    this.scene.time.delayedCall(500 + depth * 100, () => emitter.destroy());
  }
}
```

Close the class with `}`.

**Performance limits (hard caps for mobile):**
- matchPop: max 10 particles
- lineSweep: max 25 particles
- bombExplosion: max 30 particles
- sphereWave: max 45 particles
- confetti: max 50 particles
- cascadeCombo: max 30 particles (capped)
- All particles self-clean via Phaser's built-in lifetime management + explicit delayed destroy
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. VFXManager class exports correctly. All 6 methods exist with correct parameter signatures.
  </verify>
  <done>
VFXManager exists with 6 effect methods: matchPop, boosterLineSweep, boosterBombExplosion, boosterSphereWave, confettiBurst, cascadeCombo. Runtime particle textures generated (no external PNG dependency). Hard particle limits enforced for mobile performance. Each method uses Phaser ParticleEmitter with explode() and delayed destroy for cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate VFX and AudioManager into Game scene cascade flow</name>
  <files>
    src/scenes/Game.ts
  </files>
  <action>
Modify Game.ts to instantiate VFXManager and AudioManager in `create()`, then wire them into the cascade and gameplay flow.

**1. Add imports and instance variables:**
```typescript
import { AudioManager } from '../game/AudioManager';
import { VFXManager } from '../game/VFXManager';

// In class:
private audioManager: AudioManager;
private vfxManager: VFXManager;
```

**2. In `create()`, after scene setup:**
```typescript
this.audioManager = new AudioManager(this);
this.vfxManager = new VFXManager(this);
```

**3. Enhance `animateMatchRemoval()` — add particle pop + sound:**
After the existing fade/shrink tween for each tile, ALSO trigger VFX:
```typescript
// For each matched tile:
const worldX = this.gridOffsetX + tileData.col * TILE_SIZE + TILE_SIZE / 2;
const worldY = this.gridOffsetY + tileData.row * TILE_SIZE + TILE_SIZE / 2;
const color = TILE_COLORS[tileData.type] || 0xffffff;
this.vfxManager.matchPop(worldX, worldY, color);
```
Play match sound once per batch (not per tile):
```typescript
this.audioManager.playMatch();
```

**4. Enhance `processCascade()` — add cascade combo escalation:**
At the start of each cascade iteration:
```typescript
// After depth++ line:
const worldX = this.gridOffsetX + GRID_WIDTH * TILE_SIZE / 2;
const worldY = this.gridOffsetY + GRID_HEIGHT * TILE_SIZE / 2;
this.vfxManager.cascadeCombo(worldX, worldY, depth);
```

**5. Add booster activation VFX in `processCascade()` where boosters are activated:**
```typescript
// When activating a booster:
if (tileData.booster === 'linear_horizontal' || tileData.booster === 'linear_vertical') {
  const startX = this.gridOffsetX + tileData.col * TILE_SIZE + TILE_SIZE / 2;
  const startY = this.gridOffsetY + tileData.row * TILE_SIZE + TILE_SIZE / 2;
  const direction = tileData.booster === 'linear_horizontal' ? 'horizontal' : 'vertical';
  const length = (direction === 'horizontal' ? GRID_WIDTH : GRID_HEIGHT) * TILE_SIZE;
  this.vfxManager.boosterLineSweep(startX, startY, direction, length);
  this.audioManager.playLineClear();
} else if (tileData.booster === 'bomb') {
  const bx = this.gridOffsetX + tileData.col * TILE_SIZE + TILE_SIZE / 2;
  const by = this.gridOffsetY + tileData.row * TILE_SIZE + TILE_SIZE / 2;
  this.vfxManager.boosterBombExplosion(bx, by);
  this.audioManager.playBomb();
} else if (tileData.booster === 'klo_sphere') {
  const sx = this.gridOffsetX + tileData.col * TILE_SIZE + TILE_SIZE / 2;
  const sy = this.gridOffsetY + tileData.row * TILE_SIZE + TILE_SIZE / 2;
  this.vfxManager.boosterSphereWave(sx, sy);
  this.audioManager.playSphere();
}
```

**6. Enhance booster combo VFX in `onTileSwap()` where combo is detected:**
Add VFX and sound for the booster-booster combo cases (use the biggest available effect — bombExplosion or sphereWave based on combo type).

**7. Enhance `animateNewTiles()` — add bounce ease:**
Change the tween ease from `'Bounce.easeOut'` to `'Bounce.Out'` (correct Phaser syntax) and ensure tiles land with a satisfying bounce.

**8. Enhance `onTileSwap()` swap animation — add micro-bounce:**
Add a slight overshoot ease to the swap tween: change `ease: 'Power2'` to `ease: 'Back.Out'` for a subtle bounce on swap.

**9. Add win/lose sounds:**
In `showWinOverlay()`: `this.audioManager.playWin()` + `this.vfxManager.confettiBurst(width / 2, 0)`.
In `showLoseOverlay()`: `this.audioManager.playLose()`.

**10. Performance safeguard:**
Add a small delay (50ms) between cascade iterations using:
```typescript
await new Promise(resolve => this.time.delayedCall(50, resolve));
```
This prevents overwhelming the particle system during fast cascades and gives visual breathing room.
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. Run `npm run dev`, play a level:
1. Swap two tiles — tiles should swap with Back.Out bounce ease
2. Match 3 — particles burst from cleared tiles, match sound plays
3. If booster created and activated — dramatic VFX (line sweep / explosion / wave) with corresponding sound
4. Cascade chain — effects escalate with depth
5. Win level — confetti + win sound
6. Lose level — lose sound
7. No FPS drops below 30fps during heavy cascades (check via Phaser debug or devtools performance tab)
  </verify>
  <done>
Game scene has VFXManager and AudioManager integrated. Match clearing shows particle bursts with sound. Booster activation shows dramatic VFX (line sweep for linear, explosion for bomb, wave for sphere) with corresponding sounds. Cascades escalate visually. Win shows confetti+sound, lose plays sound. Swap animation uses bounce ease. No performance regressions on mobile.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Match-3 clearing shows colored particle pops at each cleared tile position
3. Linear booster activation shows visible line sweep effect
4. Bomb booster shows explosion with camera shake
5. KLO sphere shows expanding wave with gold camera flash
6. Sound effects play (match, bomb, sphere, horizontal, win, lose)
7. Win screen has confetti particle burst
8. No console errors during gameplay
9. FPS stays above 30 during heavy cascades
</verification>

<success_criteria>
- VFXManager class with 6 particle effect methods, each with complete Phaser emitter implementation
- AudioManager wired into all gameplay events (match, booster, win, lose)
- Booster activation is the "wow factor" — dramatic and impressive
- Cascade effects escalate with depth (small pop at 1, larger at 2+, screen shake at 4+)
- Performance stays smooth (particle limits enforced)
- Game feels "premium casual" with tactile feedback on every interaction
</success_criteria>

<output>
After completion, create `.planning/phases/05-assets-polish/05-02-SUMMARY.md`
</output>
