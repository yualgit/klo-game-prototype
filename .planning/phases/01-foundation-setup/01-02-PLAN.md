---
phase: 01-foundation-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/firebase/config.ts
  - src/firebase/auth.ts
  - src/firebase/firestore.ts
  - src/firebase/index.ts
  - firestore.rules
  - .env
autonomous: true
user_setup:
  - service: firebase
    why: "Backend for auth and data persistence"
    env_vars:
      - name: VITE_FIREBASE_API_KEY
        source: "Firebase Console -> Project Settings -> General -> Web API Key"
      - name: VITE_FIREBASE_AUTH_DOMAIN
        source: "Firebase Console -> Project Settings -> General -> authDomain"
      - name: VITE_FIREBASE_PROJECT_ID
        source: "Firebase Console -> Project Settings -> General -> projectId"
      - name: VITE_FIREBASE_STORAGE_BUCKET
        source: "Firebase Console -> Project Settings -> General -> storageBucket"
      - name: VITE_FIREBASE_MESSAGING_SENDER_ID
        source: "Firebase Console -> Project Settings -> General -> messagingSenderId"
      - name: VITE_FIREBASE_APP_ID
        source: "Firebase Console -> Project Settings -> General -> appId"
    dashboard_config:
      - task: "Enable Anonymous Authentication"
        location: "Firebase Console -> Authentication -> Sign-in method -> Anonymous"
      - task: "Create Firestore database"
        location: "Firebase Console -> Firestore Database -> Create database"

must_haves:
  truths:
    - "Firebase initializes without errors on app start"
    - "User automatically signed in anonymously (UID appears in console)"
    - "Progress data saves to Firestore when saveProgress called"
    - "Progress data loads from Firestore after page refresh"
  artifacts:
    - path: "src/firebase/config.ts"
      provides: "Firebase configuration from environment variables"
      contains: "import.meta.env.VITE_FIREBASE"
    - path: "src/firebase/auth.ts"
      provides: "Anonymous auth service"
      exports: ["AuthService"]
    - path: "src/firebase/firestore.ts"
      provides: "Progress CRUD operations"
      exports: ["FirestoreService"]
    - path: "src/firebase/index.ts"
      provides: "Firebase initialization and service exports"
      exports: ["initFirebase", "authService", "firestoreService"]
    - path: "firestore.rules"
      provides: "Security rules for user data"
      contains: "request.auth.uid == userId"
  key_links:
    - from: "src/firebase/index.ts"
      to: "Firebase SDK"
      via: "initializeApp with config"
      pattern: "initializeApp\\(firebaseConfig\\)"
    - from: "src/firebase/auth.ts"
      to: "Firebase Auth"
      via: "signInAnonymously"
      pattern: "signInAnonymously"
    - from: "src/firebase/firestore.ts"
      to: "Firestore"
      via: "doc/setDoc/getDoc operations"
      pattern: "setDoc.*users"
---

<objective>
Implement Firebase integration with anonymous authentication and Firestore progress persistence.

Purpose: This enables requirement FB-01 (anonymous auth) and FB-02 (progress persistence). Users will be silently authenticated and their game progress saved/loaded automatically.

Output: Working Firebase service layer that can authenticate users and persist their progress data.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-setup/01-RESEARCH.md

Key patterns from research:
- Firebase v11 modular SDK with tree-shaking imports
- enableMultiTabIndexedDbPersistence() for offline support
- Initialize Firebase BEFORE Phaser to avoid race conditions
- Security rules: user can only read/write their own data

Existing .env file should have Firebase config (check and use).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Firebase configuration and initialization</name>
  <files>
    - src/firebase/config.ts
    - src/firebase/index.ts
  </files>
  <action>
1. Create src/firebase/config.ts:
   - Export firebaseConfig object reading from import.meta.env
   - Required vars: VITE_FIREBASE_API_KEY, VITE_FIREBASE_AUTH_DOMAIN, VITE_FIREBASE_PROJECT_ID, VITE_FIREBASE_STORAGE_BUCKET, VITE_FIREBASE_MESSAGING_SENDER_ID, VITE_FIREBASE_APP_ID
   - Add validation that throws clear error if any var is missing

2. Create src/firebase/index.ts:
   - Import initializeApp from 'firebase/app'
   - Import getAuth from 'firebase/auth'
   - Import getFirestore, enableMultiTabIndexedDbPersistence from 'firebase/firestore'
   - Export async function initFirebase() that:
     a. Calls initializeApp(firebaseConfig)
     b. Gets auth and db instances
     c. Enables multi-tab persistence with error handling (failed-precondition, unimplemented)
     d. Returns { app, auth, db }
   - Export app, auth, db as module-level singletons (initialized lazily)
  </action>
  <verify>
Check files exist and TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>
Firebase config reads from env vars. initFirebase() initializes app with offline persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auth and firestore services</name>
  <files>
    - src/firebase/auth.ts
    - src/firebase/firestore.ts
    - firestore.rules
  </files>
  <action>
1. Create src/firebase/auth.ts:
   - Export class AuthService
   - Constructor takes auth instance
   - Method signInAnonymous(): Promise<string> - returns UID
   - Method getCurrentUser(): returns current user or null
   - Method onAuthChange(callback): returns unsubscribe function
   - Log "[AuthService] Signed in as: {uid}" on successful sign-in

2. Create src/firebase/firestore.ts:
   - Export class FirestoreService
   - Constructor takes db instance
   - Export interface UserProgress:
     ```typescript
     interface UserProgress {
       current_level: number;
       completed_levels: number[];
       stars: number;
       last_seen: Date;
     }
     ```
   - Method saveProgress(uid: string, progress: Partial<UserProgress>): Promise<void>
     - Uses setDoc with merge: true on doc path 'users/{uid}'
     - Adds serverTimestamp() for last_seen
   - Method loadProgress(uid: string): Promise<UserProgress | null>
     - Uses getDoc on 'users/{uid}'
     - Returns null if doc doesn't exist
   - Log operations: "[FirestoreService] Saving progress for {uid}", "[FirestoreService] Loaded progress for {uid}"

3. Create firestore.rules in project root:
   ```
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       match /users/{userId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
       }
     }
   }
   ```

4. Update src/firebase/index.ts:
   - Create and export authService and firestoreService instances
   - Export initFirebase that also:
     - Creates service instances
     - Calls authService.signInAnonymous()
     - Returns { app, auth, db, authService, firestoreService, uid }
  </action>
  <verify>
Run: npx tsc --noEmit
Check that all types resolve and no compile errors.
  </verify>
  <done>
AuthService handles anonymous sign-in. FirestoreService saves/loads user progress. Security rules protect user data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Firebase into app startup and verify persistence</name>
  <files>
    - src/main.ts
  </files>
  <action>
1. Update src/main.ts to:
   - Import initFirebase from './firebase'
   - Make the startup async:
     ```typescript
     async function main() {
       // Initialize Firebase first (avoid race conditions)
       const { uid, firestoreService } = await initFirebase();
       console.log('[Main] Firebase initialized, user:', uid);

       // Test save/load cycle
       await firestoreService.saveProgress(uid, {
         current_level: 1,
         completed_levels: [],
         stars: 0
       });
       console.log('[Main] Progress saved');

       const loaded = await firestoreService.loadProgress(uid);
       console.log('[Main] Progress loaded:', loaded);

       // Then start Phaser
       const game = new Phaser.Game(config);
     }

     main().catch(console.error);
     ```

2. Keep the minimal Phaser config from Plan 01, just add Firebase init before it.

This creates a test flow:
- Firebase initializes
- Anonymous auth happens
- Test data is saved to Firestore
- Test data is loaded back
- Phaser starts

Console will show the full flow for verification.
  </action>
  <verify>
Run: npm run dev
Open browser, check console for:
1. "[AuthService] Signed in as: {uid}" - some UID string
2. "[FirestoreService] Saving progress for {uid}"
3. "[Main] Progress saved"
4. "[Main] Progress loaded: {object with current_level: 1}"
5. Phaser canvas still renders

Refresh page - same UID should appear (Firebase persists anonymous session).
Check Firebase Console -> Firestore -> users collection - document should exist.
  </verify>
  <done>
Firebase initializes before Phaser. Anonymous auth works. Progress saves and loads from Firestore. Session persists across page refresh.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. `npm run dev` - no errors
2. Browser console shows auth UID
3. Browser console shows "Progress saved" and "Progress loaded" with data
4. Refresh page - same UID appears (session persists)
5. Firebase Console shows user document in Firestore
6. Phaser canvas still renders after Firebase init
7. `npx tsc --noEmit` - no TypeScript errors
</verification>

<success_criteria>
- Firebase initializes without errors (FB-01 partial)
- Anonymous auth creates user session automatically (FB-01 complete)
- Progress data saves to Firestore (FB-02 partial)
- Progress data persists across browser refresh (FB-02 complete)
- No race conditions between Firebase and Phaser
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-02-SUMMARY.md`
</output>
