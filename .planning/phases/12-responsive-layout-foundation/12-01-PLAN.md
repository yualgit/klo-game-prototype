---
phase: 12-responsive-layout-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.ts
  - index.html
  - src/utils/constants.ts
  - src/scenes/Menu.ts
  - src/scenes/LevelSelect.ts
  - src/scenes/Game.ts
autonomous: true

must_haves:
  truths:
    - "Game renders at fixed 1024x1820 internal coordinate space on all devices"
    - "Canvas scales to fit viewport via Scale.FIT with letterboxing where needed"
    - "Canvas renders at 1024x1820 pixels internally with browser-level scaling for retina displays"
    - "Safe area insets prevent content from being hidden behind notch or home indicator"
    - "All three scenes (Menu, LevelSelect, Game) display correctly at 1024x1820"
  artifacts:
    - path: "src/main.ts"
      provides: "Scale.FIT config with fixed 1024x1820 design resolution (no DPR multiplication)"
      contains: "Scale.FIT"
    - path: "index.html"
      provides: "viewport-fit=cover and safe-area CSS insets"
      contains: "viewport-fit=cover"
    - path: "src/utils/constants.ts"
      provides: "Design resolution constants DESIGN_WIDTH=1024, DESIGN_HEIGHT=1820"
      contains: "DESIGN_WIDTH"
    - path: "src/scenes/Menu.ts"
      provides: "Menu layout for 1024x1820 coordinate space"
    - path: "src/scenes/LevelSelect.ts"
      provides: "LevelSelect layout for 1024x1820 coordinate space"
    - path: "src/scenes/Game.ts"
      provides: "Game layout for 1024x1820 coordinate space"
  key_links:
    - from: "src/main.ts"
      to: "src/utils/constants.ts"
      via: "imports DESIGN_WIDTH/DESIGN_HEIGHT for config"
      pattern: "DESIGN_WIDTH.*DESIGN_HEIGHT"
    - from: "index.html"
      to: "game-container"
      via: "CSS safe-area padding on body/container"
      pattern: "env\\(safe-area-inset"
    - from: "src/main.ts"
      to: "all scenes"
      via: "Scale.FIT ensures fixed 1024x1820 coordinate space"
      pattern: "Scale\\.FIT"
---

<objective>
Migrate from Scale.RESIZE to Scale.FIT with a fixed 1024x1820 portrait design resolution, add safe-area CSS for iOS notch support, and adapt all scene layouts to the normalized coordinate space.

Purpose: Currently the game uses Scale.RESIZE which gives each device a different internal coordinate space (e.g., 750x1334 on iPhone SE vs 3840x2160 on desktop). Fixed-width elements like MAP_WIDTH=1024 and grid=512px overflow narrow viewports. Switching to Scale.FIT with a fixed design resolution normalizes all scenes to one coordinate space (1024x1820) that Phaser scales to fit any viewport, guaranteeing all content is visible.

Output: Scale.FIT config in main.ts, safe-area CSS in index.html, design constants in constants.ts, adapted scene layouts in Menu/LevelSelect/Game.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-responsive-layout-foundation/12-RESEARCH.md

# Key source files
@src/main.ts
@index.html
@src/utils/constants.ts
@src/scenes/Menu.ts
@src/scenes/LevelSelect.ts
@src/scenes/Game.ts
@src/game/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scale.FIT migration and HTML safe-area setup</name>
  <files>src/main.ts, index.html, src/utils/constants.ts</files>
  <action>
**1. Add design resolution constants to `src/utils/constants.ts`:**

Add two new exports:
```typescript
// Design resolution for Scale.FIT mode (portrait mobile, matches MAP_WIDTH)
export const DESIGN_WIDTH = 1024;
export const DESIGN_HEIGHT = 1820;
```

Keep existing GAME_WIDTH/GAME_HEIGHT exports (they may be referenced elsewhere) but they are now legacy. Do NOT remove them to avoid breaking imports.

**2. Update `src/main.ts` Phaser config:**

Change the scale config from RESIZE to FIT with fixed design resolution. Do NOT multiply by DPR -- use raw design constants so the internal coordinate space stays at 1024x1820 (matching all existing world coordinates like MAP_WIDTH=1024):

```typescript
import { DESIGN_WIDTH, DESIGN_HEIGHT } from './utils/constants';

const config: Phaser.Types.Core.GameConfig = {
  type: Phaser.AUTO,
  width: DESIGN_WIDTH,    // 1024 (no DPR multiplication)
  height: DESIGN_HEIGHT,  // 1820 (no DPR multiplication)
  parent: 'game-container',
  backgroundColor: '#1A1A1A',
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH,
    // No zoom property -- let browser handle retina upscaling
  },
  render: {
    pixelArt: false,
    roundPixels: true,
  },
  scene: [Boot, Menu, LevelSelect, Game],
};
```

Key changes:
- `width` changes from `window.innerWidth * dpr` to `DESIGN_WIDTH` (1024, no DPR)
- `height` changes from `window.innerHeight * dpr` to `DESIGN_HEIGHT` (1820, no DPR)
- `mode` changes from `Phaser.Scale.RESIZE` to `Phaser.Scale.FIT`
- `backgroundColor` changes from `'#F9F9F9'` to `'#1A1A1A'` (letterbox bars should be dark, not white)
- Remove `zoom: 1 / dpr` property entirely
- Remove DPR constant from config (keep `game.registry.set('dpr', dpr)` if other code reads it, but it is not used for canvas sizing)

Why NO DPR multiplication: The DPR zoom trick (width*dpr + zoom:1/dpr) changes the internal coordinate space to 2048x3640 at dpr=2, which creates a mismatch with existing world coordinates (MAP_WIDTH=1024, level nodes at x:260-650, etc.). Without DPR, cameras.main.width=1024 and all world coordinates match. The canvas renders at 1024x1820 internally; the browser CSS-scales the canvas to fit the viewport, providing adequate quality. If retina crispness is needed later, it can be addressed in a future phase.

Why 1024x1820:
- Width 1024 matches MAP_CONFIG.MAP_WIDTH (LevelSelect world width)
- Height 1820 is ~16:9 portrait ratio (0.563), near-identical to iPhone SE (375/667=0.562)
- This means minimal letterboxing on standard mobile phones
- The game grid (512px wide) centers perfectly in 1024px with 256px margins each side

**3. Update `index.html`:**

Add `viewport-fit=cover` to the viewport meta tag:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
```

Add safe-area CSS to the style block:
```css
body {
  overflow: hidden;
  background-color: #1A1A1A;
  /* Safe area for iOS notch devices */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

#game-container {
  width: 100vw;
  height: 100vh;
  /* Subtract safe area from container dimensions */
  width: calc(100vw - env(safe-area-inset-left) - env(safe-area-inset-right));
  height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  display: flex;
  justify-content: center;
  align-items: center;
}
```

This ensures the game canvas is positioned within the safe area on devices with notches/dynamic islands.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Run `npx vite build` to verify production build succeeds. Verify the new constants are exported correctly.
  </verify>
  <done>
main.ts uses Scale.FIT with DESIGN_WIDTH=1024/DESIGN_HEIGHT=1820, index.html has viewport-fit=cover and safe-area CSS, constants.ts exports DESIGN_WIDTH/DESIGN_HEIGHT. TypeScript compiles and Vite builds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Adapt all scene layouts for fixed 1024x1820 coordinate space</name>
  <files>src/scenes/Menu.ts, src/scenes/LevelSelect.ts, src/scenes/Game.ts</files>
  <action>
With Scale.FIT and no DPR multiplication (as established in Task 1), the internal game resolution is fixed at 1024x1820. `cameras.main.width` = 1024, `cameras.main.height` = 1820 on all devices. The resize event will NOT fire (internal size is fixed). All existing world coordinates (MAP_WIDTH=1024, level nodes at x:260-650, etc.) match the camera viewport width exactly. Scenes can rely on fixed coordinates.

**1. Menu.ts -- No changes needed:**

The Menu uses `width/2` and `height/3` relative positioning. With fixed 1024x1820:
- Title at (512, 607)
- Subtitle at (512, 667)
- Play button at (512, 960)
- Floating tiles at percentage positions

The resize handler `handleResize()` will never fire but is harmless. Leave it in place for safety. Verify that `this.cameras.main.width` returns 1024 and `this.cameras.main.height` returns 1820.

**2. LevelSelect.ts -- Adapt for 1024x1820 viewport:**

With camera viewport at 1024x1820 and world at 1024x2200:
- Camera width matches MAP_WIDTH (1024) -- no horizontal scroll possible
- Vertical scroll range: 2200 - 1820 = 380px
- Camera bounds: `setBounds(0, 0, 1024, 2200)` -- already correct, no change
- Level nodes: positions (x: 260-650) all within 0-1024 range -- all visible
- HUD bar: drawn at width=1024. Title at 512. Economy at 924. Settings at 824. All consistent.

**Changes to LevelSelect.ts:**
1. In `createParallaxBackground()`: Change hardcoded `768` in `maxScroll` calc to `this.cameras.main.height`:
   ```typescript
   const maxScroll = MAP_CONFIG.MAP_HEIGHT - this.cameras.main.height; // 2200 - 1820 = 380
   ```
2. Sky layer: Reposition for 1024x1820 viewport. Since sky has scrollFactor=0, position at viewport center: `(width/2, height/2)` = (512, 910). Sky scale needs to cover 1024x1820: `Math.max(1024/1536, 1820/1024) = 1.777`. Set `setScale(1.777)`.
3. Far/mid parallax: Update spacing calculations for the 1820-height viewport:
   - Far layer: `farEffectiveRange = 380 * 0.25 + 1820 = 1915`. Need 3 segments at ~638 each. Source images 1536x1024, scaled to 1024/1536 = 0.667 -> height 683. 3 segments at 638 spacing -- slightly overlapping. Fine.
   - Mid layer: `midEffectiveRange = 380 * 0.6 + 1820 = 2048`. 2 segments at 1024 each. Source 1024x1536 at native scale -> height 1536. Covers 1024 per segment. Fine.

**3. Game.ts -- No structural changes needed:**

With fixed 1024x1820 coordinate space:
- Grid offset: `(1024 - 512) / 2 = 256` horizontal, `(1820 - 512) / 2 + 30 = 684` vertical. Grid is nicely centered in the portrait layout.
- HUD: 1024px wide at top. HUD text at (512, 34). Good.
- Win/lose overlay panels: panelW=400, centered at (312, y). panelH=320-400. Centered in 1820 height. Good.
- Back button at (70, 30). Inside HUD bar area. Fine.
- No structural changes needed. The fixed coordinate space makes everything consistent.

**Summary of scene changes:**
1. LevelSelect.ts: Update parallax calculations for 1820-height viewport (maxScroll, sky position/scale, layer spacing)
2. Menu.ts: No changes needed (verify only)
3. Game.ts: No structural changes needed (verify only -- grid centering at 1024x1820 gives good layout)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npx vite build` to verify build succeeds. Start dev server with `npx vite --host` and open in Chrome DevTools mobile emulation for iPhone SE (375x667), verify:
1. Menu scene displays with centered title and play button
2. LevelSelect loads with visible HUD bar and level nodes
3. Game scene shows centered grid with HUD above
  </verify>
  <done>
All three scenes render correctly at 1024x1820 internal resolution. LevelSelect parallax adapted for 1820-height viewport. Game grid centered with adequate HUD spacing. Menu layout clean. No coordinate mismatches between world and camera.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vite build` succeeds
3. Chrome DevTools mobile emulation at 375x667 (iPhone SE) shows:
   - Game canvas scaled to fit viewport with minimal letterboxing
   - Menu title and Play button visible and centered
   - LevelSelect HUD bar, level nodes, and road path visible
   - Game grid fully visible with HUD above, no overlap
4. Chrome DevTools at 360x740 (Android) shows same results
5. Desktop browser (1920x1080) shows game centered with dark letterboxing
</verification>

<success_criteria>
- Scale.FIT mode active with fixed 1024x1820 design resolution
- Safe-area CSS applied for iOS notch devices
- All scenes render correctly at the fixed coordinate space
- TypeScript compiles and Vite builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-responsive-layout-foundation/12-01-SUMMARY.md`
</output>
