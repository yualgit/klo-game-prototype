---
phase: 12-responsive-layout-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/responsive.ts
  - src/scenes/Game.ts
  - src/game/TileSprite.ts
autonomous: true

must_haves:
  truths:
    - "Game grid is fully visible and centered on iPhone SE (375x667 at 2x DPR = 750x1334 game coords)"
    - "HUD text is readable on all devices — minimum ~14px CSS equivalent"
    - "Win/Lose overlay panels never exceed viewport width on narrow screens"
    - "HUD elements never overlap game grid on any viewport"
    - "Tile touch targets remain large enough for finger taps (minimum ~28px CSS)"
  artifacts:
    - path: "src/utils/responsive.ts"
      provides: "Responsive layout utility with DPR-aware size calculations"
    - path: "src/scenes/Game.ts"
      provides: "Responsive Game scene with adaptive HUD, grid, and overlays"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "src/utils/responsive.ts"
      via: "import getResponsiveLayout"
      pattern: "import.*responsive"
    - from: "src/scenes/Game.ts"
      to: "src/game/TileSprite.ts"
      via: "TileSprite constructor with dynamic tileSize"
      pattern: "new TileSprite"
---

<objective>
Create responsive layout utility and make Game scene fully adaptive across all mobile viewports.

Purpose: Current DPR-aware rendering (zoom: 1/dpr) makes all UI elements appear at half their specified size on 2x DPR devices — a 16px font renders as 8px on screen. Game overlay panels use fixed 400px width which may not fit on narrow viewports. This plan creates a responsive sizing system and adapts the Game scene to use it.

Output: Responsive utility module + adaptive Game scene with readable HUD, properly-sized grid, and viewport-constrained overlays.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main.ts
@src/utils/constants.ts
@src/scenes/Game.ts
@src/game/TileSprite.ts
@src/game/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create responsive layout utility and adapt Game scene</name>
  <files>
    src/utils/responsive.ts
    src/scenes/Game.ts
    src/game/TileSprite.ts
  </files>
  <action>
**Part A: Create `src/utils/responsive.ts`**

Create a responsive layout utility that provides DPR-aware sizes. The key insight: with `zoom: 1/dpr`, all Phaser coordinates are in "device pixels" (canvas pixels), but CSS pixels = canvas pixels / dpr. So to get a visually consistent 16px CSS font, we need 16 * dpr in Phaser coords.

```typescript
/**
 * Responsive layout utilities for DPR-aware UI sizing.
 *
 * With Scale.RESIZE + zoom: 1/dpr, Phaser coords are in device pixels.
 * CSS pixels = Phaser pixels / dpr. To get desired CSS sizes, multiply by dpr.
 *
 * Example: 16px CSS font → 16 * dpr = 32px in Phaser coords on 2x device.
 */

// Get DPR (same logic as main.ts, capped at 2)
export function getDpr(): number {
  return Math.min(window.devicePixelRatio || 1, 2);
}

// Scale a CSS pixel value to Phaser coordinates
export function cssToGame(cssPx: number): number {
  return cssPx * getDpr();
}

// Calculate responsive game layout based on current viewport
export function getResponsiveLayout(gameWidth: number, gameHeight: number) {
  const dpr = getDpr();

  // Effective CSS dimensions
  const cssWidth = gameWidth / dpr;
  const cssHeight = gameHeight / dpr;

  // Grid sizing: tile should be at least 40px CSS, at most 60px CSS
  // 8 tiles + margins need to fit in viewport width with padding
  const maxGridCssWidth = cssWidth - 20; // 10px padding each side in CSS
  const maxTileCss = Math.floor(maxGridCssWidth / 8);
  const tileSizeCss = Math.max(36, Math.min(60, maxTileCss));
  const tileSize = tileSizeCss * dpr; // Convert to Phaser coords

  // HUD height: enough for readable text + padding
  const hudHeight = cssToGame(60); // 60px CSS
  const hudFontSize = cssToGame(14); // 14px CSS — readable on all devices
  const hudPaddingTop = cssToGame(8);

  // Overlay panel: max 90% of viewport width, min 280px CSS
  const overlayPanelWidth = Math.min(cssToGame(380), gameWidth * 0.9);

  // Button sizing
  const buttonWidth = cssToGame(180);
  const buttonHeight = cssToGame(44);
  const buttonFontSize = cssToGame(18);

  // Title font size (overlays)
  const overlayTitleSize = cssToGame(28);
  const overlaySubtitleSize = cssToGame(16);

  // Back button
  const backButtonWidth = cssToGame(80);
  const backButtonHeight = cssToGame(36);
  const backButtonFontSize = cssToGame(14);

  return {
    dpr,
    cssWidth,
    cssHeight,
    tileSize,
    hudHeight,
    hudFontSize,
    hudPaddingTop,
    overlayPanelWidth,
    buttonWidth,
    buttonHeight,
    buttonFontSize,
    overlayTitleSize,
    overlaySubtitleSize,
    backButtonWidth,
    backButtonHeight,
    backButtonFontSize,
  };
}
```

**Part B: Update `src/game/TileSprite.ts`** to accept dynamic tile size

Currently TileSprite imports `TILE_SIZE` constant (64). Modify the constructor to accept an optional `tileSize` parameter that overrides the constant:

1. Add optional `tileSize` parameter to constructor (defaults to `TILE_SIZE`)
2. Store `this.tileSize` as instance property
3. Use `this.tileSize` everywhere `TILE_SIZE` is used within the class: `updatePosition()`, `draw()`, `setSelected()`, `drawObstacle()`, `drawBooster()`, hit area sizing
4. Add a public `getTileSize()` method
5. Update `setOffset()` to also accept optional tileSize parameter for resize updates

Key places to update in TileSprite:
- `updatePosition()`: `this.x = this.offsetX + this.col * this.tileSize + this.tileSize / 2;`
- `draw()`: `const targetSize = this.tileSize - TILE_GAP;`
- `drawBooster()`: `const targetSize = this.tileSize - TILE_GAP;` for booster image display size
- `drawObstacle()`: `const targetSize = this.tileSize - TILE_GAP; const halfSize = targetSize / 2;`

**Part C: Update `src/scenes/Game.ts`** to use responsive layout

1. Import `getResponsiveLayout, cssToGame` from `../utils/responsive`

2. In `create()`:
   - Call `getResponsiveLayout(width, height)` to get responsive sizes
   - Store the layout as `this.layout`
   - Use `this.layout.tileSize` instead of imported `TILE_SIZE` for grid calculations
   - Calculate grid offset using `this.layout.tileSize` and `this.layout.hudHeight`
   - Grid offset Y: `this.layout.hudHeight + cssToGame(10)` from top (not center vertically — HUD at top, grid below)
   - Grid offset X: `(width - gridPixelWidth) / 2` centered horizontally
   - If grid doesn't fit vertically (hudHeight + gridHeight > viewport height), compute gridOffsetY to maximize visible grid with small padding

3. In `createHUD(width)`:
   - HUD bar height: `this.layout.hudHeight` instead of hardcoded 52
   - Font size: `${this.layout.hudFontSize}px` instead of `'16px'`
   - HUD text Y position: `this.layout.hudHeight / 2`
   - KLO stripe dimensions: scale proportionally

4. In `createBackButton()`:
   - Button dimensions: `this.layout.backButtonWidth` x `this.layout.backButtonHeight`
   - Font size: `${this.layout.backButtonFontSize}px`
   - Position: relative to HUD area

5. In `createTilesFromEngine()`:
   - Pass `this.layout.tileSize` to `new TileSprite(scene, row, col, type, offsetX, offsetY, tileSize)`
   - Hit area Rectangle uses `this.layout.tileSize` instead of `TILE_SIZE`

6. In `getTileAtPointer()`:
   - Use `this.layout.tileSize` instead of `TILE_SIZE` for coordinate calculations

7. In `drawGridBackground()`:
   - Use `this.layout.tileSize` for pixel width/height calculations
   - Block sprite positions use `this.layout.tileSize`
   - Mask rectangles use `this.layout.tileSize`

8. In `onTileSwap()` and animation methods (`animateMatchRemoval`, `animateMovements`, `animateNewTiles`, `processCascade`):
   - Replace all `TILE_SIZE` with `this.layout.tileSize`
   - This affects tween target positions and VFX world coordinates

9. In `showWinOverlay()` and `showLoseOverlay()`:
   - Panel width: `this.layout.overlayPanelWidth`
   - Title font: `${this.layout.overlayTitleSize}px`
   - Subtitle font: `${this.layout.overlaySubtitleSize}px`
   - Button calls: `createOverlayButton()` uses `this.layout.buttonWidth`, `this.layout.buttonHeight`
   - Star font size: scale proportionally
   - All panel-internal Y offsets scale proportionally with panel dimensions

10. In `createOverlayButton()`:
    - Use `this.layout.buttonWidth`, `this.layout.buttonHeight`, `this.layout.buttonFontSize`

11. In `handleResize()`:
    - Recompute `this.layout = getResponsiveLayout(width, height)`
    - Recalculate gridOffsetX, gridOffsetY with new layout
    - Redraw HUD background with new hudHeight
    - Reposition HUD text
    - Call `redrawGridBackground()` (which uses this.layout.tileSize)
    - Update all tile positions via `repositionAllTiles()`
    - Update tile sizes via tile.setOffset() with new tileSize (add tileSize parameter to setOffset if needed)

12. In `repositionAllTiles()`:
    - Pass the new tileSize to sprite.setOffset()

13. In `syncSpritesToEngine()`:
    - Use `this.layout.tileSize` instead of `TILE_SIZE`

**Important**: Store `this.currentTileSize` from layout on each create/resize to avoid repeated lookups.

**Do NOT change the overlay showRefillOrReturn method layout significantly — just scale fonts and use layout dimensions.**
  </action>
  <verify>
Run `npx tsc --noEmit` — TypeScript compiles with no errors.
Run `npx vite build` — Vite builds successfully.
Verify `src/utils/responsive.ts` exists and exports `getResponsiveLayout`, `cssToGame`, `getDpr`.
Verify Game.ts imports from responsive.ts.
Verify TileSprite accepts dynamic tileSize parameter.
  </verify>
  <done>
Game scene uses DPR-aware responsive sizes for HUD, grid, tiles, overlays, and buttons. Grid fits viewport on all devices (375px to 1920px). Font sizes are readable (minimum 14px CSS equivalent). Overlay panels constrained to 90% viewport width. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx vite build` succeeds
3. `src/utils/responsive.ts` exists with getResponsiveLayout, cssToGame, getDpr exports
4. Game scene references responsive layout throughout — no hardcoded pixel values for fonts, panels, or buttons
5. TileSprite accepts and uses dynamic tileSize
6. Grid width calculation uses responsive tileSize, not constant TILE_SIZE
</verification>

<success_criteria>
- Game scene HUD text is DPR-aware (16px CSS → 32px Phaser on 2x devices)
- Game grid tiles size to fit viewport width with padding
- Overlay panels never exceed viewport width
- Touch targets remain at least 28px CSS (56px Phaser on 2x)
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-responsive-layout-foundation/12-01-SUMMARY.md`
</output>
