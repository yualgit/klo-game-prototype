---
phase: 12-responsive-layout-foundation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/scenes/Game.ts
  - src/scenes/LevelSelect.ts
autonomous: false

must_haves:
  truths:
    - "Game HUD never overlaps grid or crops level goals on iPhone SE (375x667)"
    - "All Game overlay panels (win/lose/refill) fit within viewport without clipping"
    - "LevelSelect economy HUD and settings button accessible on all test viewports"
    - "Game scales smoothly when browser resized -- no layout breaks or stale elements"
  artifacts:
    - path: "src/scenes/Game.ts"
      provides: "Polished HUD and overlay layout for 1024x1820 portrait space"
    - path: "src/scenes/LevelSelect.ts"
      provides: "Polished HUD and overlay layout for 1024x1820 portrait space"
  key_links:
    - from: "src/scenes/Game.ts"
      to: "HUD height calculation"
      via: "gridOffsetY must account for HUD height + safe margin"
      pattern: "gridOffsetY.*="
    - from: "src/scenes/Game.ts"
      to: "overlay panel sizing"
      via: "panelW clamped to max percentage of viewport width"
      pattern: "panelW.*Math\\.min"
---

<objective>
Polish Game and LevelSelect scene layouts for the 1024x1820 portrait coordinate space, ensuring HUD elements don't overlap the grid, overlay panels fit within bounds, and all interactive elements remain accessible. Includes cross-viewport human verification.

Purpose: Plan 01 established the Scale.FIT foundation with fixed design resolution. This plan ensures edge cases are handled -- HUD/grid overlap prevention, overlay panel sizing for the portrait layout, font scaling for readability, and touch target adequacy.

Output: Polished Game.ts and LevelSelect.ts scene layouts, verified on iPhone SE, Android 360x740, and iPhone 14 Pro.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-responsive-layout-foundation/12-01-SUMMARY.md

# Source files (post Plan 01)
@src/scenes/Game.ts
@src/scenes/LevelSelect.ts
@src/main.ts
@src/game/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish Game and LevelSelect layouts for 1024x1820 portrait space</name>
  <files>src/scenes/Game.ts, src/scenes/LevelSelect.ts</files>
  <action>
After Plan 01, scenes render at fixed 1024x1820 internal resolution. This task audits and fixes layout issues.

**Game.ts audit and fixes:**

1. **HUD/Grid overlap prevention.** In the fixed 1024x1820 space:
   - HUD bar: y=8 to y=60 (52px tall)
   - Grid offset Y: `(1820 - gridPixelHeight) / 2 + 30`. For 8x8 grid (512px): (1820-512)/2 + 30 = 684. HUD ends at y=60, grid starts at y=684. No overlap -- 624px gap. The gap is actually too large in portrait mode.
   - **Fix:** Adjust gridOffsetY to position grid higher for a better visual balance. Instead of centering vertically, position grid with fixed top margin below HUD:
     ```typescript
     // HUD ends at ~68px (8+52+8 padding). Grid starts with comfortable margin below.
     const hudBottom = 68;
     const availableHeight = 1820 - hudBottom - 40; // 40px bottom padding
     this.gridOffsetY = hudBottom + (availableHeight - gridPixelHeight) / 2;
     ```
     For 8x8 grid: hudBottom + (1712 - 512) / 2 = 68 + 600 = 668. Grid at y=668. Still leaves room for the back button area. Smaller grids (6x6 = 384px): 68 + (1712-384)/2 = 732.

   - Actually, the grid is better positioned in the upper-middle portion for thumb accessibility on mobile. Set:
     ```typescript
     this.gridOffsetY = Math.max(hudBottom + 20, (1820 - gridPixelHeight) / 3 + hudBottom);
     ```
     This places the grid at roughly 1/3 from top (golden ratio feel) while ensuring it clears the HUD. For 8x8: max(88, 68 + (1820-512)/3) = max(88, 504) = 504. That's better.

2. **Overlay panels.** Win overlay (panelW=400, panelH=320-400): in 1024px width, panelX=(1024-400)/2=312. Fits fine. In 1820 height, panelY=(1820-400)/2=710. Centered in portrait. Good.
   - Lose overlay (panelW=400, panelH=380): panelX=312, panelY=720. Good.
   - BUT: On very small levels (6x6), the grid is at ~732 and extends to 732+384=1116. The lose panel at y=720 would overlap the grid. Since the panel has a dark backdrop, this is visually acceptable.
   - **Fix:** Ensure overlay panels use `Math.min(panelW, width - 40)` to clamp width on narrow internal resolutions (future-proof, though 1024 is wide enough).

3. **Back button position.** Currently at (70, 30). This is inside the HUD bar (y=8 to y=60). It overlaps the HUD background. This is actually intentional -- the back button is part of the HUD. Verify it looks correct.

4. **HUD text wrapping.** The HUD text shows level + moves + goals. At 1024px width, text like "Рівень 10  •  Ходи: 5  •  burger: 3/10 | ice: 2/5" might be long. Set `wordWrap` or reduce font size:
   ```typescript
   this.hudText = this.add.text(width / 2, 34, text, {
     fontFamily: 'Arial, sans-serif',
     fontSize: '14px',  // Reduce from 16px for safety
     color: '#1A1A1A',
     fontStyle: 'bold',
     wordWrap: { width: width - 200, useAdvancedWrap: true }, // Leave room for back button
   });
   ```

**LevelSelect.ts audit and fixes:**

1. **HUD bar height.** Currently 120px. In 1024x1820 portrait, 120px is fine (6.6% of height). No change needed.

2. **Economy HUD positioning.** At `width - 100 = 924`. The heart icon is at 854, lives text at 884. Settings gear at `width - 200 = 824`. In 1024px width, this leaves 224px for back button area (70px from left). Good spacing.

3. **No-lives overlay.** Panel at 300x250, centered: (362, 785). Well within 1024x1820. Good.

4. **Settings overlay.** Panel at 340x380, centered: (342, 720). Well within bounds. Good.

5. **Parallax layers post-Plan-01.** Verify the parallax recalculations from Plan 01 produce correct visual results. If sky layer doesn't cover full viewport at 1024x1820, adjust scale:
   - Sky: source 1536x1024. To cover 1024x1820 viewport at scrollFactor=0: scale = max(1024/1536, 1820/1024) = max(0.667, 1.777) = 1.777. This makes sky much larger. Adjust to `setScale(1.777)` and position at (512, 910) center of viewport.

6. **Camera scroll range.** With 1024x1820 viewport and 1024x2200 world:
   - Horizontal: no scroll needed (world width = viewport width)
   - Vertical: 2200 - 1820 = 380px scroll range
   - Level 1 at y=2050, Level 10 at y=250
   - Initial camera Y should center on current level
   - When scrolled to bottom: camera sees y=1820 to y=2200 area? No -- camera.scrollY max is MAP_HEIGHT - viewport_height = 380. Camera sees y=0 to y=1820 at scrollY=0, and y=380 to y=2200 at scrollY=380.
   - Level 1 at y=2050 is at scrollY=2050-1820/2=1140, but max scrollY is 380. So level 1 is NOT reachable by scrolling!
   - **Critical fix:** The 1820px viewport height means most of the map is visible at once. With MAP_HEIGHT=2200, only 380px of scroll is possible. Level 1 (y=2050) and Level 10 (y=250) are 1800px apart. With 1820px viewport, they can almost all be visible at once!
   - This is actually FINE for the portrait layout. At scrollY=0, camera shows y=0 to y=1820 (levels 10 through ~2). At scrollY=380, camera shows y=380 to y=2200 (levels 9 through 1). All levels are visible with minimal scrolling.
   - **Verify** that `scrollToCurrentLevel()` correctly pans to show the target level node within the visible area.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npx vite build` to verify build succeeds. Open dev server and test:
1. Game scene: HUD text doesn't overflow, grid is centered nicely, back button visible
2. LevelSelect: all 10 level nodes reachable by scrolling, HUD bar with economy display visible
3. Win/lose overlays centered and fully visible in 1024x1820 viewport
  </verify>
  <done>
Game HUD text fits within bar width with word wrapping. Grid positioned in upper portion for thumb accessibility. Overlay panels clamped to safe width. LevelSelect parallax covers full 1024x1820 viewport. All 10 level nodes accessible via vertical scroll.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Cross-viewport visual verification</name>
  <files>src/scenes/Game.ts, src/scenes/LevelSelect.ts, src/scenes/Menu.ts</files>
  <action>
This is a human verification checkpoint. Claude starts the dev server, then the user verifies the responsive layout across target viewports.

What was built: Complete responsive layout system with Scale.FIT at 1024x1820 design resolution, safe-area CSS, adapted scene layouts for Menu, LevelSelect, and Game scenes, dark letterboxing on non-matching aspect ratios.

How to verify -- start the dev server:
```bash
cd /Users/vasiliyhrebenuyk/work/KLO/klo-match-3 && npx vite --host
```

Open Chrome DevTools (F12), toggle device toolbar (Ctrl+Shift+M), and test each viewport:

**1. iPhone SE (375x667) -- RESP-04 target:**
- [ ] Menu: Title "KLO Match-3" and Play button visible, centered
- [ ] LevelSelect: HUD bar with title visible at top
- [ ] LevelSelect: Economy HUD (hearts, bonuses) visible and not cropped
- [ ] LevelSelect: All 10 level checkpoints accessible by scrolling
- [ ] LevelSelect: Road path and Kyiv landmarks visible
- [ ] Game: HUD bar with level info visible at top
- [ ] Game: Full 8x8 grid visible with all edge cells tappable
- [ ] Game: Win/lose overlay panels fully visible when triggered

**2. Android ~360x740 -- RESP-04 target:**
- [ ] Same checks as iPhone SE
- [ ] Game board edge cells accessible (left column and right column)
- [ ] HUD text readable (not too small)

**3. iPhone 14 Pro (393x852) -- RESP-04 target:**
- [ ] Same checks as above
- [ ] Safe area: game canvas does not render behind notch area
- [ ] Minimal letterboxing (aspect ratio close to 9:16)

**4. Desktop (1920x1080) -- bonus check:**
- [ ] Game centered with dark (#1A1A1A) letterboxing on sides
- [ ] All scenes fully functional
- [ ] No layout breaks

**5. Device rotation (landscape):**
- [ ] Game remains visible (will be letterboxed heavily in landscape)
- [ ] No console errors on rotation
- [ ] Layout does not break

Resume signal: Type "approved" if all checks pass, or describe issues to fix.
  </action>
  <verify>User visually confirms all checklist items pass on all test viewports.</verify>
  <done>Human has verified responsive layout on iPhone SE (375x667), Android 360x740, iPhone 14 Pro (393x852), and desktop (1920x1080). All scenes render correctly with no overflow, overlap, or cropping.</done>
</task>

</tasks>

<verification>
Phase 12 complete when all success criteria are TRUE:
1. Level Select scene shows complete road, checkpoints, and CTA buttons on iPhone SE (375x667) -- verified by human
2. Game Board fully visible with all edge cells accessible on Android 360x740 screens -- verified by human
3. HUD elements never overlap grid or crop level goals on any test device -- verified by human
4. Game scales smoothly when device rotated or browser resized (no layout breaks) -- verified by human
</verification>

<success_criteria>
- Scale.FIT mode active with consistent 1024x1820 game coordinate space
- Safe-area CSS prevents content hidden behind iOS notch
- Game grid fully visible and playable on all test viewports
- LevelSelect road/nodes/HUD accessible on smallest test viewport (iPhone SE)
- HUD never overlaps grid; overlay panels fit within viewport
- Human has verified on all 4 target viewports (iPhone SE, Android 360x740, iPhone 14 Pro, desktop)
</success_criteria>

<output>
After completion, create `.planning/phases/12-responsive-layout-foundation/12-02-SUMMARY.md`
</output>
