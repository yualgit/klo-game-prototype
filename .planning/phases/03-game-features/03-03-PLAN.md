---
phase: 03-game-features
plan: 03
type: tdd
wave: 1
depends_on: ["03-01"]
files_modified:
  - src/game/BoosterActivator.ts
  - src/game/BoosterActivator.test.ts
autonomous: true

must_haves:
  truths:
    - "Linear horizontal booster clears entire row"
    - "Linear vertical booster clears entire column"
    - "Bomb booster clears 3x3 area around it"
    - "KLO-sphere clears all tiles of a chosen type"
    - "Two linear boosters swapped together clear cross (row + column)"
    - "Two bombs swapped together clear 5x5 area"
    - "KLO-sphere + any booster converts all tiles of target color to that booster type then removes"
    - "Two KLO-spheres clear entire board"
  artifacts:
    - path: "src/game/BoosterActivator.ts"
      provides: "Booster activation and combo logic"
      exports: ["BoosterActivator"]
    - path: "src/game/BoosterActivator.test.ts"
      provides: "Tests for booster activation"
      contains: "BoosterActivator"
  key_links:
    - from: "src/game/BoosterActivator.ts"
      to: "src/game/Match3Engine.ts"
      via: "uses getTilesInRow, getTilesInColumn, getTilesInRadius, getTilesByType"
      pattern: "engine\\.getTiles"
---

<objective>
Implement booster activation and combo system using TDD. Each booster type has a distinct activation effect, and swapping two boosters creates combo effects.

Purpose: Boosters are the strategic element of match-3 gameplay. The activation system must handle both individual booster effects and the booster-booster combo matrix (BOOST-01 through BOOST-05).
Output: BoosterActivator class with individual activation + combo lookup table, fully tested.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-game-features/03-RESEARCH.md
@.planning/phases/03-game-features/03-01-SUMMARY.md
@src/game/types.ts
@src/game/Match3Engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD individual booster activation</name>
  <files>src/game/BoosterActivator.ts, src/game/BoosterActivator.test.ts</files>
  <action>
RED phase: Create src/game/BoosterActivator.test.ts with tests:

1. Test "linear_horizontal clears entire row":
   - Create 8x8 engine with grid, place linear_horizontal booster at (3,3)
   - Call activateBooster(tile)
   - Assert returned tilesToRemove contains all 8 tiles in row 3

2. Test "linear_vertical clears entire column":
   - Place linear_vertical at (3,3)
   - Assert returns all 8 tiles in col 3

3. Test "bomb clears 3x3 area":
   - Place bomb at (4,4)
   - Assert returns 9 tiles (3x3 centered at 4,4)

4. Test "bomb near edge clears only valid tiles":
   - Place bomb at (0,0)
   - Assert returns 4 tiles (2x2 in corner), no out-of-bounds

5. Test "klo_sphere clears all tiles of same type":
   - Fill grid with mix of types, place klo_sphere with baseType 'fuel' at (3,3)
   - Assert returns all tiles of type 'fuel'

Run tests -- should FAIL.

GREEN phase: Create src/game/BoosterActivator.ts:

```typescript
export class BoosterActivator {
  constructor(private engine: Match3Engine) {}

  activateBooster(booster: TileData): TileData[] {
    switch (booster.booster) {
      case 'linear_horizontal':
        return this.engine.getTilesInRow(booster.row);
      case 'linear_vertical':
        return this.engine.getTilesInColumn(booster.col);
      case 'bomb':
        return this.engine.getTilesInRadius(booster.row, booster.col, 1);
      case 'klo_sphere':
        return this.engine.getTilesByType(booster.type);
      default:
        return [];
    }
  }
}
```

Run tests -- should PASS.
  </action>
  <verify>Run `npx jest src/game/BoosterActivator.test.ts` -- individual activation tests pass.</verify>
  <done>Individual booster activation works for all 4 types with correct tile targeting.</done>
</task>

<task type="auto">
  <name>Task 2: TDD booster combo system</name>
  <files>src/game/BoosterActivator.ts, src/game/BoosterActivator.test.ts</files>
  <action>
RED phase: Add combo tests to BoosterActivator.test.ts in `describe('Booster Combos')`:

1. Test "two linear boosters create rocket effect (cross clear)":
   - Call activateBoosterCombo(linear_h at (3,3), linear_v at (3,4))
   - Assert returns tiles from row 3 AND column 3 (cross pattern)

2. Test "two bombs create mega bomb (5x5)":
   - Call activateBoosterCombo(bomb at (4,4), bomb at (4,5))
   - Assert returns tiles in 5x5 area centered at (4,4)

3. Test "linear + bomb clears 3 rows or columns":
   - Call activateBoosterCombo(linear_h at (3,3), bomb at (3,4))
   - Assert returns tiles from rows 2, 3, 4

4. Test "klo_sphere + linear converts all same-type to linear":
   - Call activateBoosterCombo(klo_sphere at (3,3), linear_h at (3,4))
   - Assert returns all tiles matching the linear booster's type

5. Test "two klo_spheres clear entire board":
   - Call activateBoosterCombo(klo_sphere at (3,3), klo_sphere at (3,4))
   - Assert returns all non-empty tiles on board

6. Test "no combo just activates both":
   - If not in lookup table, activate each booster individually
   - Deduplicate returned tiles

Run tests -- should FAIL.

GREEN phase: Add to BoosterActivator:

1. Define BOOSTER_COMBO_TABLE as a const Record mapping sorted combo keys to effect names:
   - 'linear_horizontal+linear_horizontal' -> 'rocket'
   - 'linear_horizontal+linear_vertical' -> 'rocket'
   - 'linear_vertical+linear_vertical' -> 'rocket'
   - 'bomb+bomb' -> 'mega_bomb'
   - 'bomb+linear_horizontal' -> 'triple_line_horizontal'
   - 'bomb+linear_vertical' -> 'triple_line_vertical'
   - 'klo_sphere+*' -> 'convert_and_remove'
   - 'klo_sphere+klo_sphere' -> 'clear_all'

2. `activateBoosterCombo(b1: TileData, b2: TileData): TileData[]`:
   - Check if both are klo_sphere -> clear entire board
   - Check if one is klo_sphere -> get all tiles of other booster's type, return them
   - Otherwise look up combo in table and execute effect:
     - 'rocket': getTilesInRow(b1.row) + getTilesInColumn(b1.col)
     - 'mega_bomb': getTilesInRadius(b1.row, b1.col, 2) (5x5)
     - 'triple_line_horizontal': getTilesInRow(b1.row-1) + getTilesInRow(b1.row) + getTilesInRow(b1.row+1)
     - 'triple_line_vertical': getTilesInColumn(b1.col-1) + getTilesInColumn(b1.col) + getTilesInColumn(b1.col+1)
   - Default: activate both individually, deduplicate by tile id

3. Helper `getComboKey(type1, type2): string` -- sort alphabetically and join with '+'

Run tests -- should PASS.
  </action>
  <verify>Run `npx jest src/game/BoosterActivator.test.ts` -- all tests pass.</verify>
  <done>All booster combos work: linear+linear=rocket, bomb+bomb=mega, linear+bomb=triple, klo_sphere combos, and fallback.</done>
</task>

</tasks>

<verification>
1. `npx jest src/game/BoosterActivator.test.ts` -- all tests pass
2. `npx tsc --noEmit` -- no type errors
3. Individual activation for all 4 booster types returns correct tile sets
4. Combo activation follows lookup table with correct effects
</verification>

<success_criteria>
- All 4 individual booster effects tested and working
- Booster combo matrix covers all required combinations (BOOST-05)
- Edge cases handled (boosters near board edges, deduplication)
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-features/03-03-SUMMARY.md`
</output>
