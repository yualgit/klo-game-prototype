---
phase: 07-settings
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/scenes/LevelSelect.ts
autonomous: true

must_haves:
  truths:
    - "User sees gear icon in top area of level select screen"
    - "User taps gear icon and sees settings overlay with dark backdrop"
    - "User can toggle SFX on/off and sees toggle state change visually"
    - "User can drag volume slider thumb and volume updates in real-time"
    - "User can toggle booster animations on/off"
    - "User taps close button and overlay is fully destroyed (no duplicates on reopen)"
    - "Settings changes persist: close app, reopen, settings overlay shows saved values"
  artifacts:
    - path: "src/scenes/LevelSelect.ts"
      provides: "Gear icon button + settings overlay modal with toggle and slider controls"
      contains: "showSettingsOverlay"
  key_links:
    - from: "src/scenes/LevelSelect.ts"
      to: "src/game/SettingsManager.ts"
      via: "registry.get('settings') for reading/writing settings"
      pattern: "settings\\.set\\("
---

<objective>
Add settings gear icon to the LevelSelect scene and implement a modal overlay with SFX toggle, volume slider, and booster animation toggle.

Purpose: Give users a visible, accessible way to customize audio and visual preferences directly from the level select screen.

Output: Gear icon in LevelSelect, modal overlay with 3 settings controls (SFX toggle, volume slider, animation toggle), close button, full cleanup on close.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-settings/07-RESEARCH.md
@.planning/phases/07-settings/07-01-SUMMARY.md
@src/scenes/LevelSelect.ts
@src/game/SettingsManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gear icon and settings overlay to LevelSelect</name>
  <files>src/scenes/LevelSelect.ts</files>
  <action>
Add the following to LevelSelect scene. Import SettingsManager at top of file.

**1. Gear icon button in `create()` method:**

After the `this.createEconomyHUD(width, economy)` call, add:
```
this.createSettingsButton(width);
```

**2. `createSettingsButton(width: number)` private method:**

- Create a text element using gear unicode character or a simple "gear" label. Position in top area, left of the economy HUD (approximately x = width - 200, y = 30) to avoid overlap with both the back button (left) and economy HUD (right). Adjust position as needed for visual balance.
- Style: fontFamily 'Arial, sans-serif', fontSize '28px', color '#1A1A1A'.
- Set origin to 0.5, make interactive with useHandCursor.
- Add pointerover: tween scale to 1.15, duration 100.
- Add pointerout: tween scale to 1, duration 100.
- Add pointerup: call `this.showSettingsOverlay()`.

**3. `showSettingsOverlay()` private method:**

Create an overlay modal. Store ALL created game objects in a local `overlayElements: Phaser.GameObjects.GameObject[]` array for cleanup.

a) **Dark backdrop:** Graphics filled 0x000000, alpha 0.7, covering full camera width/height. Make interactive (blocks clicks to elements behind). Also add pointerup handler on backdrop to close overlay (same as close button).

b) **White panel:** Graphics with fillStyle(0xF9F9F9, 1), fillRoundedRect centered on screen. Panel dimensions: ~340 wide, ~380 tall. Position centered.

c) **Title text:** "Налаштування" centered at top of panel, bold, fontSize 28px, color '#1A1A1A'.

d) **SFX toggle row (y offset ~100 from panel top):**
- Label "Звукові ефекти" on the left side
- Toggle switch on the right side: a rounded rectangle background (60x30) colored green (0x4CAF50) when on, gray (0xCCCCCC) when off
- White circle thumb (radius 12) positioned left when off, right when on
- Track current state from `settings.get('sfxEnabled')`
- On pointerup: flip state, call `settings.set('sfxEnabled', newState)`, animate thumb position with tween (200ms Cubic.Out), change background fill color
- Use a local `let isEnabled = settings.get('sfxEnabled')` to track toggle state across clicks (the research pattern has a bug where `initialState` never changes - fix this by using a mutable local variable)

e) **Volume slider row (y offset ~170 from panel top):**
- Label "Гучність" on left
- Slider track: rectangle (140 wide, 6 tall, fill 0xDDDDDD)
- Slider fill: rectangle showing filled portion (fill 0xFFB800)
- Slider thumb: circle (radius 10, fill white, stroke 0xFFB800 width 2)
- Initial thumb position from `settings.get('sfxVolume')`
- Make thumb interactive + draggable. On drag: clamp x to track bounds, update fill width, call `settings.set('sfxVolume', value)` where value = (thumbX - minX) / trackWidth
- Use `this.input.setDraggable(thumb)` for drag support

f) **Animation toggle row (y offset ~240 from panel top):**
- Same toggle pattern as SFX toggle
- Label "Анімації бустерів"
- Initial state from `settings.get('animationsEnabled')`
- On toggle: call `settings.set('animationsEnabled', newState)`

g) **Close button (y offset ~320 from panel top):**
- Use existing `createOverlayButton()` method with secondary=true style
- Label "Закрити"
- On click: `overlayElements.forEach(el => el.destroy())`

**Important implementation notes:**
- Every game object created in this method must be pushed to `overlayElements` array
- The backdrop setInteractive must use a rectangle geometry matching camera dimensions for click blocking
- Toggle state must use a mutable local variable (let), not the initial value, to support multiple toggles without reopening
- Volume slider drag must use Phaser.Math.Clamp for bounds enforcement
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Run `npx vite build` to verify production build succeeds. Manually verify: gear icon visible in LevelSelect, overlay opens on click, all controls functional, overlay fully destroyed on close (no duplicate elements on reopen).
  </verify>
  <done>
Gear icon visible in LevelSelect top area. Clicking it opens a settings overlay with SFX toggle, volume slider, and animation toggle. All controls read from and write to SettingsManager. Close button destroys all overlay elements cleanly. Reopening overlay shows current settings state (not stale defaults).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx vite build` succeeds
3. Gear icon visible in LevelSelect scene (not overlapping back button or economy HUD)
4. Tapping gear opens overlay with dark backdrop and white panel
5. SFX toggle switches between on/off with visual feedback
6. Volume slider thumb drags smoothly within track bounds
7. Animation toggle switches between on/off with visual feedback
8. Closing overlay destroys all elements (no visual artifacts on reopen)
9. Settings changes persist across scene transitions (leave LevelSelect, return, reopen settings - values maintained)
10. Settings changes persist across browser refresh (SETT-04)
</verification>

<success_criteria>
- SETT-01: Gear icon on level select opens settings overlay
- SETT-02: SFX toggle and volume slider control audio playback
- SETT-03: Animation toggle disables VFX in subsequent gameplay
- SETT-04: All settings persist via localStorage across sessions
- No visual overlap with existing HUD elements
- Clean overlay lifecycle (no memory leaks or duplicate elements)
</success_criteria>

<output>
After completion, create `.planning/phases/07-settings/07-02-SUMMARY.md`
</output>
