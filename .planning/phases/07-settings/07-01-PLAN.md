---
phase: 07-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/SettingsManager.ts
  - src/main.ts
  - src/game/AudioManager.ts
  - src/game/VFXManager.ts
autonomous: true

must_haves:
  truths:
    - "Settings default to sfxEnabled=true, sfxVolume=0.5, animationsEnabled=true on first launch"
    - "Changing a setting value via SettingsManager persists it to localStorage"
    - "AudioManager respects sfxEnabled and sfxVolume settings when playing sounds"
    - "VFXManager skips all particle/visual effects when animationsEnabled is false"
    - "Settings loaded from localStorage on app startup override defaults"
  artifacts:
    - path: "src/game/SettingsManager.ts"
      provides: "Reactive settings manager with localStorage persistence and subscription pattern"
      exports: ["SettingsManager", "SettingsData"]
    - path: "src/main.ts"
      provides: "SettingsManager initialization and registry storage"
      contains: "registry.set('settings'"
    - path: "src/game/AudioManager.ts"
      provides: "Settings-aware sound playback (mute/volume from settings)"
      contains: "settings.subscribe"
    - path: "src/game/VFXManager.ts"
      provides: "Settings-aware VFX (skip effects when disabled)"
      contains: "animationsEnabled"
  key_links:
    - from: "src/main.ts"
      to: "src/game/SettingsManager.ts"
      via: "SettingsManager.load() + new SettingsManager(data)"
      pattern: "SettingsManager\\.load\\(\\)"
    - from: "src/game/AudioManager.ts"
      to: "src/game/SettingsManager.ts"
      via: "registry.get('settings') subscription"
      pattern: "settings\\.subscribe.*sfxEnabled"
    - from: "src/game/VFXManager.ts"
      to: "src/game/SettingsManager.ts"
      via: "registry.get('settings') subscription"
      pattern: "settings\\.subscribe.*animationsEnabled"
---

<objective>
Create SettingsManager with localStorage persistence, wire it into app startup, and integrate with AudioManager and VFXManager via reactive subscriptions.

Purpose: Establish the settings data layer so AudioManager mutes/adjusts volume and VFXManager skips effects based on user preferences. This is the foundation for the settings UI overlay (Plan 07-02).

Output: SettingsManager singleton in registry, AudioManager reacting to sfxEnabled/sfxVolume, VFXManager reacting to animationsEnabled.
</objective>

<execution_context>
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vasiliyhrebenuyk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-settings/07-RESEARCH.md
@src/game/AudioManager.ts
@src/game/VFXManager.ts
@src/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsManager and wire into app startup</name>
  <files>src/game/SettingsManager.ts, src/main.ts</files>
  <action>
Create `src/game/SettingsManager.ts` with the following:

1. **SettingsData interface** with fields:
   - `sfxEnabled: boolean` (default: true)
   - `sfxVolume: number` (0.0-1.0, default: 0.5)
   - `animationsEnabled: boolean` (default: true)
   - `version: number` (default: 1, for future schema migrations)

2. **SettingsManager class** with:
   - Private `data: SettingsData` field
   - Private `listeners: Map<keyof SettingsData, Set<(value: any) => void>>` for subscriptions
   - `static readonly STORAGE_KEY = 'klo_match3_settings'`
   - Constructor accepting optional `SettingsData` (falls back to defaults)
   - `get<K>(key: K): SettingsData[K]` - typed getter
   - `set<K>(key: K, value: SettingsData[K]): void` - typed setter that calls save() then notify()
   - `subscribe<K>(key: K, callback): void` - register listener for key changes. Do NOT fire callback on subscribe (only on change via set()).
   - Private `notify<K>(key, value)` - iterate listeners for key
   - Private `save()` - JSON.stringify to localStorage, wrapped in try-catch (warn on failure, don't throw)
   - `static load(): SettingsData` - parse from localStorage, version migration logic, try-catch with defaults fallback

3. **Wire into main.ts** after EconomyManager initialization:
   - Import SettingsManager
   - Call `SettingsManager.load()` to get persisted data
   - Create `new SettingsManager(settingsData)`
   - Store in registry: `game.registry.set('settings', settingsManager)`
   - Add console log: `[Main] SettingsManager initialized`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation passes. Check that SettingsManager.ts exports SettingsData interface and SettingsManager class.
  </verify>
  <done>
SettingsManager exists with get/set/subscribe/save/load methods. App startup creates SettingsManager, loads from localStorage (or defaults), and stores in Phaser registry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate settings subscriptions into AudioManager and VFXManager</name>
  <files>src/game/AudioManager.ts, src/game/VFXManager.ts</files>
  <action>
**AudioManager modifications (src/game/AudioManager.ts):**

1. Import SettingsManager at top of file.
2. In constructor, after setting `this.scene`, add settings integration:
   - Get settings from `scene.registry.get('settings') as SettingsManager`
   - If settings exists:
     - Set `this.muted = !settings.get('sfxEnabled')` (initial state)
     - Set `this.volume = settings.get('sfxVolume')` (initial state)
     - Subscribe to `'sfxEnabled'`: callback sets `this.muted = !enabled`
     - Subscribe to `'sfxVolume'`: callback sets `this.volume = vol`
   - If settings does not exist (defensive): keep existing defaults (muted=false, volume=0.5)

**VFXManager modifications (src/game/VFXManager.ts):**

1. Import SettingsManager at top of file.
2. Add private field: `private animationsEnabled: boolean = true;`
3. In constructor, after `this.createParticleTextures()`, add settings integration:
   - Get settings from `scene.registry.get('settings') as SettingsManager`
   - If settings exists:
     - Set `this.animationsEnabled = settings.get('animationsEnabled')` (initial state)
     - Subscribe to `'animationsEnabled'`: callback sets `this.animationsEnabled = enabled`
   - If settings does not exist (defensive): keep `animationsEnabled = true`
4. Add early return guard `if (!this.animationsEnabled) return;` as the FIRST line in ALL public VFX methods:
   - `matchPop()` - add before `if (!this.active)` check
   - `boosterLineSweep()` - add before `if (!this.active)` check
   - `boosterBombExplosion()` - add before `if (!this.active)` check
   - `boosterSphereWave()` - add before `if (!this.active)` check
   - `confettiBurst()` - add before `if (!this.active)` check
   - `cascadeCombo()` - add before `if (!this.active)` check

Do NOT add animation guards to `createParticleTextures()` (it's infrastructure, always needed).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Verify AudioManager constructor references settings registry. Verify all 6 VFX methods have the `animationsEnabled` guard.
  </verify>
  <done>
AudioManager reads sfxEnabled/sfxVolume from settings and subscribes to changes. VFXManager reads animationsEnabled from settings and all 6 effect methods skip when disabled.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/game/SettingsManager.ts` exports `SettingsManager` class and `SettingsData` interface
3. `src/main.ts` creates SettingsManager and stores in registry
4. `src/game/AudioManager.ts` subscribes to sfxEnabled and sfxVolume
5. `src/game/VFXManager.ts` has animationsEnabled guard in all 6 public methods
6. `npx vite build` succeeds (production build)
</verification>

<success_criteria>
- SettingsManager loads/saves to localStorage with try-catch safety
- AudioManager mutes when sfxEnabled=false, adjusts volume from sfxVolume
- VFXManager skips all effects when animationsEnabled=false
- All changes are reactive (take effect immediately when set() is called)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-settings/07-01-SUMMARY.md`
</output>
